<!DOCTYPE html>
<html>
<head>
    <title>üéØ FINAL Purchase History Fix Verification</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .button-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }
        .button-primary {
            background: linear-gradient(45deg, #2196f3, #1976d2);
        }
        .results {
            background: #000;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        .success-message {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }
        .user-info {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .step {
            background: #f5f5f5;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ FINAL Purchase History Fix Verification</h1>
            <p>The ultimate solution for empty purchase history in buyer dashboard</p>
        </div>

        <div class="step">
            <h3>üîß What was fixed:</h3>
            <p><strong>Problem:</strong> Frontend was using <code>user.id</code> but should use <code>user.userId</code></p>
            <p><strong>Solution:</strong> Updated Purchases.tsx to use the correct field that matches database</p>
            <p><strong>Status:</strong> ‚úÖ Code fix applied to frontend component</p>
        </div>

        <div class="user-info" id="userDisplay">
            <h3>üë§ Current User Detection</h3>
            <div id="userInfo">Detecting user data...</div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="button button-primary" onclick="testPurchaseAPI()">
                üß™ TEST PURCHASE API
            </button>
            <button class="button button-success" onclick="openDashboard()">
                üñ•Ô∏è OPEN BUYER DASHBOARD
            </button>
        </div>

        <div id="results" class="results">
üéØ FINAL Purchase History Fix Verification

üîç This will verify:
1. User data is properly detected (both id and userId)
2. Purchase history API works with correct userId
3. SOLD items are properly linked
4. Dashboard should now show purchases

üí° Click "TEST PURCHASE API" to verify the fix!
        </div>
    </div>

    <script>
        let currentUser = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('results');
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            resultDiv.textContent += `[${timestamp}] ${icon} ${message}\\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function detectUser() {
            try {
                // Try to get user data from localStorage
                const userData = localStorage.getItem('userData');
                if (userData) {
                    currentUser = JSON.parse(userData);
                    
                    const userDisplayInfo = `
                        <strong>Name:</strong> ${currentUser.firstName} ${currentUser.lastName}<br>
                        <strong>Email:</strong> ${currentUser.email}<br>
                        <strong>ID:</strong> ${currentUser.id || 'Not found'}<br>
                        <strong>User ID:</strong> ${currentUser.userId || 'Not found'}<br>
                        <strong>Role:</strong> ${currentUser.role}<br>
                        <strong>Correct Field:</strong> ${currentUser.userId || currentUser.id}
                    `;
                    
                    document.getElementById('userInfo').innerHTML = userDisplayInfo;
                    
                    log(`‚úÖ User detected: ${currentUser.firstName} ${currentUser.lastName}`, 'success');
                    log(`‚ÑπÔ∏è ID field: ${currentUser.id || 'None'}`, 'info');
                    log(`‚ÑπÔ∏è UserID field: ${currentUser.userId || 'None'}`, 'info');
                    log(`üéØ Using for API: ${currentUser.userId || currentUser.id}`, 'success');
                    
                    return true;
                } else {
                    document.getElementById('userInfo').innerHTML = `
                        <span style="color: #f44336;">‚ùå No user data found in localStorage</span><br>
                        <small>Please ensure you are logged in to the application</small>
                    `;
                    log('‚ùå No user data found. Please login first.', 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Error detecting user: ${error.message}`, 'error');
                return false;
            }
        }

        async function testPurchaseAPI() {
            log('üß™ Starting comprehensive purchase API test...', 'info');
            
            // Step 1: Detect user
            const userDetected = detectUser();
            if (!userDetected) {
                log('‚ùå Cannot proceed without user data', 'error');
                return;
            }

            // Step 2: Determine correct user ID
            const userId = currentUser.userId || currentUser.id;
            if (!userId) {
                log('‚ùå No valid user ID found in user data', 'error');
                return;
            }

            log(`üîç Testing with User ID: ${userId}`, 'info');

            // Step 3: Test Purchase History API
            try {
                log('üì° Calling purchase history API...', 'info');
                
                const response = await fetch(`http://localhost:9092/api/bidding/purchase-history/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                log(`üì° API Response Status: ${response.status}`, response.ok ? 'success' : 'error');

                if (response.ok) {
                    const result = await response.json();
                    log(`üìã API Response received`, 'success');
                    
                    if (result.success) {
                        const purchases = result.data || [];
                        log(`üéâ SUCCESS! Found ${purchases.length} purchase(s)!`, 'success');
                        
                        if (purchases.length > 0) {
                            log('üõçÔ∏è Purchase Details:', 'success');
                            purchases.forEach((purchase, index) => {
                                log(`  ${index + 1}. ${purchase.gemName}`, 'success');
                                log(`     üí∞ Price: LKR ${purchase.finalPrice?.toLocaleString()}`, 'success');
                                log(`     üìÖ Date: ${new Date(purchase.purchaseDate).toLocaleDateString()}`, 'success');
                                log(`     üÜî Item ID: ${purchase.id}`, 'info');
                            });
                            
                            // Show success message
                            showSuccessMessage(purchases.length);
                            
                        } else {
                            log('‚ö†Ô∏è API works but returns 0 purchases', 'warning');
                            log('üí° This means SOLD items may need to be linked to this user', 'warning');
                            
                            // Check if there are SOLD items in marketplace
                            await checkForSoldItems(userId);
                        }
                    } else {
                        log(`‚ùå API returned error: ${result.message}`, 'error');
                    }
                } else {
                    log(`‚ùå API call failed: ${response.status} ${response.statusText}`, 'error');
                    log('üí° Make sure the backend is running on port 9092', 'warning');
                }
                
            } catch (error) {
                log(`‚ùå Network error: ${error.message}`, 'error');
                log('üí° Check if backend server is running', 'warning');
            }
        }

        async function checkForSoldItems(userId) {
            log('üîç Checking marketplace for SOLD items that could be linked...', 'info');
            
            try {
                const response = await fetch('http://localhost:9092/api/marketplace/listings?page=0&size=100');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data && result.data.listings) {
                        const soldItems = result.data.listings.filter(item => item.listingStatus === 'sold');
                        
                        log(`üìä Found ${soldItems.length} SOLD items in marketplace`, 'info');
                        
                        if (soldItems.length > 0) {
                            log('üí° These items could be linked to your account:', 'info');
                            soldItems.forEach((item, index) => {
                                log(`  ${index + 1}. ${item.gemName} - LKR ${item.finalPrice || item.price}`, 'warning');
                            });
                            log('üîß Use the INSTANT_DASHBOARD_FIX.html tool to link them', 'warning');
                        }
                    }
                }
            } catch (error) {
                log(`‚ö†Ô∏è Could not check marketplace: ${error.message}`, 'warning');
            }
        }

        function showSuccessMessage(count) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.innerHTML = `
                üéâ PURCHASE HISTORY IS WORKING! üéâ<br><br>
                ‚úÖ ${count} purchase${count !== 1 ? 's' : ''} found via API<br>
                ‚úÖ Frontend code fix applied<br>
                ‚úÖ User ID field corrected<br><br>
                <strong>Your buyer dashboard should now show these purchases!</strong><br><br>
                <button class="button" onclick="openDashboard()">
                    üñ•Ô∏è Open Dashboard Now
                </button>
            `;
            document.querySelector('.container').appendChild(successDiv);
        }

        function openDashboard() {
            const dashboardUrl = 'http://localhost:5173/buyer/dashboard';
            window.open(dashboardUrl, '_blank');
            log('üñ•Ô∏è Opening buyer dashboard in new tab...', 'info');
            log('üëÄ Navigate to Purchases section in the sidebar to see your items!', 'warning');
            log('üîÑ If items do not appear immediately, try refreshing the dashboard page', 'info');
        }

        // Auto-detect user on page load
        window.addEventListener('load', () => {
            detectUser();
            log('üöÄ Page loaded. Ready to verify purchase history fix!', 'info');
        });
    </script>
</body>
</html>

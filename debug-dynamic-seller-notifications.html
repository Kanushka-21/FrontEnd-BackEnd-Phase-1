<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug: Dynamic Seller Notification Issue</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc2626;
            text-align: center;
            margin-bottom: 30px;
        }
        .issue-description {
            background: #fef2f2;
            border: 2px solid #dc2626;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .debug-info {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        button {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #b91c1c;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .info {
            background-color: #e0f2fe;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
        }
        .warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug: Dynamic Seller Notification Issue</h1>
        
        <div class="issue-description">
            <h3>üö® Current Issue</h3>
            <p><strong>Problem:</strong> Dinushi Hansani (seller account) is not receiving any notifications when buyers place bids on their items.</p>
            <p><strong>Root Cause:</strong> Notifications are not being created dynamically based on the actual seller's user ID from the database.</p>
            <p><strong>Requirements:</strong></p>
            <ul>
                <li>‚úÖ Get seller information dynamically from database (not hardcoded)</li>
                <li>‚úÖ Create notifications for the correct seller when bids are placed</li>
                <li>‚úÖ Ensure seller dashboard shows updated notifications in real-time</li>
            </ul>
        </div>

        <!-- Test Section 1: Find Dinushi Hansani's User Info -->
        <div class="test-section">
            <h3>1. üë§ Find Dinushi Hansani's User Information</h3>
            <p>Let's find the actual user ID for Dinushi Hansani seller account:</p>
            <button onclick="findSellerUserInfo()">Find Seller User Info</button>
            <div id="sellerUserResult" class="result"></div>
        </div>

        <!-- Test Section 2: Check Seller's Listings -->
        <div class="test-section">
            <h3>2. üì¶ Check Seller's Gem Listings</h3>
            <p>Find all gem listings created by this seller:</p>
            <div>
                <label>Seller ID: <input type="text" id="sellerIdInput" value="" style="width: 300px; padding: 5px;" placeholder="Will be populated after finding user"></label>
            </div>
            <button onclick="checkSellerListings()">Check Seller's Listings</button>
            <div id="sellerListingsResult" class="result"></div>
        </div>

        <!-- Test Section 3: Check Bids on Seller's Items -->
        <div class="test-section">
            <h3>3. üéØ Check Bids on Seller's Items</h3>
            <p>Check if there are any bids placed on the seller's listings:</p>
            <button onclick="checkBidsOnSellerItems()">Check Bids on Seller Items</button>
            <div id="bidsResult" class="result"></div>
        </div>

        <!-- Test Section 4: Test Notification Creation -->
        <div class="test-section">
            <h3>4. üîî Test Notification Creation Process</h3>
            <p>Simulate a bid to test if notifications are created correctly:</p>
            <button onclick="testNotificationCreation()">Test Notification Creation</button>
            <div id="notificationTestResult" class="result"></div>
        </div>

        <!-- Test Section 5: Check Current Notifications -->
        <div class="test-section">
            <h3>5. üìä Check Current Notification Status</h3>
            <p>Check all notifications in the system and filter for the seller:</p>
            <button onclick="checkCurrentNotifications()">Check Current Notifications</button>
            <div id="currentNotificationResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:9092/api';
        let sellerUserId = '';
        let sellerListings = [];

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }

        async function findSellerUserInfo() {
            let message = '<h4>üë§ Searching for Dinushi Hansani User Information:</h4>';
            
            try {
                // We need to find users that match Dinushi Hansani
                // Since we don't have a user search endpoint, let's try some approaches
                
                message += '<div class="debug-info">';
                message += '<strong>Search Strategy:</strong><br>';
                message += '1. The user ID 675c45b7036fefc08e8c4b7a might be Dinushi Hansani<br>';
                message += '2. Let\'s check if this user has any gem listings<br>';
                message += '3. We\'ll look for patterns in the database<br>';
                message += '</div>';
                
                // Test the known user ID first
                const testUserId = '675c45b7036fefc08e8c4b7a';
                document.getElementById('sellerIdInput').value = testUserId;
                sellerUserId = testUserId;
                
                message += '<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border: 1px solid #16a34a;">';
                message += '<strong>‚úÖ Using User ID:</strong> ' + testUserId + '<br>';
                message += 'This appears to be the seller account based on previous testing.<br>';
                message += 'Next step: Check their gem listings to confirm this is Dinushi Hansani.';
                message += '</div>';
                
                showResult('sellerUserResult', message, 'success');
                
            } catch (error) {
                showResult('sellerUserResult', `‚ùå Error finding seller info: ${error.message}`, 'error');
            }
        }

        async function checkSellerListings() {
            const sellerId = document.getElementById('sellerIdInput').value.trim();
            
            if (!sellerId) {
                showResult('sellerListingsResult', '‚ùå Please enter a seller ID', 'error');
                return;
            }

            let message = `<h4>üì¶ Checking Gem Listings for Seller: ${sellerId}</h4>`;
            
            try {
                // Check if there's an endpoint to get listings by user
                const response = await fetch(`${API_BASE_URL}/listings/user/${sellerId}`);
                
                if (response.ok) {
                    const result = await response.json();
                    sellerListings = result.data || result;
                    
                    message += '<div class="debug-info">';
                    message += `<strong>Found ${sellerListings.length} listings for this seller:</strong><br>`;
                    
                    if (sellerListings.length > 0) {
                        sellerListings.forEach((listing, index) => {
                            message += `${index + 1}. ID: ${listing.id}<br>`;
                            message += `   Gem: ${listing.gemName || listing.name}<br>`;
                            message += `   Price: ${listing.price}<br>`;
                            message += `   Status: ${listing.status || 'Active'}<br><br>`;
                        });
                    } else {
                        message += 'No listings found for this user.<br>';
                    }
                    
                    message += '</div>';
                    
                    if (sellerListings.length > 0) {
                        message += '<div style="background: #d1fae5; padding: 15px; border-radius: 8px;">';
                        message += `‚úÖ Confirmed: This seller has ${sellerListings.length} gem listings in the system.`;
                        message += '</div>';
                        showResult('sellerListingsResult', message, 'success');
                    } else {
                        message += '<div style="background: #fef3c7; padding: 15px; border-radius: 8px;">';
                        message += '‚ö†Ô∏è This user has no gem listings. They might not be a seller or listings might be in a different collection.';
                        message += '</div>';
                        showResult('sellerListingsResult', message, 'warning');
                    }
                } else {
                    // Try alternative endpoint
                    const altResponse = await fetch(`${API_BASE_URL}/gem-listings/seller/${sellerId}`);
                    if (altResponse.ok) {
                        const result = await altResponse.json();
                        message += '<div class="debug-info">Used alternative endpoint: /gem-listings/seller/</div>';
                        // Process result...
                    } else {
                        message += '<div style="background: #fef2f2; padding: 15px; border-radius: 8px;">';
                        message += '‚ùå Could not find listings endpoint. Available endpoints might be different.';
                        message += '</div>';
                        showResult('sellerListingsResult', message, 'error');
                    }
                }
                
            } catch (error) {
                showResult('sellerListingsResult', `‚ùå Error checking listings: ${error.message}`, 'error');
            }
        }

        async function checkBidsOnSellerItems() {
            if (sellerListings.length === 0) {
                showResult('bidsResult', '‚ö†Ô∏è Please check seller listings first to find items to check bids for.', 'warning');
                return;
            }

            let message = '<h4>üéØ Checking Bids on Seller\'s Items:</h4>';
            
            try {
                let totalBids = 0;
                let bidsFound = [];
                
                message += '<div class="debug-info">';
                message += '<strong>Checking bids on each listing:</strong><br>';
                
                for (let listing of sellerListings) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/bidding/listing/${listing.id}/bids`);
                        
                        if (response.ok) {
                            const result = await response.json();
                            const bids = result.data || result;
                            
                            message += `Listing ${listing.id} (${listing.gemName}): ${bids.length} bids<br>`;
                            
                            if (bids.length > 0) {
                                totalBids += bids.length;
                                bidsFound.push({
                                    listingId: listing.id,
                                    gemName: listing.gemName,
                                    bids: bids
                                });
                                
                                bids.forEach((bid, index) => {
                                    message += `  ${index + 1}. Bidder: ${bid.bidderName} - Amount: ${bid.bidAmount}<br>`;
                                });
                            }
                        } else {
                            message += `Listing ${listing.id}: Could not fetch bids<br>`;
                        }
                    } catch (e) {
                        message += `Listing ${listing.id}: Error - ${e.message}<br>`;
                    }
                }
                
                message += '</div>';
                
                if (totalBids > 0) {
                    message += '<div style="background: #d1fae5; padding: 15px; border-radius: 8px;">';
                    message += `‚úÖ Found ${totalBids} total bids on seller's items!<br>`;
                    message += 'If notifications are not showing, there\'s a problem with notification creation.';
                    message += '</div>';
                    showResult('bidsResult', message, 'success');
                } else {
                    message += '<div style="background: #fef3c7; padding: 15px; border-radius: 8px;">';
                    message += '‚ö†Ô∏è No bids found on seller\'s items. This explains why there are no notifications.';
                    message += '</div>';
                    showResult('bidsResult', message, 'warning');
                }
                
            } catch (error) {
                showResult('bidsResult', `‚ùå Error checking bids: ${error.message}`, 'error');
            }
        }

        async function testNotificationCreation() {
            const sellerId = document.getElementById('sellerIdInput').value.trim();
            
            if (!sellerId) {
                showResult('notificationTestResult', '‚ùå Please enter a seller ID', 'error');
                return;
            }

            let message = '<h4>üîî Testing Notification Creation Process:</h4>';
            
            // This would require placing a test bid to see if notifications are created
            message += '<div class="debug-info">';
            message += '<strong>Notification Creation Test Plan:</strong><br>';
            message += '1. Create a test bid on one of the seller\'s items<br>';
            message += '2. Check if notification is created in database<br>';
            message += '3. Verify notification appears in seller dashboard<br>';
            message += '4. Test notification filtering by context<br>';
            message += '</div>';
            
            message += '<div style="background: #fef3c7; padding: 15px; border-radius: 8px;">';
            message += '<strong>‚ö†Ô∏è Manual Test Required:</strong><br>';
            message += 'To properly test notification creation, we need to:<br>';
            message += '1. Log in as a buyer account<br>';
            message += '2. Place a bid on Dinushi Hansani\'s gem listing<br>';
            message += '3. Then check if the seller receives the notification<br>';
            message += '4. If no notification appears, the issue is in the notification creation logic in BiddingService.java';
            message += '</div>';
            
            showResult('notificationTestResult', message, 'warning');
        }

        async function checkCurrentNotifications() {
            const sellerId = document.getElementById('sellerIdInput').value.trim();
            
            if (!sellerId) {
                showResult('currentNotificationResult', '‚ùå Please enter a seller ID', 'error');
                return;
            }

            let message = '<h4>üìä Current Notification Status:</h4>';
            
            try {
                // Check all notifications for the seller
                const allResponse = await fetch(`${API_BASE_URL}/bidding/notifications/${sellerId}?page=0&size=50`);
                const allResult = await allResponse.json();
                
                // Check seller-specific notifications
                const sellerResponse = await fetch(`${API_BASE_URL}/bidding/notifications/${sellerId}?context=seller&page=0&size=50`);
                const sellerResult = await sellerResponse.json();
                
                message += '<div class="debug-info">';
                message += '<strong>Notification Status:</strong><br>';
                message += `All notifications: ${allResult.data.notifications.length}<br>`;
                message += `Seller notifications: ${sellerResult.data.notifications.length}<br>`;
                message += `Unread count: ${allResult.data.unreadCount}<br>`;
                message += '</div>';
                
                if (allResult.data.notifications.length === 0) {
                    message += '<div style="background: #fef2f2; padding: 15px; border-radius: 8px;">';
                    message += '<strong>üö® ISSUE CONFIRMED:</strong><br>';
                    message += 'The seller has 0 notifications in the database. This indicates:<br>';
                    message += '1. Either no bids have been placed on their items, OR<br>';
                    message += '2. The notification creation logic is not working properly<br><br>';
                    message += '<strong>Solution:</strong><br>';
                    message += '‚Ä¢ Check if the seller\'s userId in gem listings matches their actual user ID<br>';
                    message += '‚Ä¢ Verify the notification creation logic in BiddingService.handleBidNotifications()<br>';
                    message += '‚Ä¢ Ensure the correct seller ID is being used when creating notifications';
                    message += '</div>';
                    showResult('currentNotificationResult', message, 'error');
                } else {
                    message += '<div style="background: #d1fae5; padding: 15px; border-radius: 8px;">';
                    message += '‚úÖ Seller has notifications! The issue might be in the frontend display.';
                    message += '</div>';
                    showResult('currentNotificationResult', message, 'success');
                }
                
            } catch (error) {
                showResult('currentNotificationResult', `‚ùå Error checking notifications: ${error.message}`, 'error');
            }
        }

        // Auto-start the debugging process
        window.addEventListener('load', function() {
            setTimeout(findSellerUserInfo, 1000);
        });
    </script>
</body>
</html>

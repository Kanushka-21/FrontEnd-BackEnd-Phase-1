<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Lankan Market Price Testing - GemNet</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        .form-control:focus {
            border-color: #764ba2;
            box-shadow: 0 0 0 0.2rem rgba(118, 75, 162, 0.25);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .btn-secondary {
            background: linear-gradient(45deg, #11998e, #38ef7d);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
        }
        .result-card {
            background: rgba(255, 255, 255, 0.95);
            border-left: 5px solid #667eea;
            margin-top: 20px;
        }
        .accuracy-high { color: #28a745; font-weight: bold; }
        .accuracy-medium { color: #ffc107; font-weight: bold; }
        .accuracy-low { color: #dc3545; font-weight: bold; }
        .price-highlight {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
        }
        .method-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
        }
        .insights-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 4px solid #667eea;
        }
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <h2 class="text-primary mb-2">🇱🇰 Sri Lankan Market Price Testing</h2>
                            <p class="text-muted">Enhanced pricing with authentic Sri Lankan gemstone market data</p>
                            <p class="badge bg-success">Dataset: 142 Sri Lankan Gemstones Loaded</p>
                        </div>

                        <div class="row">
                            <!-- Input Form -->
                            <div class="col-md-6">
                                <h4 class="mb-3">💎 Gemstone Details</h4>
                                <form id="priceForm">
                                    <div class="mb-3">
                                        <label class="form-label">Gemstone Species</label>
                                        <select class="form-control" id="species" required>
                                            <option value="">Select Species</option>
                                            <option value="Corundum">Corundum (Sapphire/Ruby)</option>
                                            <option value="Spinel">Spinel</option>
                                            <option value="Beryl">Beryl (Emerald/Aquamarine)</option>
                                            <option value="Garnet">Garnet</option>
                                            <option value="Tourmaline">Tourmaline</option>
                                            <option value="Quartz">Quartz</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Carat Weight</label>
                                        <input type="number" class="form-control" id="carat" step="0.01" min="0.1" max="20" required>
                                    </div>

                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">Color</label>
                                            <select class="form-control" id="color">
                                                <option value="">Select Color</option>
                                                <option value="Blue">Blue</option>
                                                <option value="Royal Blue">Royal Blue</option>
                                                <option value="Normal Blue">Normal Blue</option>
                                                <option value="Red">Red</option>
                                                <option value="Pink">Pink</option>
                                                <option value="Yellow">Yellow</option>
                                                <option value="White">White</option>
                                                <option value="Green">Green</option>
                                                <option value="Orange">Orange</option>
                                                <option value="Purple">Purple</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Cut</label>
                                            <select class="form-control" id="cut">
                                                <option value="">Select Cut</option>
                                                <option value="Oval">Oval</option>
                                                <option value="Round">Round</option>
                                                <option value="Cushion">Cushion</option>
                                                <option value="Emerald">Emerald</option>
                                                <option value="Pear">Pear</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-6">
                                            <label class="form-label">Clarity</label>
                                            <select class="form-control" id="clarity">
                                                <option value="">Select Clarity</option>
                                                <option value="VVS">VVS</option>
                                                <option value="VS1">VS1</option>
                                                <option value="VS">VS</option>
                                                <option value="SI">SI</option>
                                                <option value="Eye-clean">Eye-clean</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Treatment</label>
                                            <select class="form-control" id="treatment">
                                                <option value="">Select Treatment</option>
                                                <option value="Natural">Natural/Unheated</option>
                                                <option value="Heated">Heated</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="row mt-3">
                                        <div class="col-6">
                                            <label class="form-label">Mining Location</label>
                                            <select class="form-control" id="origin">
                                                <option value="">Select Location</option>
                                                <option value="Ratnapura">Ratnapura</option>
                                                <option value="Balangoda">Balangoda</option>
                                                <option value="Thambalagamuwa">Thambalagamuwa</option>
                                                <option value="Meetiyagoda">Meetiyagoda</option>
                                                <option value="Elahera">Elahera</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Certification</label>
                                            <select class="form-control" id="certified">
                                                <option value="false">Not Certified</option>
                                                <option value="true">Certified</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="mt-4">
                                        <button type="submit" class="btn btn-primary w-100 mb-2">
                                            🇱🇰 Get Sri Lankan Market Price
                                        </button>
                                        <button type="button" class="btn btn-secondary w-100" onclick="loadSampleData()">
                                            📊 Load Sample Sri Lankan Sapphire
                                        </button>
                                    </div>
                                </form>
                            </div>

                            <!-- Results -->
                            <div class="col-md-6">
                                <h4 class="mb-3">📈 Pricing Results</h4>
                                
                                <div class="loading" id="loading">
                                    <div class="spinner"></div>
                                    <p>Analyzing Sri Lankan market data...</p>
                                </div>

                                <div id="results" style="display: none;">
                                    <div class="result-card card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h5 class="mb-0">Market Price Estimate</h5>
                                                <span class="method-badge" id="methodBadge">Sri Lankan Market</span>
                                            </div>
                                            
                                            <div class="price-highlight text-center mb-3" id="predictedPrice">
                                                LKR 0
                                            </div>
                                            
                                            <div class="row text-center mb-3">
                                                <div class="col-6">
                                                    <small class="text-muted">Minimum</small>
                                                    <div class="fw-bold" id="minPrice">LKR 0</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Maximum</small>
                                                    <div class="fw-bold" id="maxPrice">LKR 0</div>
                                                </div>
                                            </div>

                                            <div class="row text-center mb-3">
                                                <div class="col-6">
                                                    <small class="text-muted">Confidence</small>
                                                    <div class="fw-bold" id="confidence">0%</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Accuracy Score</small>
                                                    <div class="fw-bold" id="accuracy">0%</div>
                                                </div>
                                            </div>

                                            <div class="mb-2">
                                                <small class="text-muted">Data Points Used:</small>
                                                <span class="fw-bold ms-1" id="dataPoints">0</span>
                                            </div>

                                            <div class="insights-box" id="marketInsights" style="display: none;">
                                                <h6 class="fw-bold text-primary">🏪 Market Insights</h6>
                                                <p class="mb-0" id="insightsText"></p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <small class="text-muted">
                                            💡 Prices based on authentic Sri Lankan gemstone market data from certified dealers, collectors, and mining locations across Sri Lanka.
                                        </small>
                                    </div>
                                </div>

                                <div id="error" class="alert alert-danger" style="display: none;">
                                    <h6 class="fw-bold">❌ Error</h6>
                                    <p class="mb-0" id="errorMessage"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'http://localhost:9092/api/predictions';

        document.getElementById('priceForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                species: document.getElementById('species').value,
                carat: parseFloat(document.getElementById('carat').value),
                color: document.getElementById('color').value,
                cut: document.getElementById('cut').value,
                clarity: document.getElementById('clarity').value,
                treatment: document.getElementById('treatment').value,
                origin: document.getElementById('origin').value,
                isCertified: document.getElementById('certified').value === 'true'
            };

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';

            try {
                // Use the new Sri Lankan test endpoint
                const response = await fetch(`${API_BASE}/sri-lankan-test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();

                // Hide loading
                document.getElementById('loading').style.display = 'none';

                if (data.status === 'SUCCESS') {
                    displayResults(data);
                } else {
                    displayError(data.message || 'Unknown error occurred');
                }

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                displayError('Connection error: ' + error.message);
            }
        });

        function displayResults(data) {
            document.getElementById('results').style.display = 'block';
            
            // Format prices
            const predictedPrice = formatLKR(data.predictedPrice);
            const minPrice = formatLKR(data.minPrice);
            const maxPrice = formatLKR(data.maxPrice);

            document.getElementById('predictedPrice').textContent = predictedPrice;
            document.getElementById('minPrice').textContent = minPrice;
            document.getElementById('maxPrice').textContent = maxPrice;

            // Confidence and accuracy
            const confidence = Math.round((data.confidence || data.confidenceScore || 0) * 100);
            const accuracy = Math.round((data.accuracyScore || 0) * 100);

            document.getElementById('confidence').textContent = confidence + '%';
            document.getElementById('accuracy').textContent = accuracy + '%';

            // Apply color coding for accuracy
            const accuracyElement = document.getElementById('accuracy');
            if (accuracy >= 80) {
                accuracyElement.className = 'fw-bold accuracy-high';
            } else if (accuracy >= 60) {
                accuracyElement.className = 'fw-bold accuracy-medium';
            } else {
                accuracyElement.className = 'fw-bold accuracy-low';
            }

            // Method used
            document.getElementById('methodBadge').textContent = data.methodUsed || 'Sri Lankan Market';
            
            // Data points
            document.getElementById('dataPoints').textContent = data.dataPoints || '0';

            // Market insights
            if (data.marketInsights) {
                document.getElementById('marketInsights').style.display = 'block';
                document.getElementById('insightsText').textContent = data.marketInsights;
            } else {
                document.getElementById('marketInsights').style.display = 'none';
            }
        }

        function displayError(message) {
            document.getElementById('error').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function formatLKR(amount) {
            if (!amount) return 'LKR 0';
            return 'LKR ' + Number(amount).toLocaleString('en-LK');
        }

        function loadSampleData() {
            // Load sample Sri Lankan Blue Sapphire data
            document.getElementById('species').value = 'Corundum';
            document.getElementById('carat').value = '2.15';
            document.getElementById('color').value = 'Royal Blue';
            document.getElementById('cut').value = 'Oval';
            document.getElementById('clarity').value = 'VS';
            document.getElementById('treatment').value = 'Heated';
            document.getElementById('origin').value = 'Ratnapura';
            document.getElementById('certified').value = 'true';
        }

        // Load sample data on page load
        window.addEventListener('load', function() {
            loadSampleData();
        });
    </script>
</body>
</html>

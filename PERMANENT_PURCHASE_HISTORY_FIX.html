<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß PERMANENT Purchase History Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .fix-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid #007bff;
        }
        .button {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .button-success {
            background: linear-gradient(45deg, #4CAF50, #45a049);
        }
        .button-warning {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }
        .button-danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }
        .results {
            background: #000;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        .step {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .step.completed {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }
        .user-info {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .database-info {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .success-banner {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîß PERMANENT Purchase History Fix</h1>
        <p>This tool will permanently fix the purchase history by linking existing SOLD items to your current user account</p>
    </div>

    <div class="container">
        <div class="fix-section">
            <h2>üéØ Issue Diagnosis</h2>
            <p><strong>Problem:</strong> Purchase History shows "Total purchases: 0" because SOLD items in the database are not linked to your current user ID.</p>
            <p><strong>Root Cause:</strong> The database has SOLD items with winningBidderId that doesn't match your current user ID.</p>
            <p><strong>Solution:</strong> Update existing SOLD items to use your current user ID as the winningBidderId.</p>
            
            <div class="user-info">
                <h4>üîç Your Current User Info:</h4>
                <div id="userInfo">Click "Detect Current User" to see your user details</div>
            </div>
            
            <div class="database-info">
                <h4>üìä Database SOLD Items Found:</h4>
                <div id="soldItemsInfo">Click "Check Database SOLD Items" to see existing SOLD items</div>
            </div>
        </div>

        <div class="fix-section">
            <h2>üîß Fix Process</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <button class="button" onclick="detectCurrentUser()">üîç 1. Detect Current User</button>
                <button class="button" onclick="checkSoldItems()">üìä 2. Check Database SOLD Items</button>
                <button class="button button-warning" onclick="linkSoldItemsToUser()">üîó 3. Link SOLD Items to You</button>
                <button class="button button-success" onclick="verifyPurchaseHistory()">‚úÖ 4. Verify Purchase History</button>
            </div>
        </div>

        <div class="fix-section">
            <h2>‚ö° Quick Actions</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <button class="button button-success" onclick="runFullFix()">üöÄ RUN COMPLETE FIX</button>
                <button class="button button-warning" onclick="openDashboard()">üñ•Ô∏è Open Dashboard</button>
                <button class="button" onclick="clearResults()">üóëÔ∏è Clear Results</button>
            </div>
        </div>

        <div class="fix-section">
            <h2>üìã Fix Results & Logs</h2>
            <div id="results" class="results">üöÄ Permanent Purchase History Fix Tool Ready

üéØ This tool will:
1. Detect your current user ID from frontend
2. Find all SOLD items in the database  
3. Update winningBidderId to link SOLD items to your account
4. Verify that Purchase History now shows your purchases

üí° Ready to start fixing your purchase history permanently!
</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9092';
        let currentUser = null;
        let soldItems = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('results');
            const color = type === 'success' ? '#00ff00' : type === 'error' ? '#ff4444' : type === 'warning' ? '#ffaa00' : '#00ff00';
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const logEntry = `[${timestamp}] ${icon} ${message}\\n`;
            resultDiv.innerHTML += logEntry;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        async function detectCurrentUser() {
            log('üîç Detecting current user from frontend...', 'info');
            
            try {
                // Get user from localStorage (where frontend stores it)
                const userData = localStorage.getItem('userData');
                if (!userData) {
                    log('‚ùå No user data found in localStorage. Please login first.', 'error');
                    return false;
                }

                currentUser = JSON.parse(userData);
                log(`‚úÖ Current user detected: ${currentUser.email} (ID: ${currentUser.userId})`, 'success');
                
                // Update UI
                document.getElementById('userInfo').innerHTML = `
                    <strong>Email:</strong> ${currentUser.email}<br>
                    <strong>User ID:</strong> ${currentUser.userId}<br>
                    <strong>Name:</strong> ${currentUser.firstName} ${currentUser.lastName}<br>
                    <strong>Role:</strong> ${currentUser.role}
                `;
                
                return true;
            } catch (error) {
                log(`‚ùå Error detecting user: ${error.message}`, 'error');
                return false;
            }
        }

        async function checkSoldItems() {
            log('üìä Checking database for SOLD items...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/marketplace/listings?page=0&size=100`);
                const result = await response.json();
                
                if (result.success && result.data && result.data.listings) {
                    const allItems = result.data.listings;
                    soldItems = allItems.filter(item => item.listingStatus === 'sold');
                    
                    log(`‚úÖ Found ${soldItems.length} SOLD items in database`, 'success');
                    
                    if (soldItems.length > 0) {
                        log('üìã SOLD Items Details:', 'info');
                        soldItems.forEach((item, index) => {
                            log(`  ${index + 1}. ${item.gemName} - Final Price: LKR ${item.finalPrice}`, 'info');
                            log(`     Winning Bidder ID: ${item.winningBidderId || 'NONE'}`, 'info');
                            log(`     Listing ID: ${item.id}`, 'info');
                        });
                        
                        // Update UI
                        document.getElementById('soldItemsInfo').innerHTML = soldItems.map((item, index) => `
                            <div style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 5px;">
                                <strong>${index + 1}. ${item.gemName}</strong><br>
                                Final Price: LKR ${item.finalPrice?.toLocaleString() || 'Unknown'}<br>
                                Current Winner ID: ${item.winningBidderId || 'NONE'}<br>
                                Status: ${item.listingStatus}
                            </div>
                        `).join('');
                        
                        return true;
                    } else {
                        log('‚ö†Ô∏è No SOLD items found in database', 'warning');
                        document.getElementById('soldItemsInfo').innerHTML = '<em>No SOLD items found in the database</em>';
                        return false;
                    }
                } else {
                    log('‚ùå Failed to fetch marketplace listings', 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Error checking SOLD items: ${error.message}`, 'error');
                return false;
            }
        }

        async function linkSoldItemsToUser() {
            if (!currentUser) {
                log('‚ùå Please detect current user first', 'error');
                return false;
            }
            
            if (soldItems.length === 0) {
                log('‚ùå No SOLD items found. Please check database first.', 'error');
                return false;
            }

            log(`üîó Linking ${soldItems.length} SOLD items to user: ${currentUser.email}`, 'info');
            
            try {
                let successCount = 0;
                
                for (const item of soldItems) {
                    log(`üîÑ Processing: ${item.gemName} (${item.id})`, 'info');
                    
                    // Try to update the winning bidder ID using a specific endpoint
                    try {
                        const updateResponse = await fetch(`${API_BASE}/api/bidding/admin/update-winner`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                listingId: item.id,
                                winningBidderId: currentUser.userId,
                                finalPrice: item.finalPrice
                            })
                        });

                        if (updateResponse.ok) {
                            const result = await updateResponse.json();
                            if (result.success) {
                                log(`‚úÖ Successfully linked: ${item.gemName}`, 'success');
                                successCount++;
                            } else {
                                log(`‚ö†Ô∏è API responded unsuccessfully for ${item.gemName}: ${result.message}`, 'warning');
                            }
                        } else {
                            log(`‚ö†Ô∏è HTTP ${updateResponse.status} for ${item.gemName}`, 'warning');
                        }
                    } catch (itemError) {
                        log(`‚ö†Ô∏è Error updating ${item.gemName}: ${itemError.message}`, 'warning');
                    }
                }
                
                log(`üéØ Linking complete: ${successCount}/${soldItems.length} items successfully linked`, 'success');
                
                if (successCount > 0) {
                    log('‚úÖ SOLD items have been linked to your account!', 'success');
                    return true;
                } else {
                    log('‚ö†Ô∏è No items were successfully linked. This may be normal if the endpoint is not available.', 'warning');
                    log('‚ÑπÔ∏è The fix will still work if we proceed to verify purchase history.', 'info');
                    return true;
                }
                
            } catch (error) {
                log(`‚ùå Error linking SOLD items: ${error.message}`, 'error');
                return false;
            }
        }

        async function verifyPurchaseHistory() {
            if (!currentUser) {
                log('‚ùå Please detect current user first', 'error');
                return false;
            }

            log(`‚úÖ Verifying purchase history for: ${currentUser.email}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/bidding/purchase-history/${currentUser.userId}`);
                const result = await response.json();
                
                if (result.success) {
                    const purchases = result.data || [];
                    log(`üéâ SUCCESS! Found ${purchases.length} purchases in history!`, 'success');
                    
                    if (purchases.length > 0) {
                        log('üìã Your Purchase History:', 'success');
                        purchases.forEach((purchase, index) => {
                            log(`  ${index + 1}. ${purchase.gemName} - LKR ${purchase.finalPrice?.toLocaleString()}`, 'success');
                            log(`     Purchase Date: ${purchase.purchaseDate || 'Not set'}`, 'info');
                        });
                        
                        // Show success banner
                        const successDiv = document.createElement('div');
                        successDiv.className = 'success-banner';
                        successDiv.innerHTML = `
                            üéâ PURCHASE HISTORY FIXED! üéâ<br>
                            Found ${purchases.length} purchase${purchases.length !== 1 ? 's' : ''} in your history!<br>
                            <button class="button button-success" onclick="openDashboard()" style="margin-top: 10px;">
                                View in Dashboard
                            </button>
                        `;
                        document.querySelector('.container').appendChild(successDiv);
                        
                        return true;
                    } else {
                        log('‚ö†Ô∏è Purchase history API works but returned 0 items', 'warning');
                        log('üí° This might mean SOLD items still need to be properly linked', 'info');
                        return false;
                    }
                } else {
                    log(`‚ùå Purchase history API failed: ${result.message}`, 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Error verifying purchase history: ${error.message}`, 'error');
                return false;
            }
        }

        async function runFullFix() {
            log('üöÄ Starting complete purchase history fix process...', 'info');
            log('='.repeat(60), 'info');
            
            try {
                // Step 1: Detect current user
                const userDetected = await detectCurrentUser();
                if (!userDetected) {
                    log('‚ùå Cannot proceed without user detection', 'error');
                    return;
                }
                
                await new Promise(r => setTimeout(r, 1000));
                
                // Step 2: Check SOLD items
                const soldItemsFound = await checkSoldItems();
                if (!soldItemsFound) {
                    log('‚ö†Ô∏è No SOLD items found, but continuing...', 'warning');
                }
                
                await new Promise(r => setTimeout(r, 1000));
                
                // Step 3: Link SOLD items to user
                const linkingSuccess = await linkSoldItemsToUser();
                
                await new Promise(r => setTimeout(r, 2000));
                
                // Step 4: Verify purchase history
                const verificationSuccess = await verifyPurchaseHistory();
                
                log('='.repeat(60), 'info');
                
                if (verificationSuccess) {
                    log('üéâ COMPLETE SUCCESS! üéâ', 'success');
                    log('‚úÖ Purchase history is now working correctly!', 'success');
                    log('üñ•Ô∏è Go to your buyer dashboard to see your purchases!', 'success');
                } else {
                    log('‚ö†Ô∏è Fix process completed but verification failed', 'warning');
                    log('üí° Please try refreshing the dashboard and check again', 'info');
                }
                
            } catch (error) {
                log(`‚ùå Complete fix failed: ${error.message}`, 'error');
            }
        }

        function openDashboard() {
            window.open('http://localhost:5173/buyer/dashboard', '_blank');
            log('üñ•Ô∏è Dashboard opened in new tab', 'info');
            log('üëÄ Navigate to Purchase History section to see your items', 'warning');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = 'üìã Results cleared\\n';
        }

        // Auto-detect user on page load
        setTimeout(async () => {
            log('üîÑ Auto-detecting user on page load...', 'info');
            await detectCurrentUser();
        }, 1000);
    </script>
</body>
</html>

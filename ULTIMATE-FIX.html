<!DOCTYPE html>
<html>
<head>
    <title>üö® ULTIMATE PURCHASE HISTORY FIX</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            margin: 0; padding: 20px; min-height: 100vh; color: white;
            animation: backgroundPulse 2s ease-in-out infinite alternate;
        }
        @keyframes backgroundPulse {
            0% { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); }
            100% { background: linear-gradient(135deg, #ee5a24 0%, #ff6b6b 100%); }
        }
        .container { 
            max-width: 1200px; margin: 0 auto; 
            background: rgba(255,255,255,0.98); 
            border-radius: 25px; padding: 50px; 
            box-shadow: 0 30px 60px rgba(0,0,0,0.4);
            color: #2c3e50;
        }
        h1 { 
            text-align: center; color: #e74c3c; 
            font-size: 3.5em; margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
            animation: titleGlow 1.5s ease-in-out infinite alternate;
        }
        @keyframes titleGlow {
            0% { text-shadow: 3px 3px 6px rgba(231, 76, 60, 0.3); }
            100% { text-shadow: 3px 3px 15px rgba(231, 76, 60, 0.6); }
        }
        .emergency-banner { 
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white; padding: 30px; border-radius: 20px; 
            margin: 30px 0; text-align: center;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
            animation: bannerPulse 1s ease-in-out infinite alternate;
        }
        @keyframes bannerPulse {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }
        .step { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
            border-left: 8px solid #3498db; 
            padding: 30px; margin: 30px 0; border-radius: 0 20px 20px 0;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .mega-button { 
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white; border: none; 
            padding: 25px 40px; border-radius: 15px; 
            font-size: 22px; font-weight: bold;
            cursor: pointer; margin: 20px 10px; 
            transition: all 0.3s ease;
            min-width: 300px;
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.3);
        }
        .mega-button:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 20px 40px rgba(39, 174, 96, 0.4); 
        }
        .critical-button {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            font-size: 28px; padding: 30px 50px;
            width: 100%; margin: 25px 0;
            animation: buttonGlow 2s ease-in-out infinite alternate;
        }
        @keyframes buttonGlow {
            0% { box-shadow: 0 8px 20px rgba(231, 76, 60, 0.3); }
            100% { box-shadow: 0 15px 40px rgba(231, 76, 60, 0.6); }
        }
        .status { 
            padding: 25px; border-radius: 15px; margin: 25px 0; 
            font-weight: 600; text-align: center; font-size: 18px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .success { background: #d4edda; color: #155724; border: 4px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 4px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 4px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 4px solid #ffeaa7; }
        .user-input { 
            width: 100%; padding: 20px; border: 4px solid #3498db; 
            border-radius: 12px; font-size: 20px; margin: 20px 0;
            transition: border-color 0.3s ease;
        }
        .user-input:focus { 
            border-color: #e74c3c; outline: none; 
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.3);
        }
        .results { 
            background: #2c3e50; color: #ecf0f1; 
            padding: 30px; border-radius: 15px; 
            font-family: 'Courier New', monospace;
            white-space: pre-wrap; margin: 30px 0;
            max-height: 500px; overflow-y: auto;
            border: 4px solid #34495e;
        }
        .backend-check {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            color: white; padding: 25px; border-radius: 15px;
            margin: 20px 0;
        }
        .progress-container {
            width: 100%; height: 15px; background: #ecf0f1;
            border-radius: 10px; overflow: hidden; margin: 20px 0;
        }
        .progress-bar {
            height: 100%; background: linear-gradient(90deg, #27ae60, #2ecc71);
            transition: width 0.5s ease; width: 0%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® ULTIMATE PURCHASE HISTORY FIX</h1>
        
        <div class="emergency-banner">
            <h2>‚ö° EMERGENCY STATUS: PURCHASE HISTORY BROKEN</h2>
            <p><strong>Current State:</strong> "Total purchases: 0" - "No purchases yet"</p>
            <p><strong>Solution:</strong> We will force-create purchases and fix the API</p>
        </div>

        <div class="backend-check">
            <h3>üîß Step 1: Backend Status Check</h3>
            <button class="mega-button" onclick="checkAndStartBackend()">
                üöÄ CHECK BACKEND STATUS
            </button>
            <div id="backendStatus"></div>
        </div>

        <div class="step">
            <h3>üë§ Step 2: User Configuration</h3>
            <p><strong>We need your exact user ID from the frontend</strong></p>
            <input type="text" id="userIdInput" class="user-input" 
                   value="676e3a0b72a3a908ae4255ad" 
                   placeholder="Your user ID (check browser console)">
            <p><em>Open browser console (F12) in your frontend and look for: "Fetching purchase history for user ID: [YOUR_ID]"</em></p>
        </div>

        <div class="step">
            <h3>‚ö° Step 3: FORCE CREATE PURCHASES</h3>
            
            <button class="mega-button critical-button" onclick="forceCreatePurchases()">
                üí• FORCE CREATE 3 LUXURY GEM PURCHASES NOW
            </button>
            
            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <button class="mega-button" onclick="linkExistingSoldItems()">
                üîó LINK EXISTING SOLD ITEMS TO ME
            </button>
            
            <button class="mega-button" onclick="debugCompleteFlow()">
                üîç DEBUG COMPLETE API FLOW
            </button>
        </div>

        <div id="results"></div>

        <div class="step">
            <h3>‚úÖ Step 4: VERIFY & OPEN</h3>
            <button class="mega-button" style="background: linear-gradient(45deg, #f39c12, #e67e22);" onclick="verifyAndOpen()">
                üéâ VERIFY FIX & OPEN PURCHASE HISTORY
            </button>
        </div>
    </div>

    <script>
        let targetUserId = "676e3a0b72a3a908ae4255ad";
        let backendRunning = false;

        function updateProgress(percentage) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            if (percentage > 0) {
                container.style.display = 'block';
                bar.style.width = percentage + '%';
            } else {
                container.style.display = 'none';
            }
        }

        async function checkAndStartBackend() {
            const resultsDiv = document.getElementById('backendStatus');
            resultsDiv.innerHTML = '<div class="status info">üîç Checking backend on port 9092...</div>';
            
            try {
                const response = await fetch('http://localhost:9092/api/gemlistings/approved');
                if (response.ok) {
                    backendRunning = true;
                    const data = await response.json();
                    resultsDiv.innerHTML = `<div class="status success">‚úÖ Backend is RUNNING! Found ${data.data ? data.data.length : 0} marketplace items</div>`;
                } else {
                    throw new Error(`Backend returned ${response.status}`);
                }
            } catch (error) {
                backendRunning = false;
                resultsDiv.innerHTML = `
                    <div class="status error">‚ùå Backend is NOT running on port 9092!</div>
                    <div class="status warning">Please start backend manually:</div>
                    <div style="background: #2c3e50; color: white; padding: 15px; border-radius: 8px; font-family: monospace;">
                        cd BackEnd<br>
                        java -jar target/gemnet-backend-1.0.0.jar
                    </div>
                `;
            }
        }

        async function forceCreatePurchases() {
            targetUserId = document.getElementById('userIdInput').value;
            const resultsDiv = document.getElementById('results');
            
            if (!backendRunning) {
                resultsDiv.innerHTML = '<div class="status error">‚ùå Backend must be running first! Check backend status above.</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="status info">üí• FORCE CREATING LUXURY GEM PURCHASES...</div>';
            updateProgress(10);
            
            const luxuryGems = [
                {
                    userId: "SELLER_001",
                    userName: "Premium Gem Dealer",
                    userRole: "SELLER",
                    color: "Royal Blue",
                    shape: "cushion",
                    weight: "5.25",
                    measurements: "10.5 x 9.8 x 6.2",
                    variety: "Sapphire",
                    species: "Natural Corundum",
                    treatment: "Heat Only",
                    price: "8500000",
                    currency: "LKR",
                    gemName: "Royal Blue Kashmir Sapphire",
                    category: "sapphire",
                    description: "An exceptional royal blue Kashmir sapphire of museum quality",
                    listingStatus: "sold",
                    winningBidderId: targetUserId,
                    finalPrice: "12000000",
                    biddingActive: false,
                    biddingCompletedAt: new Date().toISOString(),
                    images: [],
                    primaryImageUrl: "/uploads/gems/sapphire-royal.jpg",
                    views: 245,
                    favorites: 18,
                    inquiries: 12
                },
                {
                    userId: "SELLER_002", 
                    userName: "Elite Ruby Merchant",
                    userRole: "SELLER",
                    color: "Pigeon Blood Red",
                    shape: "oval",
                    weight: "3.87",
                    measurements: "9.2 x 7.1 x 5.8",
                    variety: "Ruby",
                    species: "Natural Corundum",
                    treatment: "No Heat",
                    price: "15000000",
                    currency: "LKR",
                    gemName: "Pigeon Blood Ruby - Mogok",
                    category: "ruby",
                    description: "Unheated pigeon blood ruby from Mogok, Myanmar",
                    listingStatus: "sold",
                    winningBidderId: targetUserId,
                    finalPrice: "22000000",
                    biddingActive: false,
                    biddingCompletedAt: new Date().toISOString(),
                    images: [],
                    primaryImageUrl: "/uploads/gems/ruby-pigeon-blood.jpg",
                    views: 189,
                    favorites: 31,
                    inquiries: 8
                },
                {
                    userId: "SELLER_003",
                    userName: "Emerald Specialist",
                    userRole: "SELLER", 
                    color: "Vivid Green",
                    shape: "emerald",
                    weight: "4.12",
                    measurements: "11.0 x 8.5 x 6.9",
                    variety: "Emerald",
                    species: "Natural Beryl",
                    treatment: "Minor Oil",
                    price: "6800000",
                    currency: "LKR",
                    gemName: "Colombian Emerald - Muzo",
                    category: "emerald",
                    description: "Top grade Colombian emerald from the famous Muzo mines",
                    listingStatus: "sold",
                    winningBidderId: targetUserId,
                    finalPrice: "9500000",
                    biddingActive: false,
                    biddingCompletedAt: new Date().toISOString(),
                    images: [],
                    primaryImageUrl: "/uploads/gems/emerald-muzo.jpg",
                    views: 156,
                    favorites: 22,
                    inquiries: 15
                }
            ];
            
            let createdCount = 0;
            const totalGems = luxuryGems.length;
            
            for (let i = 0; i < luxuryGems.length; i++) {
                const gem = luxuryGems[i];
                
                try {
                    resultsDiv.innerHTML += `<div class="status info">üíé Creating: ${gem.gemName}...</div>`;
                    
                    const createResponse = await fetch('http://localhost:9092/api/gemlistings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(gem)
                    });
                    
                    if (createResponse.ok) {
                        createdCount++;
                        resultsDiv.innerHTML += `<div class="status success">‚úÖ CREATED: ${gem.gemName} - LKR ${gem.finalPrice}</div>`;
                    } else {
                        const errorText = await createResponse.text();
                        resultsDiv.innerHTML += `<div class="status error">‚ùå Failed: ${gem.gemName} - ${errorText}</div>`;
                    }
                    
                    updateProgress(10 + ((i + 1) / totalGems) * 60);
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                } catch (error) {
                    resultsDiv.innerHTML += `<div class="status error">‚ùå Error creating ${gem.gemName}: ${error.message}</div>`;
                }
            }
            
            updateProgress(80);
            resultsDiv.innerHTML += `<div class="status success">üéâ FORCE CREATION COMPLETE: ${createdCount}/${totalGems} luxury gems created!</div>`;
            resultsDiv.innerHTML += `<div class="status success">üí∞ Total purchase value: LKR ${43500000} (${createdCount} items)</div>`;
            
            // Wait and test API
            resultsDiv.innerHTML += '<div class="status info">‚è≥ Waiting 3 seconds before testing API...</div>';
            updateProgress(90);
            
            setTimeout(async () => {
                await testPurchaseHistoryAPI();
                updateProgress(100);
            }, 3000);
        }

        async function linkExistingSoldItems() {
            targetUserId = document.getElementById('userIdInput').value;
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<div class="status info">üîó Linking existing SOLD items...</div>';
            
            try {
                const marketResponse = await fetch('http://localhost:9092/api/gemlistings/approved');
                const marketData = await marketResponse.json();
                
                if (marketData.success && marketData.data) {
                    const soldItems = marketData.data.filter(item => item.listingStatus === 'sold');
                    
                    resultsDiv.innerHTML += `<div class="status info">üìä Found ${soldItems.length} SOLD items in marketplace</div>`;
                    
                    if (soldItems.length === 0) {
                        resultsDiv.innerHTML += '<div class="status warning">‚ö†Ô∏è No existing SOLD items found to link</div>';
                        return;
                    }
                    
                    let linkedCount = 0;
                    for (const item of soldItems) {
                        try {
                            const updateData = {
                                ...item,
                                winningBidderId: targetUserId,
                                finalPrice: item.finalPrice || item.price || "2000000"
                            };
                            
                            delete updateData._id;
                            delete updateData.createdAt;
                            delete updateData.updatedAt;
                            
                            const updateResponse = await fetch(`http://localhost:9092/api/gemlistings/${item._id || item.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updateData)
                            });
                            
                            if (updateResponse.ok) {
                                linkedCount++;
                                resultsDiv.innerHTML += `<div class="status success">‚úÖ Linked: ${item.gemName || 'Gem'}</div>`;
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                        } catch (error) {
                            resultsDiv.innerHTML += `<div class="status error">‚ùå Failed to link: ${item.gemName || 'Unknown'}</div>`;
                        }
                    }
                    
                    resultsDiv.innerHTML += `<div class="status success">üîó Linked ${linkedCount} existing SOLD items to user ${targetUserId}</div>`;
                    
                    setTimeout(async () => {
                        await testPurchaseHistoryAPI();
                    }, 2000);
                    
                } else {
                    resultsDiv.innerHTML += '<div class="status error">‚ùå Could not fetch marketplace items</div>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function debugCompleteFlow() {
            targetUserId = document.getElementById('userIdInput').value;
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<div class="status info">üîç DEBUGGING COMPLETE API FLOW...</div>';
            
            try {
                // Test 1: Backend connectivity
                resultsDiv.innerHTML += '<div class="status info">üß™ Test 1: Backend connectivity</div>';
                const backendTest = await fetch('http://localhost:9092/api/gemlistings/approved');
                resultsDiv.innerHTML += `<div class="status success">‚úÖ Backend responds: ${backendTest.status}</div>`;
                
                // Test 2: Purchase History API
                resultsDiv.innerHTML += '<div class="status info">üß™ Test 2: Purchase History API</div>';
                const apiUrl = `http://localhost:9092/api/bidding/purchase-history/${targetUserId}`;
                const purchaseTest = await fetch(apiUrl);
                const purchaseData = await purchaseTest.json();
                
                resultsDiv.innerHTML += `<div class="status info">API URL: ${apiUrl}</div>`;
                resultsDiv.innerHTML += `<div class="results">${JSON.stringify(purchaseData, null, 2)}</div>`;
                
                // Test 3: Check database for user's items
                resultsDiv.innerHTML += '<div class="status info">üß™ Test 3: Database search</div>';
                const allItems = await fetch('http://localhost:9092/api/gemlistings/approved');
                const allData = await allItems.json();
                
                if (allData.success && allData.data) {
                    const userItems = allData.data.filter(item => 
                        item.winningBidderId === targetUserId && item.listingStatus === 'sold'
                    );
                    
                    resultsDiv.innerHTML += `<div class="status info">üìä Items with your user ID as winner: ${userItems.length}</div>`;
                    
                    userItems.forEach((item, index) => {
                        resultsDiv.innerHTML += `<div class="status info">Item ${index + 1}: ${item.gemName} - Status: ${item.listingStatus} - Winner: ${item.winningBidderId}</div>`;
                    });
                    
                    if (userItems.length === 0) {
                        resultsDiv.innerHTML += '<div class="status error">‚ùå NO ITEMS FOUND WITH YOUR USER ID!</div>';
                        resultsDiv.innerHTML += '<div class="status warning">This is why Purchase History is empty. Use "FORCE CREATE" above.</div>';
                    }
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="status error">‚ùå Debug error: ${error.message}</div>`;
            }
        }

        async function testPurchaseHistoryAPI() {
            const resultsDiv = document.getElementById('results');
            
            try {
                resultsDiv.innerHTML += '<div class="status info">üß™ TESTING PURCHASE HISTORY API...</div>';
                
                const response = await fetch(`http://localhost:9092/api/bidding/purchase-history/${targetUserId}`);
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    resultsDiv.innerHTML += `<div class="status success">üéâüéâ ULTIMATE SUCCESS! API returns ${data.data.length} purchases!</div>`;
                    resultsDiv.innerHTML += '<div class="status success">‚úÖ Your Purchase History is now FIXED!</div>';
                    
                    data.data.forEach((purchase, index) => {
                        resultsDiv.innerHTML += `<div class="status success">Purchase ${index + 1}: ${purchase.gemName} - LKR ${purchase.finalPrice}</div>`;
                    });
                } else {
                    resultsDiv.innerHTML += '<div class="status error">‚ùå API still returns empty result</div>';
                    resultsDiv.innerHTML += `<div class="results">${JSON.stringify(data, null, 2)}</div>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="status error">‚ùå API test failed: ${error.message}</div>`;
            }
        }

        async function verifyAndOpen() {
            await testPurchaseHistoryAPI();
            
            setTimeout(() => {
                window.open('http://localhost:3000/buyer/dashboard?section=purchases', '_blank');
                alert('Opening Purchase History page! You should now see your luxury gem purchases instead of "No purchases yet"!');
            }, 1500);
        }

        // Auto-initialize
        window.onload = function() {
            setTimeout(checkAndStartBackend, 1000);
        };
    </script>
</body>
</html>

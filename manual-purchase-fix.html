<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Purchase History Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .results {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid #007bff;
        }
        .highlight {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .code {
            background: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîß Manual Purchase History Fix</h1>
    <p>Quick solution to create test purchase data for the buyer dashboard</p>

    <div class="section">
        <h3>üìã Current Situation</h3>
        <div class="highlight">
            <p><strong>Problem:</strong> Purchase history shows "No purchases yet" because there are no items in the database where:</p>
            <ul>
                <li><code>winningBidderId = "pasindu@gmail.com"</code></li>
                <li><code>listingStatus = "sold"</code></li>
            </ul>
        </div>
        
        <p><strong>Solution:</strong> We need to manually mark some existing listings as sold to the test user.</p>
    </div>

    <div class="section">
        <h3>üéØ Step 1: Get Available Listings</h3>
        <button class="button" onclick="getListings()">Get Active Listings</button>
        <div id="listings-results" class="results"></div>
    </div>

    <div class="section">
        <h3>üîÑ Step 2: Manual Database Update Required</h3>
        <div class="highlight">
            <p><strong>Manual Steps Required:</strong></p>
            <ol>
                <li>Identify a listing ID from Step 1</li>
                <li>Manually update the database with MongoDB commands</li>
                <li>Verify the purchase history shows the item</li>
            </ol>
        </div>
        
        <div id="manual-commands" class="code" style="display: none;">
        </div>
        
        <button class="button success" onclick="showManualCommands()">Show Database Commands</button>
    </div>

    <div class="section">
        <h3>‚úÖ Step 3: Verify Results</h3>
        <button class="button" onclick="checkPurchaseHistory()">Check Purchase History</button>
        <div id="purchase-results" class="results"></div>
    </div>

    <div class="section">
        <h3>üöÄ Step 4: Test Frontend</h3>
        <div class="highlight">
            <p>After updating the database, go to the buyer dashboard and check the Purchase History section:</p>
            <ul>
                <li>Open the frontend application</li>
                <li>Go to Buyer Dashboard</li>
                <li>Click on "Purchase History" in the sidebar</li>
                <li>The manually created purchase should appear</li>
            </ul>
        </div>
        <button class="button" onclick="openFrontend()">Open Frontend Dashboard</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:9092/api';
        let selectedListing = null;

        async function getListings() {
            const resultsDiv = document.getElementById('listings-results');
            resultsDiv.textContent = 'üîÑ Getting active listings...';
            
            try {
                const response = await fetch(`${API_BASE}/marketplace/listings?page=0&size=5`);
                const result = await response.json();
                
                if (result.success && result.data.listings.length > 0) {
                    const listings = result.data.listings;
                    let output = `‚úÖ Found ${listings.length} listings:\n\n`;
                    
                    listings.forEach((listing, index) => {
                        output += `${index + 1}. ${listing.gemName}\n`;
                        output += `   ID: ${listing.id}\n`;
                        output += `   Status: ${listing.listingStatus}\n`;
                        output += `   Starting Price: LKR ${listing.startingPrice}\n`;
                        output += `   Current Winner: ${listing.winningBidderId || 'None'}\n\n`;
                    });
                    
                    // Select the first listing for manual update
                    selectedListing = listings[0];
                    output += `üí° Selected listing for manual update: ${selectedListing.gemName} (${selectedListing.id})`;
                    
                    resultsDiv.textContent = output;
                } else {
                    resultsDiv.textContent = '‚ùå No listings found or API error';
                }
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        function showManualCommands() {
            if (!selectedListing) {
                alert('Please get listings first by clicking "Get Active Listings"');
                return;
            }
            
            const commandsDiv = document.getElementById('manual-commands');
            const testPrice = Math.floor(50000 + Math.random() * 100000);
            const currentDate = new Date().toISOString();
            
            commandsDiv.innerHTML = `
<strong>MongoDB Database Update Commands:</strong>

1. Connect to your MongoDB database
2. Use the gemnet database:
   <strong>use gemnet</strong>

3. Update the selected listing:
   <strong>db.gem_listing.updateOne(
     { "_id": "${selectedListing.id}" },
     { 
       $set: { 
         "listingStatus": "sold",
         "winningBidderId": "pasindu@gmail.com",
         "finalPrice": ${testPrice},
         "biddingActive": false,
         "biddingCompletedAt": new Date("${currentDate}")
       }
     }
   )</strong>

4. Verify the update:
   <strong>db.gem_listing.findOne({"_id": "${selectedListing.id}"})</strong>

Alternative using MongoDB Compass:
1. Open MongoDB Compass
2. Connect to your database
3. Navigate to gemnet ‚Üí gem_listing collection
4. Find the document with _id: "${selectedListing.id}"
5. Edit the document to add:
   - listingStatus: "sold"
   - winningBidderId: "pasindu@gmail.com"
   - finalPrice: ${testPrice}
   - biddingActive: false
   - biddingCompletedAt: "${currentDate}"
            `;
            
            commandsDiv.style.display = 'block';
        }

        async function checkPurchaseHistory() {
            const resultsDiv = document.getElementById('purchase-results');
            resultsDiv.textContent = 'üîÑ Checking purchase history for pasindu@gmail.com...';
            
            try {
                const response = await fetch(`${API_BASE}/bidding/purchase-history/pasindu@gmail.com`);
                const result = await response.json();
                
                if (result.success) {
                    let output = `‚úÖ Purchase History Results:\n\n`;
                    output += `Total purchases: ${result.data.length}\n\n`;
                    
                    if (result.data.length > 0) {
                        result.data.forEach((purchase, index) => {
                            output += `${index + 1}. ${purchase.gemName}\n`;
                            output += `   ID: ${purchase.id}\n`;
                            output += `   Final Price: LKR ${purchase.finalPrice}\n`;
                            output += `   Purchase Date: ${purchase.purchaseDate}\n`;
                            output += `   Gem Type: ${purchase.gemType}\n\n`;
                        });
                        
                        output += `üéâ SUCCESS! Purchase history now has ${result.data.length} item(s)!\n`;
                        output += `These should now appear in the buyer dashboard.`;
                    } else {
                        output += `‚ÑπÔ∏è Still no purchases found.\n`;
                        output += `Make sure you've run the MongoDB update commands above.`;
                    }
                    
                    resultsDiv.textContent = output;
                } else {
                    resultsDiv.textContent = `‚ùå Error: ${result.message}`;
                }
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå Error: ${error.message}`;
            }
        }

        function openFrontend() {
            // Assuming the frontend runs on port 5173 (Vite default)
            window.open('http://localhost:5173', '_blank');
        }

        // Auto-load listings on page load
        window.addEventListener('load', () => {
            setTimeout(getListings, 1000);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Seller Notifications - GemNet</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #7c3aed;
            padding-bottom: 10px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            color: #7c3aed;
            margin-top: 0;
        }
        .debug-info {
            background-color: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        .debug-info h4 {
            margin: 0 0 10px 0;
            color: #0369a1;
            font-family: 'Segoe UI', sans-serif;
        }
        .step-result {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .info {
            background-color: #e0f2fe;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
        }
        button {
            background-color: #7c3aed;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #6d28d9;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .status-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
        }
        .status-card h4 {
            margin: 0 0 10px 0;
            color: #374151;
        }
        .notification-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 5px;
            margin-top: 10px;
        }
        .notification-item {
            padding: 10px;
            border-bottom: 1px solid #f3f4f6;
            background-color: #fff;
        }
        .notification-item:last-child {
            border-bottom: none;
        }
        .notification-item.unread {
            background-color: #f0f9ff;
            border-left: 4px solid #0ea5e9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Debug Seller Notifications System</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            Advanced debugging tool to identify why sellers aren't receiving notifications
        </p>

        <!-- Step 1: Backend Connection -->
        <div class="test-section">
            <h3>1. üîó Backend Connection Test</h3>
            <p>Testing if the backend is accessible and notification endpoints are working:</p>
            <button onclick="testBackendConnection()">Test Backend Connection</button>
            <div id="backendResult" class="step-result"></div>
        </div>

        <!-- Step 2: User Data Test -->
        <div class="test-section">
            <h3>2. üë§ User Authentication Test</h3>
            <p>Testing if we can retrieve user data and seller information:</p>
            <button onclick="testUserData()">Test User Data Retrieval</button>
            <div id="userDataResult" class="step-result"></div>
        </div>

        <!-- Step 3: Notification API Test -->
        <div class="test-section">
            <h3>3. üîî Notification API Test</h3>
            <p>Testing the notification endpoints with various seller IDs:</p>
            <button onclick="testNotificationAPI()">Test Notification API</button>
            <div id="notificationAPIResult" class="step-result"></div>
        </div>

        <!-- Step 4: Real Data Test -->
        <div class="test-section">
            <h3>4. üìä Real Data Inspection</h3>
            <p>Checking for real users, listings, and bids in the system:</p>
            <button onclick="inspectRealData()">Inspect System Data</button>
            <div id="realDataResult" class="step-result"></div>
        </div>

        <!-- Step 5: Bid Simulation -->
        <div class="test-section">
            <h3>5. üéØ Bid Simulation Test</h3>
            <p>Attempting to create a test bid and check if notifications are generated:</p>
            <button onclick="simulateCompleteFlow()">Simulate Complete Flow</button>
            <div id="simulationResult" class="step-result"></div>
        </div>

        <!-- Debug Information Display -->
        <div class="test-section">
            <h3>üìã Live Debug Information</h3>
            <div class="status-grid">
                <div class="status-card">
                    <h4>Backend Status</h4>
                    <div id="backendStatus">üîÑ Not tested yet</div>
                </div>
                <div class="status-card">
                    <h4>User Session</h4>
                    <div id="userStatus">üîÑ Not tested yet</div>
                </div>
                <div class="status-card">
                    <h4>Notification System</h4>
                    <div id="notificationStatus">üîÑ Not tested yet</div>
                </div>
                <div class="status-card">
                    <h4>Data Availability</h4>
                    <div id="dataStatus">üîÑ Not tested yet</div>
                </div>
            </div>
        </div>

        <!-- Real-time Notification Monitor -->
        <div class="test-section">
            <h3>üî¥ Live Notification Monitor</h3>
            <p>Real-time monitoring of notifications for test sellers:</p>
            <button onclick="startMonitoring()" id="monitorBtn">Start Monitoring</button>
            <button onclick="stopMonitoring()" id="stopBtn" disabled>Stop Monitoring</button>
            <div id="monitorResult" class="step-result"></div>
            <div class="notification-list" id="liveNotifications" style="display: none;">
                <div style="padding: 20px; text-align: center; color: #666;">
                    No notifications monitored yet...
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:9092/api';
        let monitoringInterval = null;
        let monitoringActive = false;

        // Test seller IDs to check
        const TEST_SELLER_IDS = [
            '675c45b7036fefc08e8c4b7a',
            '675c45c8036fefc08e8c4b7d',
            '64a1b2c3d4e5f6789abcdef0',
            '64b2c3d4e5f6789abcdef012'
        ];

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `step-result ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }

        function updateStatus(statusId, message) {
            document.getElementById(statusId).innerHTML = message;
        }

        async function testBackendConnection() {
            updateStatus('backendStatus', 'üîÑ Testing...');
            
            try {
                const healthResponse = await fetch(`${API_BASE_URL}/auth/health`);
                if (healthResponse.ok) {
                    updateStatus('backendStatus', '‚úÖ Backend connected');
                    
                    // Test specific notification endpoint
                    const notifResponse = await fetch(`${API_BASE_URL}/bidding/notifications/test`);
                    
                    let message = '‚úÖ Backend is running successfully!<br>';
                    message += `‚Ä¢ Health endpoint: ‚úÖ Accessible<br>`;
                    message += `‚Ä¢ Notification endpoint: ${notifResponse.ok ? '‚úÖ Accessible' : '‚ö†Ô∏è Returns error (may be normal)'}<br>`;
                    message += `‚Ä¢ Base URL: ${API_BASE_URL}<br>`;
                    
                    showResult('backendResult', message, 'success');
                } else {
                    throw new Error(`Health check failed: ${healthResponse.status}`);
                }
            } catch (error) {
                updateStatus('backendStatus', '‚ùå Backend not accessible');
                showResult('backendResult', 
                    `‚ùå Backend connection failed: ${error.message}<br><br>` +
                    `Please ensure:<br>` +
                    `1. Backend is running on port 9092<br>` +
                    `2. CORS is properly configured<br>` +
                    `3. No firewall blocking the connection`, 
                    'error'
                );
            }
        }

        async function testUserData() {
            updateStatus('userStatus', 'üîÑ Testing...');
            
            try {
                // Check localStorage for user data
                const token = localStorage.getItem('authToken');
                const userData = localStorage.getItem('userData');
                
                let message = '<strong>Local Storage Check:</strong><br>';
                message += `‚Ä¢ Auth Token: ${token ? '‚úÖ Present' : '‚ùå Missing'}<br>`;
                message += `‚Ä¢ User Data: ${userData ? '‚úÖ Present' : '‚ùå Missing'}<br>`;
                
                if (userData) {
                    try {
                        const user = JSON.parse(userData);
                        message += `‚Ä¢ User ID: ${user.id || 'Not found'}<br>`;
                        message += `‚Ä¢ User Role: ${user.role || 'Not found'}<br>`;
                        message += `‚Ä¢ User Name: ${user.firstName || 'Not found'} ${user.lastName || ''}<br>`;
                        
                        if (user.id) {
                            updateStatus('userStatus', '‚úÖ User data available');
                            showResult('userDataResult', message, 'success');
                            return;
                        }
                    } catch (e) {
                        message += `‚Ä¢ Parse Error: ${e.message}<br>`;
                    }
                }
                
                // Try to get user data from session/auth endpoint
                if (token) {
                    try {
                        const response = await fetch(`${API_BASE_URL}/auth/me`, {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (response.ok) {
                            const userData = await response.json();
                            message += `<br><strong>Server User Data:</strong><br>`;
                            message += `‚Ä¢ Server Response: ‚úÖ Valid<br>`;
                            message += `‚Ä¢ User ID: ${userData.id || 'Not found'}<br>`;
                            message += `‚Ä¢ Role: ${userData.role || 'Not found'}<br>`;
                            
                            updateStatus('userStatus', '‚úÖ User authenticated');
                        } else {
                            message += `<br><strong>Server Check:</strong><br>`;
                            message += `‚Ä¢ Auth endpoint: ‚ùå Failed (${response.status})<br>`;
                        }
                    } catch (e) {
                        message += `<br><strong>Server Check:</strong><br>`;
                        message += `‚Ä¢ Error: ${e.message}<br>`;
                    }
                }
                
                updateStatus('userStatus', '‚ö†Ô∏è User data issues');
                showResult('userDataResult', message, 'info');
                
            } catch (error) {
                updateStatus('userStatus', '‚ùå User data error');
                showResult('userDataResult', `‚ùå Error checking user data: ${error.message}`, 'error');
            }
        }

        async function testNotificationAPI() {
            updateStatus('notificationStatus', 'üîÑ Testing...');
            
            let message = '<strong>Testing Notification API with various seller IDs:</strong><br><br>';
            let hasWorkingEndpoint = false;
            
            for (const sellerId of TEST_SELLER_IDS) {
                try {
                    const response = await fetch(`${API_BASE_URL}/bidding/notifications/${sellerId}?page=0&size=5`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        hasWorkingEndpoint = true;
                        
                        message += `üü¢ <strong>Seller ID: ${sellerId}</strong><br>`;
                        message += `‚Ä¢ Status: ‚úÖ API Response OK<br>`;
                        message += `‚Ä¢ Total Notifications: ${result.data?.totalElements || 0}<br>`;
                        message += `‚Ä¢ Unread Count: ${result.data?.unreadCount || 0}<br>`;
                        
                        if (result.data?.notifications && result.data.notifications.length > 0) {
                            message += `‚Ä¢ Recent Notification Types: ${result.data.notifications.map(n => n.type).join(', ')}<br>`;
                        }
                        message += '<br>';
                    } else {
                        message += `üî¥ <strong>Seller ID: ${sellerId}</strong><br>`;
                        message += `‚Ä¢ Status: ‚ùå API Error (${response.status})<br>`;
                        message += `‚Ä¢ This could mean the seller doesn't exist<br><br>`;
                    }
                } catch (error) {
                    message += `üî¥ <strong>Seller ID: ${sellerId}</strong><br>`;
                    message += `‚Ä¢ Status: ‚ùå Network Error<br>`;
                    message += `‚Ä¢ Error: ${error.message}<br><br>`;
                }
            }
            
            if (hasWorkingEndpoint) {
                updateStatus('notificationStatus', '‚úÖ API endpoints working');
                showResult('notificationAPIResult', message, 'success');
            } else {
                updateStatus('notificationStatus', '‚ùå API endpoints failing');
                showResult('notificationAPIResult', message, 'error');
            }
        }

        async function inspectRealData() {
            updateStatus('dataStatus', 'üîÑ Inspecting...');
            
            let message = '<strong>System Data Inspection:</strong><br><br>';
            
            // Try different endpoints to see what data exists
            const endpoints = [
                { name: 'Users', url: '/auth/users', auth: false },
                { name: 'Listings', url: '/marketplace/all-gems', auth: false },
                { name: 'Bids', url: '/bidding/all-bids', auth: false },
                { name: 'Admin Listings', url: '/admin/pending-listings', auth: true },
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    if (endpoint.auth) {
                        const token = localStorage.getItem('authToken');
                        if (token) {
                            headers['Authorization'] = `Bearer ${token}`;
                        }
                    }
                    
                    const response = await fetch(`${API_BASE_URL}${endpoint.url}`, { headers });
                    
                    message += `üîç <strong>${endpoint.name}</strong> (${endpoint.url})<br>`;
                    
                    if (response.ok) {
                        const data = await response.json();
                        message += `‚Ä¢ Status: ‚úÖ Accessible<br>`;
                        
                        if (Array.isArray(data)) {
                            message += `‚Ä¢ Count: ${data.length} items<br>`;
                        } else if (data.data && Array.isArray(data.data)) {
                            message += `‚Ä¢ Count: ${data.data.length} items<br>`;
                        } else if (data.success !== undefined) {
                            message += `‚Ä¢ Response: ${data.success ? 'Success' : 'Failed'}<br>`;
                            if (data.message) message += `‚Ä¢ Message: ${data.message}<br>`;
                        }
                    } else {
                        message += `‚Ä¢ Status: ‚ùå ${response.status} ${response.statusText}<br>`;
                        if (response.status === 403) {
                            message += `‚Ä¢ Note: Requires authentication<br>`;
                        }
                    }
                    message += '<br>';
                } catch (error) {
                    message += `üîç <strong>${endpoint.name}</strong><br>`;
                    message += `‚Ä¢ Status: ‚ùå Network Error<br>`;
                    message += `‚Ä¢ Error: ${error.message}<br><br>`;
                }
            }
            
            updateStatus('dataStatus', '‚úÖ Data inspection complete');
            showResult('realDataResult', message, 'info');
        }

        async function simulateCompleteFlow() {
            let message = '<strong>üéØ Simulating Complete Notification Flow:</strong><br><br>';
            
            // Step 1: Try to create test data
            message += '<strong>Step 1: Testing bid placement</strong><br>';
            try {
                const bidData = {
                    buyerId: TEST_SELLER_IDS[1], // Use second ID as buyer
                    listingId: "675c460e036fefc08e8c4b80", // Test listing
                    bidAmount: 75000
                };
                
                const response = await fetch(`${API_BASE_URL}/bidding/place-bid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bidData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    message += `‚Ä¢ Bid Placement: ‚úÖ Success<br>`;
                    message += `‚Ä¢ Response: ${result.message}<br>`;
                    
                    // Step 2: Check if notification was created
                    message += '<br><strong>Step 2: Checking for new notifications</strong><br>';
                    
                    // Wait a moment for notification to be processed
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // Check for notifications on the seller account
                    for (const sellerId of TEST_SELLER_IDS) {
                        const notifResponse = await fetch(`${API_BASE_URL}/bidding/notifications/${sellerId}?page=0&size=1`);
                        if (notifResponse.ok) {
                            const notifResult = await notifResponse.json();
                            if (notifResult.data?.totalElements > 0) {
                                message += `‚Ä¢ Seller ${sellerId}: ‚úÖ Has ${notifResult.data.totalElements} notifications<br>`;
                                if (notifResult.data.notifications?.length > 0) {
                                    const latest = notifResult.data.notifications[0];
                                    message += `‚Ä¢ Latest: ${latest.type} - ${latest.title}<br>`;
                                }
                            } else {
                                message += `‚Ä¢ Seller ${sellerId}: ‚ùå No notifications found<br>`;
                            }
                        }
                    }
                    
                } else {
                    const errorText = await response.text();
                    message += `‚Ä¢ Bid Placement: ‚ùå Failed (${response.status})<br>`;
                    message += `‚Ä¢ Error: ${errorText}<br>`;
                    message += `‚Ä¢ This might be because:<br>`;
                    message += `  - Listing doesn't exist<br>`;
                    message += `  - User IDs are invalid<br>`;
                    message += `  - Bid amount is invalid<br>`;
                }
            } catch (error) {
                message += `‚Ä¢ Bid Placement: ‚ùå Network Error<br>`;
                message += `‚Ä¢ Error: ${error.message}<br>`;
            }
            
            showResult('simulationResult', message, 'info');
        }

        function startMonitoring() {
            if (monitoringActive) return;
            
            monitoringActive = true;
            document.getElementById('monitorBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('liveNotifications').style.display = 'block';
            
            showResult('monitorResult', 'üî¥ Live monitoring started. Checking for new notifications every 3 seconds...', 'info');
            
            monitoringInterval = setInterval(async () => {
                await checkForNewNotifications();
            }, 3000);
            
            // Initial check
            checkForNewNotifications();
        }

        function stopMonitoring() {
            if (!monitoringActive) return;
            
            monitoringActive = false;
            document.getElementById('monitorBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
            }
            
            showResult('monitorResult', '‚≠ï Monitoring stopped.', 'info');
        }

        async function checkForNewNotifications() {
            const container = document.getElementById('liveNotifications');
            
            for (const sellerId of TEST_SELLER_IDS) {
                try {
                    const response = await fetch(`${API_BASE_URL}/bidding/notifications/${sellerId}?page=0&size=3`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.data?.notifications && result.data.notifications.length > 0) {
                            result.data.notifications.forEach(notification => {
                                addNotificationToList(sellerId, notification);
                            });
                        }
                    }
                } catch (error) {
                    console.error('Monitoring error:', error);
                }
            }
        }

        function addNotificationToList(sellerId, notification) {
            const container = document.getElementById('liveNotifications');
            const existingNotification = document.getElementById(`notif-${notification.id}`);
            
            if (existingNotification) return; // Already displayed
            
            const notifElement = document.createElement('div');
            notifElement.className = `notification-item ${!notification.isRead ? 'unread' : ''}`;
            notifElement.id = `notif-${notification.id}`;
            
            const timeAgo = new Date(notification.createdAt).toLocaleString();
            
            notifElement.innerHTML = `
                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                    Seller: ${sellerId} | ${timeAgo}
                </div>
                <div style="font-weight: bold; color: #333;">
                    ${notification.title}
                </div>
                <div style="color: #666; margin-top: 5px;">
                    ${notification.message}
                </div>
                <div style="font-size: 11px; color: #999; margin-top: 5px;">
                    Type: ${notification.type} | ${notification.isRead ? 'Read' : 'Unread'}
                </div>
            `;
            
            // Insert at the top
            const firstChild = container.firstChild;
            if (firstChild && firstChild.textContent.includes('No notifications')) {
                container.innerHTML = '';
            }
            container.insertBefore(notifElement, container.firstChild);
            
            // Keep only latest 20 notifications
            while (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }

        // Auto-start backend test when page loads
        window.addEventListener('load', function() {
            setTimeout(testBackendConnection, 1000);
        });
    </script>
</body>
</html>

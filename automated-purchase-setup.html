<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Purchase History Setup</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .button.success {
            background: #28a745;
        }
        .button.warning {
            background: #ffc107;
            color: #212529;
        }
        .results {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid #007bff;
        }
        .step {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .step.completed {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }
        .step.error {
            background: #ffebee;
            border-left-color: #f44336;
        }
    </style>
</head>
<body>
    <h1>üöÄ Automated Purchase History Setup</h1>
    <p>This tool automatically creates test purchase data using existing API endpoints</p>

    <div class="section">
        <h3>üìã Step-by-Step Process</h3>
        <div id="step1" class="step">
            <strong>Step 1:</strong> Get active listings for testing
            <button class="button" onclick="executeStep1()">Execute Step 1</button>
        </div>
        <div id="step2" class="step">
            <strong>Step 2:</strong> Place a test bid on selected listing
            <button class="button" onclick="executeStep2()">Execute Step 2</button>
        </div>
        <div id="step3" class="step">
            <strong>Step 3:</strong> Reduce countdown to make bid expire immediately
            <button class="button" onclick="executeStep3()">Execute Step 3</button>
        </div>
        <div id="step4" class="step">
            <strong>Step 4:</strong> Process expired bids to complete the purchase
            <button class="button" onclick="executeStep4()">Execute Step 4</button>
        </div>
        <div id="step5" class="step">
            <strong>Step 5:</strong> Verify purchase appears in history
            <button class="button" onclick="executeStep5()">Execute Step 5</button>
        </div>
    </div>

    <div class="section">
        <h3>‚ö° Quick Actions</h3>
        <button class="button success" onclick="runFullProcess()">üöÄ Run Complete Process</button>
        <button class="button warning" onclick="resetSteps()">üîÑ Reset Steps</button>
        <button class="button" onclick="checkCurrentStatus()">üìä Check Current Status</button>
    </div>

    <div class="section">
        <h3>üìä Results</h3>
        <div id="main-results" class="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9092/api';
        const TEST_USER = 'pasindu@gmail.com';
        let selectedListing = null;
        let processSteps = {
            step1: false,
            step2: false,
            step3: false,
            step4: false,
            step5: false
        };

        function updateStepStatus(step, status, message = '') {
            const stepDiv = document.getElementById(step);
            processSteps[step] = status;
            
            if (status) {
                stepDiv.className = 'step completed';
                if (message) {
                    stepDiv.innerHTML = stepDiv.innerHTML.split('<div')[0] + `<div style="margin-top:10px; color: green;">${message}</div>`;
                }
            } else {
                stepDiv.className = 'step error';
                if (message) {
                    stepDiv.innerHTML = stepDiv.innerHTML.split('<div')[0] + `<div style="margin-top:10px; color: red;">${message}</div>`;
                }
            }
        }

        function logResult(message) {
            const resultsDiv = document.getElementById('main-results');
            const timestamp = new Date().toLocaleTimeString();
            resultsDiv.textContent += `[${timestamp}] ${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        async function executeStep1() {
            logResult('üîÑ Step 1: Getting active listings...');
            
            try {
                const response = await fetch(`${API_BASE}/marketplace/listings?page=0&size=5`);
                const result = await response.json();
                
                if (result.success && result.data.listings.length > 0) {
                    const activeListings = result.data.listings.filter(l => l.listingStatus === 'active');
                    
                    if (activeListings.length > 0) {
                        selectedListing = activeListings[0];
                        logResult(`‚úÖ Step 1: Found ${activeListings.length} active listings`);
                        logResult(`Selected: ${selectedListing.gemName} (${selectedListing.id})`);
                        updateStepStatus('step1', true, `Selected: ${selectedListing.gemName}`);
                        return true;
                    } else {
                        logResult('‚ùå Step 1: No active listings found');
                        updateStepStatus('step1', false, 'No active listings found');
                        return false;
                    }
                } else {
                    logResult('‚ùå Step 1: Failed to get listings');
                    updateStepStatus('step1', false, 'Failed to get listings');
                    return false;
                }
            } catch (error) {
                logResult(`‚ùå Step 1: Error - ${error.message}`);
                updateStepStatus('step1', false, error.message);
                return false;
            }
        }

        async function executeStep2() {
            if (!selectedListing) {
                logResult('‚ùå Step 2: No listing selected. Run Step 1 first.');
                updateStepStatus('step2', false, 'No listing selected');
                return false;
            }

            logResult('üîÑ Step 2: Placing test bid...');
            
            try {
                const bidAmount = (selectedListing.startingPrice || 50000) + 10000; // Bid higher than starting price
                
                const bidRequest = {
                    listingId: selectedListing.id,
                    userId: TEST_USER,
                    bidAmount: bidAmount
                };

                const response = await fetch(`${API_BASE}/bidding/place-bid`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(bidRequest)
                });

                const result = await response.json();
                
                if (result.success) {
                    logResult(`‚úÖ Step 2: Bid placed successfully - LKR ${bidAmount}`);
                    updateStepStatus('step2', true, `Bid: LKR ${bidAmount}`);
                    return true;
                } else {
                    logResult(`‚ùå Step 2: Failed to place bid - ${result.message}`);
                    updateStepStatus('step2', false, result.message);
                    return false;
                }
            } catch (error) {
                logResult(`‚ùå Step 2: Error - ${error.message}`);
                updateStepStatus('step2', false, error.message);
                return false;
            }
        }

        async function executeStep3() {
            if (!selectedListing) {
                logResult('‚ùå Step 3: No listing selected');
                updateStepStatus('step3', false, 'No listing selected');
                return false;
            }

            logResult('üîÑ Step 3: Reducing countdown to expire bid...');
            
            try {
                // Try to reduce countdown by a large amount to make it expire
                const response = await fetch(`${API_BASE}/bidding/testing/reduce-countdown/${selectedListing.id}?reduceByMinutes=10000`, {
                    method: 'POST'
                });

                if (response.status === 404) {
                    // Endpoint doesn't exist, skip this step
                    logResult('‚ö†Ô∏è Step 3: Countdown reduction endpoint not available (OK, skipping)');
                    updateStepStatus('step3', true, 'Skipped (endpoint not available)');
                    return true;
                }

                const result = await response.json();
                
                if (result.success) {
                    logResult('‚úÖ Step 3: Countdown reduced successfully');
                    updateStepStatus('step3', true, 'Countdown expired');
                    return true;
                } else {
                    logResult(`‚ö†Ô∏è Step 3: ${result.message} (OK, continuing)`);
                    updateStepStatus('step3', true, 'Continuing without countdown reduction');
                    return true;
                }
            } catch (error) {
                logResult(`‚ö†Ô∏è Step 3: ${error.message} (OK, continuing)`);
                updateStepStatus('step3', true, 'Continuing without countdown reduction');
                return true;
            }
        }

        async function executeStep4() {
            logResult('üîÑ Step 4: Processing expired bids...');
            
            try {
                const response = await fetch(`${API_BASE}/bidding/process-expired`, {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (result.success) {
                    const completedCount = result.data.completedCount;
                    logResult(`‚úÖ Step 4: Processed expired bids - ${completedCount} completed`);
                    
                    if (completedCount > 0) {
                        updateStepStatus('step4', true, `${completedCount} bids completed`);
                        return true;
                    } else {
                        // Even if no bids were completed, this step is successful
                        updateStepStatus('step4', true, 'No expired bids to process');
                        return true;
                    }
                } else {
                    logResult(`‚ùå Step 4: Failed - ${result.message}`);
                    updateStepStatus('step4', false, result.message);
                    return false;
                }
            } catch (error) {
                logResult(`‚ùå Step 4: Error - ${error.message}`);
                updateStepStatus('step4', false, error.message);
                return false;
            }
        }

        async function executeStep5() {
            logResult('üîÑ Step 5: Checking purchase history...');
            
            try {
                const response = await fetch(`${API_BASE}/bidding/purchase-history/${TEST_USER}`);
                const result = await response.json();
                
                if (result.success) {
                    const purchaseCount = result.data.length;
                    logResult(`‚úÖ Step 5: Purchase history checked - ${purchaseCount} purchases found`);
                    
                    if (purchaseCount > 0) {
                        result.data.forEach((purchase, index) => {
                            logResult(`  Purchase ${index + 1}: ${purchase.gemName} - LKR ${purchase.finalPrice}`);
                        });
                        updateStepStatus('step5', true, `${purchaseCount} purchases found`);
                        
                        logResult('üéâ SUCCESS! Purchase history now has data!');
                        logResult('Go to the buyer dashboard to see the purchases.');
                        
                        return true;
                    } else {
                        logResult('‚ÑπÔ∏è Step 5: No purchases found yet');
                        updateStepStatus('step5', false, 'No purchases found');
                        return false;
                    }
                } else {
                    logResult(`‚ùå Step 5: Failed - ${result.message}`);
                    updateStepStatus('step5', false, result.message);
                    return false;
                }
            } catch (error) {
                logResult(`‚ùå Step 5: Error - ${error.message}`);
                updateStepStatus('step5', false, error.message);
                return false;
            }
        }

        async function runFullProcess() {
            logResult('üöÄ Starting complete purchase history setup process...');
            resetSteps();
            
            try {
                // Execute steps sequentially
                const step1Success = await executeStep1();
                if (!step1Success) return;
                
                await new Promise(r => setTimeout(r, 1000)); // Wait 1 second
                
                const step2Success = await executeStep2();
                if (!step2Success) return;
                
                await new Promise(r => setTimeout(r, 1000)); // Wait 1 second
                
                const step3Success = await executeStep3();
                if (!step3Success) return;
                
                await new Promise(r => setTimeout(r, 2000)); // Wait 2 seconds
                
                const step4Success = await executeStep4();
                if (!step4Success) return;
                
                await new Promise(r => setTimeout(r, 1000)); // Wait 1 second
                
                const step5Success = await executeStep5();
                
                if (step5Success) {
                    logResult('');
                    logResult('üéâ COMPLETE SUCCESS! üéâ');
                    logResult('The purchase history should now show purchased items.');
                    logResult('Open the buyer dashboard to verify the results.');
                    logResult('');
                } else {
                    logResult('');
                    logResult('‚ö†Ô∏è Process completed but no purchases found.');
                    logResult('You may need to manually update the database.');
                    logResult('');
                }
                
            } catch (error) {
                logResult(`‚ùå Process failed: ${error.message}`);
            }
        }

        function resetSteps() {
            Object.keys(processSteps).forEach(step => {
                const stepDiv = document.getElementById(step);
                stepDiv.className = 'step';
                // Remove any status messages
                stepDiv.innerHTML = stepDiv.innerHTML.split('<div')[0];
                processSteps[step] = false;
            });
            selectedListing = null;
        }

        async function checkCurrentStatus() {
            logResult('üìä Checking current system status...');
            
            try {
                // Check marketplace
                const marketplaceResponse = await fetch(`${API_BASE}/marketplace/listings?page=0&size=10`);
                const marketplaceResult = await marketplaceResponse.json();
                
                if (marketplaceResult.success) {
                    const listings = marketplaceResult.data.listings;
                    const soldItems = listings.filter(l => l.listingStatus === 'sold');
                    const activeItems = listings.filter(l => l.listingStatus === 'active');
                    
                    logResult(`Marketplace: ${activeItems.length} active, ${soldItems.length} sold`);
                }
                
                // Check purchase history
                const purchaseResponse = await fetch(`${API_BASE}/bidding/purchase-history/${TEST_USER}`);
                const purchaseResult = await purchaseResponse.json();
                
                if (purchaseResult.success) {
                    logResult(`Purchase History: ${purchaseResult.data.length} purchases for ${TEST_USER}`);
                }
                
            } catch (error) {
                logResult(`Status check error: ${error.message}`);
            }
        }

        // Auto-check status on page load
        window.addEventListener('load', () => {
            setTimeout(checkCurrentStatus, 1000);
        });
    </script>
</body>
</html>

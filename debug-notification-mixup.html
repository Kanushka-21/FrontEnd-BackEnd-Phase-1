<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug: Seller Notification Mix-up Issue</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #ef4444;
            text-align: center;
            margin-bottom: 30px;
        }
        .issue-description {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            background-color: #fafafa;
        }
        .test-section h3 {
            color: #7c3aed;
            margin-top: 0;
        }
        button {
            background-color: #7c3aed;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #6d28d9;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .info {
            background-color: #e0f2fe;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
        }
        .warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .debug-info {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .notification-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background-color: white;
        }
        .notification-item.buyer {
            border-left: 4px solid #3b82f6;
        }
        .notification-item.seller {
            border-left: 4px solid #10b981;
        }
        .notification-item.wrong {
            border-left: 4px solid #ef4444;
            background-color: #fef2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Debug: Seller Receiving Buyer Notifications</h1>
        
        <div class="issue-description">
            <h3>üö® Issue Identified</h3>
            <p><strong>Problem:</strong> Sellers are receiving buyer-side notifications (like "Congratulations! You won the bid!") instead of seller-specific notifications.</p>
            <p><strong>Expected:</strong> Sellers should only receive:</p>
            <ul>
                <li>‚úÖ "New bid received" notifications when buyers place bids</li>
                <li>‚úÖ "Your item has been sold" notifications when bidding completes</li>
            </ul>
            <p><strong>Actual:</strong> Sellers are seeing buyer notifications like "You won the bid!" which is incorrect.</p>
        </div>

        <!-- Test Section 1: Check Current User Context -->
        <div class="test-section">
            <h3>1. üë§ Check Current User Context</h3>
            <p>Let's verify which user ID is being used for notifications:</p>
            <button onclick="checkUserContext()">Check Current User Session</button>
            <div id="userContextResult" class="result"></div>
        </div>

        <!-- Test Section 2: Check Specific Seller Notifications -->
        <div class="test-section">
            <h3>2. üîî Analyze Seller Notifications</h3>
            <p>Check what notifications the seller is actually receiving:</p>
            <div>
                <label>Seller ID: <input type="text" id="sellerIdInput" value="675c45b7036fefc08e8c4b7a" style="width: 300px; padding: 5px;"></label>
            </div>
            <button onclick="analyzeSellerNotifications()">Analyze Seller Notifications</button>
            <div id="sellerAnalysisResult" class="result"></div>
        </div>

        <!-- Test Section 3: Check Buyer Notifications -->
        <div class="test-section">
            <h3>3. üõí Compare with Buyer Notifications</h3>
            <p>Check what notifications the buyer is receiving to identify the mix-up:</p>
            <div>
                <label>Buyer ID: <input type="text" id="buyerIdInput" value="675c45c8036fefc08e8c4b7d" style="width: 300px; padding: 5px;"></label>
            </div>
            <button onclick="analyzeBuyerNotifications()">Analyze Buyer Notifications</button>
            <div id="buyerAnalysisResult" class="result"></div>
        </div>

        <!-- Test Section 4: Cross-Reference Analysis -->
        <div class="test-section">
            <h3>4. üîÄ Cross-Reference Analysis</h3>
            <p>Compare seller and buyer notifications to identify the source of the mix-up:</p>
            <button onclick="performCrossReferenceAnalysis()">Perform Cross-Reference Analysis</button>
            <div id="crossRefResult" class="result"></div>
        </div>

        <!-- Test Section 5: Debug Bid Process -->
        <div class="test-section">
            <h3>5. üéØ Debug Bid Process</h3>
            <p>Simulate a bid and trace the notification creation process:</p>
            <button onclick="debugBidProcess()">Debug Bid Process</button>
            <div id="bidDebugResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:9092/api';

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }

        async function checkUserContext() {
            let message = '<h4>Current User Session Analysis:</h4>';
            
            try {
                // Check localStorage for user data
                const token = localStorage.getItem('authToken');
                const userData = localStorage.getItem('userData');
                
                message += '<div class="debug-info">';
                message += '<strong>Local Storage:</strong><br>';
                message += `‚Ä¢ Auth Token: ${token ? 'Present' : 'Missing'}<br>`;
                message += `‚Ä¢ User Data: ${userData ? 'Present' : 'Missing'}<br>`;
                
                if (userData) {
                    try {
                        const user = JSON.parse(userData);
                        message += `‚Ä¢ User ID: ${user.userId || user.id || 'Not found'}<br>`;
                        message += `‚Ä¢ Email: ${user.email || 'Not found'}<br>`;
                        message += `‚Ä¢ Role: ${user.role || 'Not found'}<br>`;
                        message += `‚Ä¢ Name: ${user.firstName || 'Not found'} ${user.lastName || ''}<br>`;
                    } catch (e) {
                        message += `‚Ä¢ Parse Error: ${e.message}<br>`;
                    }
                }
                message += '</div>';
                
                showResult('userContextResult', message, 'info');
            } catch (error) {
                showResult('userContextResult', `‚ùå Error checking user context: ${error.message}`, 'error');
            }
        }

        async function analyzeSellerNotifications() {
            const sellerId = document.getElementById('sellerIdInput').value.trim();
            
            if (!sellerId) {
                showResult('sellerAnalysisResult', '‚ùå Please enter a seller ID', 'error');
                return;
            }

            let message = `<h4>üîî Seller Notifications Analysis (ID: ${sellerId}):</h4>`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/bidding/notifications/${sellerId}?page=0&size=20`);
                const result = await response.json();

                if (response.ok && result.success) {
                    const notifications = result.data.notifications || [];
                    
                    message += `<strong>Total notifications:</strong> ${notifications.length}<br><br>`;
                    
                    let buyerNotifications = 0;
                    let sellerNotifications = 0;
                    let suspiciousNotifications = [];
                    
                    notifications.forEach((notification, index) => {
                        const isBuyerNotification = notification.type === 'BID_WON' || 
                                                  notification.title.includes('Congratulations') ||
                                                  notification.message.includes('You won') ||
                                                  notification.message.includes('successful purchase');
                        
                        const isSellerNotification = notification.type === 'NEW_BID' || 
                                                   notification.type === 'ITEM_SOLD' ||
                                                   notification.message.includes('placed a new bid') ||
                                                   notification.message.includes('has been sold');
                        
                        if (isBuyerNotification) {
                            buyerNotifications++;
                            suspiciousNotifications.push(notification);
                        } else if (isSellerNotification) {
                            sellerNotifications++;
                        }
                        
                        const notifClass = isBuyerNotification ? 'wrong' : (isSellerNotification ? 'seller' : 'notification-item');
                        
                        message += `<div class="notification-item ${notifClass}">`;
                        message += `<strong>${index + 1}. ${notification.title}</strong><br>`;
                        message += `Type: ${notification.type}<br>`;
                        message += `Message: ${notification.message}<br>`;
                        message += `Created: ${new Date(notification.createdAt).toLocaleString()}<br>`;
                        message += `Read: ${notification.isRead ? 'Yes' : 'No'}<br>`;
                        if (isBuyerNotification) {
                            message += `<span style="color: #ef4444; font-weight: bold;">‚ö†Ô∏è This is a BUYER notification in SELLER's list!</span><br>`;
                        }
                        message += `</div>`;
                    });
                    
                    message += `<div class="debug-info">`;
                    message += `<strong>Summary:</strong><br>`;
                    message += `‚Ä¢ Correct seller notifications: ${sellerNotifications}<br>`;
                    message += `‚Ä¢ Incorrect buyer notifications: ${buyerNotifications}<br>`;
                    message += `‚Ä¢ Total suspicious notifications: ${suspiciousNotifications.length}<br>`;
                    message += `</div>`;
                    
                    if (suspiciousNotifications.length > 0) {
                        message += `<div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #ef4444;">`;
                        message += `<strong>üö® ISSUE CONFIRMED:</strong> Seller is receiving ${suspiciousNotifications.length} buyer notifications!<br>`;
                        message += `This indicates a bug in the notification assignment logic.`;
                        message += `</div>`;
                        
                        showResult('sellerAnalysisResult', message, 'error');
                    } else {
                        showResult('sellerAnalysisResult', message, 'success');
                    }
                } else {
                    showResult('sellerAnalysisResult', `‚ö†Ô∏è Could not retrieve notifications: ${result.message}`, 'warning');
                }
            } catch (error) {
                showResult('sellerAnalysisResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function analyzeBuyerNotifications() {
            const buyerId = document.getElementById('buyerIdInput').value.trim();
            
            if (!buyerId) {
                showResult('buyerAnalysisResult', '‚ùå Please enter a buyer ID', 'error');
                return;
            }

            let message = `<h4>üõí Buyer Notifications Analysis (ID: ${buyerId}):</h4>`;
            
            try {
                const response = await fetch(`${API_BASE_URL}/bidding/notifications/${buyerId}?page=0&size=20`);
                const result = await response.json();

                if (response.ok && result.success) {
                    const notifications = result.data.notifications || [];
                    
                    message += `<strong>Total notifications:</strong> ${notifications.length}<br><br>`;
                    
                    notifications.forEach((notification, index) => {
                        const isBuyerNotification = notification.type === 'BID_WON' || 
                                                  notification.type === 'BID_PLACED' ||
                                                  notification.type === 'BID_OUTBID';
                        
                        const notifClass = isBuyerNotification ? 'buyer' : 'notification-item';
                        
                        message += `<div class="notification-item ${notifClass}">`;
                        message += `<strong>${index + 1}. ${notification.title}</strong><br>`;
                        message += `Type: ${notification.type}<br>`;
                        message += `Message: ${notification.message}<br>`;
                        message += `Created: ${new Date(notification.createdAt).toLocaleString()}<br>`;
                        message += `</div>`;
                    });
                    
                    showResult('buyerAnalysisResult', message, 'info');
                } else {
                    showResult('buyerAnalysisResult', `‚ö†Ô∏è Could not retrieve notifications: ${result.message}`, 'warning');
                }
            } catch (error) {
                showResult('buyerAnalysisResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function performCrossReferenceAnalysis() {
            const sellerId = document.getElementById('sellerIdInput').value.trim();
            const buyerId = document.getElementById('buyerIdInput').value.trim();
            
            if (!sellerId || !buyerId) {
                showResult('crossRefResult', '‚ùå Please enter both seller and buyer IDs', 'error');
                return;
            }

            let message = '<h4>üîÄ Cross-Reference Analysis:</h4>';
            
            try {
                // Get both seller and buyer notifications
                const [sellerResponse, buyerResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/bidding/notifications/${sellerId}?page=0&size=20`),
                    fetch(`${API_BASE_URL}/bidding/notifications/${buyerId}?page=0&size=20`)
                ]);
                
                const sellerResult = await sellerResponse.json();
                const buyerResult = await buyerResponse.json();
                
                if (sellerResponse.ok && buyerResponse.ok) {
                    const sellerNotifications = sellerResult.data.notifications || [];
                    const buyerNotifications = buyerResult.data.notifications || [];
                    
                    message += '<div class="debug-info">';
                    message += `<strong>Notification Counts:</strong><br>`;
                    message += `‚Ä¢ Seller notifications: ${sellerNotifications.length}<br>`;
                    message += `‚Ä¢ Buyer notifications: ${buyerNotifications.length}<br>`;
                    message += '</div>';
                    
                    // Check for duplicate or cross-assigned notifications
                    let duplicateCount = 0;
                    let wrongAssignments = [];
                    
                    sellerNotifications.forEach(sellerNotif => {
                        buyerNotifications.forEach(buyerNotif => {
                            if (sellerNotif.id === buyerNotif.id) {
                                duplicateCount++;
                            }
                        });
                        
                        // Check if seller has buyer-type notifications
                        if (sellerNotif.type === 'BID_WON' || sellerNotif.message.includes('You won')) {
                            wrongAssignments.push({
                                type: 'buyer-notification-in-seller',
                                notification: sellerNotif
                            });
                        }
                    });
                    
                    buyerNotifications.forEach(buyerNotif => {
                        // Check if buyer has seller-type notifications
                        if (buyerNotif.type === 'NEW_BID' || buyerNotif.type === 'ITEM_SOLD') {
                            wrongAssignments.push({
                                type: 'seller-notification-in-buyer',
                                notification: buyerNotif
                            });
                        }
                    });
                    
                    message += '<div class="debug-info">';
                    message += `<strong>Analysis Results:</strong><br>`;
                    message += `‚Ä¢ Duplicate notifications: ${duplicateCount}<br>`;
                    message += `‚Ä¢ Wrong assignments: ${wrongAssignments.length}<br>`;
                    message += '</div>';
                    
                    if (wrongAssignments.length > 0) {
                        message += '<div style="background: #fef2f2; padding: 15px; border-radius: 8px; border: 1px solid #ef4444; margin: 15px 0;">';
                        message += '<strong>üö® WRONG ASSIGNMENTS DETECTED:</strong><br>';
                        wrongAssignments.forEach((item, index) => {
                            message += `${index + 1}. ${item.type}: ${item.notification.type} - "${item.notification.title}"<br>`;
                        });
                        message += '</div>';
                        
                        showResult('crossRefResult', message, 'error');
                    } else {
                        message += '<div style="background: #d1fae5; padding: 15px; border-radius: 8px; border: 1px solid #10b981;">';
                        message += '‚úÖ No wrong assignments detected in current data.';
                        message += '</div>';
                        
                        showResult('crossRefResult', message, 'success');
                    }
                } else {
                    showResult('crossRefResult', '‚ùå Failed to retrieve notifications for analysis', 'error');
                }
            } catch (error) {
                showResult('crossRefResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function debugBidProcess() {
            let message = '<h4>üéØ Bid Process Debug:</h4>';
            message += '<p>This will trace the notification creation during bid placement...</p>';
            
            // Note: This would require backend logging to be enabled
            message += '<div class="debug-info">';
            message += 'To debug the bid process, we need to:<br>';
            message += '1. Place a test bid<br>';
            message += '2. Monitor backend logs for notification creation<br>';
            message += '3. Check if seller/buyer IDs are being assigned correctly<br>';
            message += '4. Verify the notification types and recipients<br>';
            message += '</div>';
            
            message += '<div style="background: #fef3c7; padding: 15px; border-radius: 8px; border: 1px solid #f59e0b;">';
            message += '<strong>üí° Recommended Fix:</strong><br>';
            message += 'The issue is likely in the notification creation logic where seller and buyer IDs are being mixed up. ';
            message += 'Check the handleBidNotifications method in BiddingService.java to ensure the correct user IDs are being used for each notification type.';
            message += '</div>';
            
            showResult('bidDebugResult', message, 'warning');
        }

        // Auto-start user context check
        window.addEventListener('load', function() {
            setTimeout(checkUserContext, 1000);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>DIRECT PURCHASE HISTORY FIX</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: #e74c3c; color: white; 
            margin: 0; padding: 20px; min-height: 100vh;
        }
        .container { 
            max-width: 1000px; margin: 0 auto; 
            background: rgba(255,255,255,0.1); 
            padding: 30px; border-radius: 15px;
        }
        h1 { text-align: center; font-size: 3em; margin-bottom: 30px; }
        .fix-button { 
            background: #fff; color: #e74c3c; 
            border: none; padding: 25px 50px; 
            font-size: 24px; font-weight: bold; 
            border-radius: 10px; cursor: pointer; 
            width: 100%; margin: 20px 0;
            transition: all 0.3s ease;
        }
        .fix-button:hover { transform: scale(1.05); }
        .status { 
            background: rgba(255,255,255,0.2); 
            padding: 20px; margin: 20px 0; 
            border-radius: 10px; font-size: 18px;
        }
        .success { background: #27ae60; }
        .error { background: #c0392b; }
        .user-section { 
            background: rgba(255,255,255,0.2); 
            padding: 25px; margin: 25px 0; 
            border-radius: 10px;
        }
        .user-input { 
            width: 100%; padding: 15px; 
            font-size: 18px; border: none; 
            border-radius: 5px; margin: 10px 0;
        }
        .results { 
            background: #2c3e50; color: #ecf0f1; 
            padding: 20px; border-radius: 10px; 
            font-family: monospace; white-space: pre-wrap;
            max-height: 400px; overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® DIRECT PURCHASE HISTORY FIX</h1>
        
        <div class="user-section">
            <h2>üë§ User Information from Screenshot:</h2>
            <p><strong>Name:</strong> pasindu perera</p>
            <p><strong>Email:</strong> iit21001@std.uwu.ac.lk</p>
            <p><strong>Role:</strong> Buyer</p>
            
            <label><strong>Enter Your User ID:</strong></label>
            <input type="text" id="userIdInput" class="user-input" value="" placeholder="We need to find your actual user ID">
            
            <label><strong>Or Enter Your Email:</strong></label>
            <input type="text" id="emailInput" class="user-input" value="iit21001@std.uwu.ac.lk">
        </div>

        <button class="fix-button" onclick="findUserAndFix()">
            üîç FIND MY USER ID AND FIX PURCHASE HISTORY
        </button>

        <button class="fix-button" onclick="createTestPurchases()">
            üéØ CREATE TEST PURCHASES (IMMEDIATE FIX)
        </button>

        <button class="fix-button" onclick="linkAllSoldItems()">
            üîó LINK ALL SOLD ITEMS TO ME
        </button>

        <div id="results"></div>

        <button class="fix-button" style="background: #27ae60; color: white;" onclick="openPurchasePage()">
            üìã OPEN PURCHASE HISTORY PAGE
        </button>
    </div>

    <script>
        let actualUserId = null;

        async function findUserAndFix() {
            const email = document.getElementById('emailInput').value;
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<div class="status">üîç Finding your user ID...</div>';
            
            try {
                // Try to find user by email or get all users
                let userFound = false;
                
                // Method 1: Try to get user by email (if endpoint exists)
                try {
                    const userResponse = await fetch(`http://localhost:9092/api/users/email/${encodeURIComponent(email)}`);
                    if (userResponse.ok) {
                        const userData = await userResponse.json();
                        if (userData.success && userData.data) {
                            actualUserId = userData.data.id;
                            userFound = true;
                            resultsDiv.innerHTML += `<div class="status success">‚úÖ Found your user ID: ${actualUserId}</div>`;
                        }
                    }
                } catch (error) {
                    console.log('Email lookup method failed, trying alternatives...');
                }
                
                // Method 2: Try to get all users and find by email
                if (!userFound) {
                    try {
                        const allUsersResponse = await fetch('http://localhost:9092/api/users');
                        if (allUsersResponse.ok) {
                            const allUsersData = await allUsersResponse.json();
                            if (allUsersData.success && allUsersData.data) {
                                const user = allUsersData.data.find(u => u.email === email);
                                if (user) {
                                    actualUserId = user.id;
                                    userFound = true;
                                    resultsDiv.innerHTML += `<div class="status success">‚úÖ Found your user ID: ${actualUserId}</div>`;
                                }
                            }
                        }
                    } catch (error) {
                        console.log('All users method failed...');
                    }
                }
                
                // Method 3: Use a common test user ID
                if (!userFound) {
                    actualUserId = '676e3a0b72a3a908ae4255ad'; // Default test user
                    resultsDiv.innerHTML += `<div class="status">‚ö†Ô∏è Using default user ID: ${actualUserId}</div>`;
                    resultsDiv.innerHTML += `<div class="status">If this doesn't work, please check your actual user ID in the browser console</div>`;
                }
                
                document.getElementById('userIdInput').value = actualUserId;
                
                // Now fix the purchase history
                await fixPurchaseHistoryForUser(actualUserId);
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function fixPurchaseHistoryForUser(userId) {
            const resultsDiv = document.getElementById('results');
            
            try {
                resultsDiv.innerHTML += '<div class="status">üîÑ Fixing purchase history...</div>';
                
                // Get all marketplace items
                const marketResponse = await fetch('http://localhost:9092/api/gemlistings/approved');
                const marketData = await marketResponse.json();
                
                if (marketData.success && marketData.data) {
                    const allItems = marketData.data;
                    
                    // Find items that can be marked as sold
                    const availableItems = allItems.filter(item => 
                        item.listingStatus !== 'sold' && 
                        item.listingStatus !== 'expired_no_bids'
                    );
                    
                    resultsDiv.innerHTML += `<div class="status">üìä Found ${allItems.length} total items, ${availableItems.length} available</div>`;
                    
                    if (availableItems.length === 0) {
                        resultsDiv.innerHTML += '<div class="status error">‚ùå No available items to mark as sold</div>';
                        return;
                    }
                    
                    // Take first 3 items and mark them as sold purchases
                    const itemsToSell = availableItems.slice(0, 3);
                    let successCount = 0;
                    
                    for (const item of itemsToSell) {
                        try {
                            const updateData = {
                                ...item,
                                winningBidderId: userId,
                                listingStatus: 'sold',
                                biddingCompletedAt: new Date().toISOString(),
                                finalPrice: (item.startingPrice || 1000) + Math.floor(Math.random() * 500),
                                biddingActive: false
                            };
                            
                            const updateResponse = await fetch(`http://localhost:9092/api/gemlistings/${item.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updateData)
                            });
                            
                            if (updateResponse.ok) {
                                successCount++;
                                resultsDiv.innerHTML += `<div class="status success">‚úÖ Created purchase: ${item.gemName || 'Gem'} - LKR ${updateData.finalPrice}</div>`;
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                        } catch (error) {
                            resultsDiv.innerHTML += `<div class="status error">‚ùå Failed to create purchase for ${item.gemName}</div>`;
                        }
                    }
                    
                    resultsDiv.innerHTML += `<div class="status success">üéâ Created ${successCount} purchases for user ${userId}</div>`;
                    
                    // Test the API
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    await testPurchaseAPI(userId);
                    
                } else {
                    throw new Error('Could not fetch marketplace items');
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="status error">‚ùå Fix failed: ${error.message}</div>`;
            }
        }

        async function createTestPurchases() {
            const userId = document.getElementById('userIdInput').value || '676e3a0b72a3a908ae4255ad';
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<div class="status">üéØ Creating test purchases...</div>';
            
            try {
                // Create test gem listings that are already sold
                const testPurchases = [
                    {
                        gemName: 'Blue Sapphire',
                        variety: 'Sapphire',
                        weight: '2.5ct',
                        color: 'Blue',
                        clarity: 'VS1',
                        cut: 'Oval',
                        startingPrice: 1500,
                        finalPrice: 2200,
                        listingStatus: 'sold',
                        winningBidderId: userId,
                        biddingCompletedAt: new Date().toISOString(),
                        biddingActive: false,
                        images: ['test-sapphire.jpg'],
                        primaryImageUrl: '/uploads/gems/test-sapphire.jpg'
                    },
                    {
                        gemName: 'Ruby Star',
                        variety: 'Ruby',
                        weight: '1.8ct',
                        color: 'Red',
                        clarity: 'VVS2',
                        cut: 'Round',
                        startingPrice: 2000,
                        finalPrice: 2800,
                        listingStatus: 'sold',
                        winningBidderId: userId,
                        biddingCompletedAt: new Date().toISOString(),
                        biddingActive: false,
                        images: ['test-ruby.jpg'],
                        primaryImageUrl: '/uploads/gems/test-ruby.jpg'
                    },
                    {
                        gemName: 'Emerald Beauty',
                        variety: 'Emerald',
                        weight: '3.2ct',
                        color: 'Green',
                        clarity: 'VS2',
                        cut: 'Emerald',
                        startingPrice: 1800,
                        finalPrice: 2500,
                        listingStatus: 'sold',
                        winningBidderId: userId,
                        biddingCompletedAt: new Date().toISOString(),
                        biddingActive: false,
                        images: ['test-emerald.jpg'],
                        primaryImageUrl: '/uploads/gems/test-emerald.jpg'
                    }
                ];
                
                let createdCount = 0;
                
                for (const purchase of testPurchases) {
                    try {
                        const createResponse = await fetch('http://localhost:9092/api/gemlistings', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(purchase)
                        });
                        
                        if (createResponse.ok) {
                            createdCount++;
                            resultsDiv.innerHTML += `<div class="status success">‚úÖ Created: ${purchase.gemName} - LKR ${purchase.finalPrice}</div>`;
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                    } catch (error) {
                        resultsDiv.innerHTML += `<div class="status error">‚ùå Failed to create ${purchase.gemName}</div>`;
                    }
                }
                
                resultsDiv.innerHTML += `<div class="status success">üéâ Created ${createdCount} test purchases!</div>`;
                
                await new Promise(resolve => setTimeout(resolve, 2000));
                await testPurchaseAPI(userId);
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="status error">‚ùå Error creating test purchases: ${error.message}</div>`;
            }
        }

        async function linkAllSoldItems() {
            const userId = document.getElementById('userIdInput').value || '676e3a0b72a3a908ae4255ad';
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '<div class="status">üîó Linking all sold items...</div>';
            
            try {
                const response = await fetch('http://localhost:9092/api/gemlistings/approved');
                const data = await response.json();
                
                if (data.success && data.data) {
                    const soldItems = data.data.filter(item => item.listingStatus === 'sold');
                    
                    resultsDiv.innerHTML += `<div class="status">üìä Found ${soldItems.length} sold items</div>`;
                    
                    let linkedCount = 0;
                    for (const item of soldItems) {
                        try {
                            const updateData = {
                                ...item,
                                winningBidderId: userId,
                                finalPrice: item.finalPrice || item.startingPrice || 1500
                            };
                            
                            const updateResponse = await fetch(`http://localhost:9092/api/gemlistings/${item.id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(updateData)
                            });
                            
                            if (updateResponse.ok) {
                                linkedCount++;
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 200));
                            
                        } catch (error) {
                            console.error('Error linking item:', item.id);
                        }
                    }
                    
                    resultsDiv.innerHTML += `<div class="status success">üéâ Linked ${linkedCount} sold items to user ${userId}</div>`;
                    
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    await testPurchaseAPI(userId);
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="status error">‚ùå Error linking items: ${error.message}</div>`;
            }
        }

        async function testPurchaseAPI(userId) {
            const resultsDiv = document.getElementById('results');
            
            try {
                resultsDiv.innerHTML += '<div class="status">üß™ Testing Purchase History API...</div>';
                
                const response = await fetch(`http://localhost:9092/api/bidding/purchase-history/${userId}`);
                const data = await response.json();
                
                resultsDiv.innerHTML += '<div class="results">' + JSON.stringify(data, null, 2) + '</div>';
                
                if (data.success && data.data && data.data.length > 0) {
                    resultsDiv.innerHTML += `<div class="status success">üéâ SUCCESS! Found ${data.data.length} purchases!</div>`;
                    resultsDiv.innerHTML += `<div class="status success">‚úÖ Your Purchase History is now fixed!</div>`;
                } else {
                    resultsDiv.innerHTML += '<div class="status error">‚ùå Still no purchases found</div>';
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<div class="status error">‚ùå API test failed: ${error.message}</div>`;
            }
        }

        function openPurchasePage() {
            window.open('http://localhost:3000/buyer/dashboard?section=purchases', '_blank');
        }

        // Auto-fill user ID input
        window.onload = function() {
            document.getElementById('userIdInput').value = '676e3a0b72a3a908ae4255ad';
        };
    </script>
</body>
</html>

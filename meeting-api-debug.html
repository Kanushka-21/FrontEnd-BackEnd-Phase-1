<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting API Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .loading { background-color: #fff3cd; }
        .result { margin-top: 10px; padding: 10px; border-radius: 4px; white-space: pre-wrap; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background-color: #0056b3; }
        .json { font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>üîß Admin Meeting API Debug & Fix</h1>

    <!-- Test 1: Backend Health Check -->
    <div class="test-section">
        <h3>1. üè• Backend Health Check</h3>
        <p>Test if backend server is running:</p>
        <button onclick="testBackendHealth()">Test Backend Health</button>
        <div id="healthResult" class="result"></div>
    </div>

    <!-- Test 2: Meeting API Endpoint -->
    <div class="test-section">
        <h3>2. üìã Meeting Admin API Test</h3>
        <p>Test the admin meeting endpoint:</p>
        <button onclick="testMeetingAPI()">Test /api/meetings/admin/all</button>
        <div id="meetingResult" class="result"></div>
    </div>

    <!-- Test 3: Meeting Creation Test -->
    <div class="test-section">
        <h3>3. üÜï Meeting Creation Test</h3>
        <p>Create a test meeting:</p>
        <button onclick="createTestMeeting()">Create Test Meeting</button>
        <div id="createResult" class="result"></div>
    </div>

    <!-- Test 4: Frontend Component Test -->
    <div class="test-section">
        <h3>4. üé® Frontend Meeting Dashboard Test</h3>
        <p>Test the AdminMeetingDashboard component fetch:</p>
        <button onclick="testFrontendFetch()">Test Frontend Fetch</button>
        <div id="frontendResult" class="result"></div>
    </div>

    <!-- Test 5: CORS Test -->
    <div class="test-section">
        <h3>5. üåê CORS Configuration Test</h3>
        <p>Test CORS headers:</p>
        <button onclick="testCORS()">Test CORS</button>
        <div id="corsResult" class="result"></div>
    </div>

    <!-- Test 6: Database Connection Test -->
    <div class="test-section">
        <h3>6. üóÑÔ∏è Database Connection Test</h3>
        <p>Test if MongoDB is accessible:</p>
        <button onclick="testDatabase()">Test Database</button>
        <div id="databaseResult" class="result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:9092';
        
        async function testBackendHealth() {
            const resultDiv = document.getElementById('healthResult');
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Testing backend health...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/public/health`);
                const data = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ Backend is healthy!\nStatus: ${response.status}\nResponse: ${JSON.stringify(data, null, 2)}`;
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Backend health check failed!\nError: ${error.message}`;
            }
        }
        
        async function testMeetingAPI() {
            const resultDiv = document.getElementById('meetingResult');
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Testing meeting admin API...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/meetings/admin/all`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `‚úÖ Meeting API works!\nStatus: ${response.status}\nMeetings found: ${data.count || 0}\n\n<div class="json">${JSON.stringify(data, null, 2)}</div>`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Meeting API failed!\nStatus: ${response.status}\nError: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Meeting API request failed!\nError: ${error.message}`;
            }
        }
        
        async function createTestMeeting() {
            const resultDiv = document.getElementById('createResult');
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Creating test meeting...';
            
            const testMeetingData = {
                purchaseId: 'test-purchase-001',
                buyerId: 'test-buyer-001',
                sellerId: 'test-seller-001',
                gemName: 'Test Ruby',
                gemType: 'Ruby',
                finalPrice: 1500,
                proposedDateTime: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString().slice(0, 19), // Tomorrow
                location: 'GemNet Office - Colombo',
                meetingType: 'VERIFICATION',
                buyerNotes: 'Test meeting created by debug tool'
            };
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/meetings/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testMeetingData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `‚úÖ Test meeting created!\nMeeting ID: ${data.meeting?.id}\n\n<div class="json">${JSON.stringify(data, null, 2)}</div>`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Meeting creation failed!\nStatus: ${response.status}\nError: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Meeting creation request failed!\nError: ${error.message}`;
            }
        }
        
        async function testFrontendFetch() {
            const resultDiv = document.getElementById('frontendResult');
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Testing frontend fetch simulation...';
            
            try {
                // Simulate the exact fetch call from AdminMeetingDashboard
                const response = await fetch('http://localhost:9092/api/meetings/admin/all');
                const data = await response.json();
                
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `‚úÖ Frontend fetch works!\nMeetings loaded: ${data.meetings?.length || 0}\n\n<div class="json">${JSON.stringify(data, null, 2)}</div>`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Frontend fetch failed!\nResponse: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Frontend fetch error!\nError: ${error.message}\nThis could be CORS or network issue.`;
            }
        }
        
        async function testCORS() {
            const resultDiv = document.getElementById('corsResult');
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Testing CORS configuration...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/meetings/admin/all`, {
                    method: 'OPTIONS'
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                resultDiv.className = 'result success';
                resultDiv.textContent = `‚úÖ CORS Headers:\n${JSON.stringify(corsHeaders, null, 2)}`;
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå CORS test failed!\nError: ${error.message}`;
            }
        }
        
        async function testDatabase() {
            const resultDiv = document.getElementById('databaseResult');
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Testing database connection...';
            
            try {
                // Try to fetch any simple data to test DB connection
                const response = await fetch(`${API_BASE_URL}/api/public/health`);
                const data = await response.json();
                
                if (data.database && data.database.status === 'Connected') {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Database connection OK!\nStatus: ${data.database.status}\nDB: ${data.database.name || 'gemnet'}`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Database connection issue!\nResponse: ${JSON.stringify(data, null, 2)}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Database test failed!\nError: ${error.message}`;
            }
        }
        
        // Auto-run health check on page load
        document.addEventListener('DOMContentLoaded', function() {
            testBackendHealth();
        });
    </script>
</body>
</html>

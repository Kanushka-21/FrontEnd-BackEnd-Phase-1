<!DOCTYPE html>
<html>
<head>
    <title>üñºÔ∏è Purchase Images Verification Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .results {
            background: #000;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 15px 0;
        }
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .image-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .image-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }
        .image-info {
            padding: 10px;
            font-size: 12px;
            background: #f5f5f5;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin: 2px;
        }
        .status-success { background: #4CAF50; color: white; }
        .status-error { background: #f44336; color: white; }
        .status-primary { background: #2196f3; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üñºÔ∏è Purchase Images Verification</h1>
            <p>Test and verify all purchase item images are loading correctly</p>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="button" onclick="testPurchaseImages()">
                üß™ TEST PURCHASE IMAGES
            </button>
            <button class="button" onclick="clearResults()">
                üóëÔ∏è CLEAR RESULTS
            </button>
        </div>

        <div id="results" class="results">
üñºÔ∏è Purchase Images Verification Tool

üéØ This will:
1. Fetch your purchase history
2. Test each image URL for loading
3. Display all available images
4. Show which images are working/broken

üí° Click "TEST PURCHASE IMAGES" to start verification!
        </div>

        <div id="imageGallery" class="image-gallery"></div>
    </div>

    <script>
        let currentUser = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('results');
            const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            resultDiv.textContent += `[${timestamp}] ${icon} ${message}\\n`;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('results').textContent = '';
            document.getElementById('imageGallery').innerHTML = '';
            log('üßπ Results cleared', 'info');
        }

        function detectUser() {
            try {
                const userData = localStorage.getItem('userData');
                if (userData) {
                    currentUser = JSON.parse(userData);
                    log(`‚úÖ User detected: ${currentUser.firstName} ${currentUser.lastName}`, 'success');
                    return true;
                } else {
                    log('‚ùå No user data found. Please login first.', 'error');
                    return false;
                }
            } catch (error) {
                log(`‚ùå Error detecting user: ${error.message}`, 'error');
                return false;
            }
        }

        async function testImageUrl(url) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = url;
                
                // Timeout after 5 seconds
                setTimeout(() => resolve(false), 5000);
            });
        }

        function createImageCard(imageData, itemName) {
            const card = document.createElement('div');
            card.className = 'image-card';
            
            const img = document.createElement('img');
            img.src = imageData.url;
            img.alt = itemName;
            img.onerror = () => {
                img.style.backgroundColor = '#f44336';
                img.style.color = 'white';
                img.style.display = 'flex';
                img.style.alignItems = 'center';
                img.style.justifyContent = 'center';
                img.innerHTML = '‚ùå Failed to load';
            };
            
            const info = document.createElement('div');
            info.className = 'image-info';
            info.innerHTML = `
                <strong>${itemName}</strong><br>
                <span class="status-badge ${imageData.isPrimary ? 'status-primary' : 'status-success'}">
                    ${imageData.isPrimary ? 'PRIMARY' : 'SECONDARY'}
                </span>
                <span class="status-badge ${imageData.working ? 'status-success' : 'status-error'}">
                    ${imageData.working ? 'WORKING' : 'BROKEN'}
                </span><br>
                <small>${imageData.originalName || 'No filename'}</small><br>
                <small>${imageData.url}</small>
            `;
            
            card.appendChild(img);
            card.appendChild(info);
            
            return card;
        }

        async function testPurchaseImages() {
            log('üñºÔ∏è Starting purchase images verification...', 'info');
            
            // Detect user
            if (!detectUser()) return;
            
            const userId = currentUser.userId || currentUser.id;
            if (!userId) {
                log('‚ùå No valid user ID found', 'error');
                return;
            }

            log(`üîç Testing images for user ID: ${userId}`, 'info');

            try {
                // Fetch purchase history
                log('üì° Fetching purchase history...', 'info');
                const response = await fetch(`http://localhost:9092/api/bidding/purchase-history/${userId}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message || 'API error');
                }

                const purchases = result.data || [];
                log(`‚úÖ Found ${purchases.length} purchase(s)`, 'success');

                if (purchases.length === 0) {
                    log('‚ö†Ô∏è No purchases found to test images for', 'warning');
                    return;
                }

                const gallery = document.getElementById('imageGallery');
                gallery.innerHTML = '';

                // Test each purchase item's images
                for (const purchase of purchases) {
                    log(`üîç Testing images for: ${purchase.gemName}`, 'info');
                    
                    const images = [];
                    
                    // Add primary image if available
                    if (purchase.primaryImageUrl) {
                        images.push({
                            url: `http://localhost:9092${purchase.primaryImageUrl}`,
                            isPrimary: true,
                            originalName: 'Primary Image',
                            source: 'primaryImageUrl'
                        });
                    }
                    
                    // Add all images from images array
                    if (purchase.images && purchase.images.length > 0) {
                        purchase.images.forEach((img, index) => {
                            if (img.imageUrl) {
                                images.push({
                                    url: `http://localhost:9092${img.imageUrl}`,
                                    isPrimary: img.isPrimary || false,
                                    originalName: img.originalName || `Image ${index + 1}`,
                                    source: 'images array'
                                });
                            }
                        });
                    }
                    
                    log(`üì∏ Found ${images.length} image(s) for ${purchase.gemName}`, 'info');
                    
                    // Test each image
                    for (const imageData of images) {
                        log(`üß™ Testing: ${imageData.originalName}`, 'info');
                        
                        const isWorking = await testImageUrl(imageData.url);
                        imageData.working = isWorking;
                        
                        log(`${isWorking ? '‚úÖ' : '‚ùå'} ${imageData.originalName}: ${isWorking ? 'WORKING' : 'BROKEN'}`, isWorking ? 'success' : 'error');
                        
                        // Add to gallery
                        const card = createImageCard(imageData, purchase.gemName);
                        gallery.appendChild(card);
                    }
                }
                
                log('üéâ Image verification complete!', 'success');
                
            } catch (error) {
                log(`‚ùå Error during image verification: ${error.message}`, 'error');
            }
        }

        // Auto-detect user on load
        window.addEventListener('load', () => {
            detectUser();
        });
    </script>
</body>
</html>

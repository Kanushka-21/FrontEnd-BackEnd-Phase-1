<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Countdown ‚Üí SOLD Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-button.success {
            background: #28a745;
        }
        .test-button.warning {
            background: #ffc107;
            color: #212529;
        }
        .test-button.danger {
            background: #dc3545;
        }
        .results {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            border-left: 4px solid #007bff;
        }
        .step {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
            background: #f8fff9;
        }
        .step.pending {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        .step.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .countdown-display {
            font-size: 18px;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        .countdown-active {
            background: #e3f2fd;
            color: #1976d2;
        }
        .countdown-sold {
            background: #e8f5e8;
            color: #2e7d32;
            font-weight: bold;
        }
        .countdown-expired {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <h1>üéØ Countdown ‚Üí SOLD Flow Test</h1>
    <p>This tests the complete flow: Countdown expires ‚Üí Item marked as SOLD ‚Üí Shows SOLD badge ‚Üí Appears in purchase history</p>

    <div class="test-section">
        <h3>üìã Test Flow Steps</h3>
        <div id="step1" class="step pending">
            <strong>Step 1:</strong> Process expired bids to mark items as SOLD
            <button class="test-button" onclick="processExpiredBids()">Process Expired Bids</button>
        </div>
        <div id="step2" class="step pending">
            <strong>Step 2:</strong> Check marketplace for SOLD items with proper status
            <button class="test-button" onclick="checkMarketplaceSoldItems()">Check Marketplace</button>
        </div>
        <div id="step3" class="step pending">
            <strong>Step 3:</strong> Verify countdown status for SOLD items
            <button class="test-button" onclick="testCountdownStatus()">Test Countdown Status</button>
        </div>
        <div id="step4" class="step pending">
            <strong>Step 4:</strong> Check purchase history for winning bidders
            <button class="test-button" onclick="testPurchaseHistory()">Test Purchase History</button>
        </div>
    </div>

    <div class="test-section">
        <h3>üîÑ 1. Process Expired Bids</h3>
        <p>This will find expired countdown items and mark them as sold if they have winning bids</p>
        <button class="test-button" onclick="processExpiredBids()">Process All Expired Bids</button>
        <div id="process-results" class="results"></div>
    </div>

    <div class="test-section">
        <h3>üõí 2. Marketplace Status Check</h3>
        <p>Check which items are showing as SOLD in the marketplace</p>
        <button class="test-button" onclick="checkMarketplaceSoldItems()">Check Marketplace</button>
        <div id="marketplace-results" class="results"></div>
    </div>

    <div class="test-section">
        <h3>‚è∞ 3. Countdown Status Test</h3>
        <p>Test the countdown API for SOLD items - they should return "biddingActive: false"</p>
        <input type="text" id="test-listing-id" placeholder="Enter listing ID to test" style="margin-right: 10px; padding: 8px;">
        <button class="test-button" onclick="testCountdownStatus()">Test Countdown</button>
        <div id="countdown-results" class="results"></div>
        <div id="countdown-display"></div>
    </div>

    <div class="test-section">
        <h3>üìã 4. Purchase History Verification</h3>
        <p>Check if sold items appear in buyer's purchase history</p>
        <input type="text" id="buyer-user-id" placeholder="Enter buyer user ID" style="margin-right: 10px; padding: 8px;" value="pasindu@gmail.com">
        <button class="test-button" onclick="testPurchaseHistory()">Get Purchase History</button>
        <div id="purchase-results" class="results"></div>
    </div>

    <div class="test-section">
        <h3>üéØ 5. End-to-End Test</h3>
        <p>Run complete test flow to verify everything works together</p>
        <button class="test-button success" onclick="runCompleteTest()">üöÄ Run Complete Test</button>
        <button class="test-button warning" onclick="clearAllResults()">üßπ Clear Results</button>
        <div id="complete-results" class="results"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9092/api';
        let testResults = {
            processExpired: false,
            marketplaceCheck: false,
            countdownStatus: false,
            purchaseHistory: false
        };

        function updateStepStatus(stepId, status, message = '') {
            const step = document.getElementById(stepId);
            step.className = `step ${status}`;
            if (message) {
                const existing = step.innerHTML;
                step.innerHTML = existing + `<div style="margin-top: 10px; font-style: italic;">${message}</div>`;
            }
        }

        async function processExpiredBids() {
            const resultsDiv = document.getElementById('process-results');
            resultsDiv.textContent = 'üîÑ Processing expired bids...';
            updateStepStatus('step1', 'pending', 'Processing...');
            
            try {
                const response = await fetch(`${API_BASE}/bidding/process-expired`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    const result = data.data;
                    let output = `‚úÖ STEP 1 COMPLETE - Expired Bids Processed:\n\n`;
                    output += `üìä Summary:\n`;
                    output += `  ‚Ä¢ Processed: ${result.processedCount} listings\n`;
                    output += `  ‚Ä¢ Completed: ${result.completedCount} transactions\n`;
                    output += `  ‚Ä¢ Completed Listings: ${result.completedListings.join(', ') || 'None'}\n\n`;
                    
                    if (result.completedCount > 0) {
                        output += `üéâ SUCCESS: ${result.completedCount} items marked as SOLD!\n`;
                        output += `These items should now:\n`;
                        output += `  ‚úì Show SOLD badges in marketplace\n`;
                        output += `  ‚úì Return biddingActive: false in countdown API\n`;
                        output += `  ‚úì Appear in winner's purchase history\n\n`;
                        
                        testResults.processExpired = true;
                        updateStepStatus('step1', '', `‚úÖ ${result.completedCount} items marked as SOLD`);
                    } else {
                        output += `‚ÑπÔ∏è No expired items with winning bids found to process.\n`;
                        output += `This could mean:\n`;
                        output += `  ‚Ä¢ No items have expired countdowns yet\n`;
                        output += `  ‚Ä¢ Expired items had no bids\n`;
                        output += `  ‚Ä¢ Items already processed previously\n`;
                        
                        updateStepStatus('step1', 'warning', 'No new items to process');
                    }
                    
                    resultsDiv.textContent = output;
                } else {
                    resultsDiv.textContent = `‚ùå Error: ${data.message}`;
                    updateStepStatus('step1', 'error', `Error: ${data.message}`);
                }
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå Error: ${error.message}`;
                updateStepStatus('step1', 'error', `Error: ${error.message}`);
            }
        }

        async function checkMarketplaceSoldItems() {
            const resultsDiv = document.getElementById('marketplace-results');
            resultsDiv.textContent = 'üîÑ Checking marketplace for sold items...';
            updateStepStatus('step2', 'pending', 'Checking...');
            
            try {
                const response = await fetch(`${API_BASE}/marketplace/listings?page=0&size=30`);
                const data = await response.json();
                
                if (data.success) {
                    const listings = data.data.listings;
                    const soldItems = listings.filter(l => l.listingStatus === 'sold');
                    const expiredItems = listings.filter(l => l.listingStatus === 'expired_no_bids');
                    const activeItems = listings.filter(l => l.listingStatus === 'active');
                    
                    let output = `‚úÖ STEP 2 COMPLETE - Marketplace Analysis:\n\n`;
                    output += `üìä Marketplace Status Breakdown:\n`;
                    output += `  üü¢ Active listings: ${activeItems.length}\n`;
                    output += `  üõë SOLD items: ${soldItems.length}\n`;
                    output += `  ‚è∞ Expired (no bids): ${expiredItems.length}\n`;
                    output += `  üìã Total listings: ${listings.length}\n\n`;
                    
                    if (soldItems.length > 0) {
                        output += `üõë SOLD ITEMS (should show SOLD badges in marketplace):\n`;
                        soldItems.forEach((item, index) => {
                            output += `\n${index + 1}. ${item.gemName || item.name}\n`;
                            output += `   üÜî ID: ${item.id}\n`;
                            output += `   üìä Status: ${item.listingStatus}\n`;
                            output += `   üèÜ Winner: ${item.winningBidderId || 'None'}\n`;
                            output += `   üí∞ Final Price: LKR ${item.finalPrice || 'N/A'}\n`;
                            output += `   ‚ö° Bidding Active: ${item.biddingActive}\n`;
                            output += `   üìÖ Completed: ${item.biddingCompletedAt || 'N/A'}\n`;
                        });
                        
                        output += `\n‚úÖ These ${soldItems.length} items should display SOLD badges in the marketplace!\n`;
                        testResults.marketplaceCheck = true;
                        updateStepStatus('step2', '', `‚úÖ Found ${soldItems.length} SOLD items`);
                    } else {
                        output += `‚ÑπÔ∏è No SOLD items found in marketplace.\n`;
                        output += `This could mean:\n`;
                        output += `  ‚Ä¢ No bids have been completed yet\n`;
                        output += `  ‚Ä¢ Need to process expired bids first\n`;
                        updateStepStatus('step2', 'warning', 'No SOLD items found');
                    }
                    
                    if (expiredItems.length > 0) {
                        output += `\n‚è∞ EXPIRED ITEMS (no bids, should show EXPIRED badges):\n`;
                        expiredItems.forEach((item, index) => {
                            output += `  ${index + 1}. ${item.gemName || item.name} (${item.id})\n`;
                        });
                    }
                    
                    resultsDiv.textContent = output;
                } else {
                    resultsDiv.textContent = `‚ùå Error: ${data.message}`;
                    updateStepStatus('step2', 'error', `Error: ${data.message}`);
                }
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå Error: ${error.message}`;
                updateStepStatus('step2', 'error', `Error: ${error.message}`);
            }
        }

        async function testCountdownStatus() {
            const listingId = document.getElementById('test-listing-id').value.trim();
            const resultsDiv = document.getElementById('countdown-results');
            const displayDiv = document.getElementById('countdown-display');
            
            if (!listingId) {
                // Get a sold item ID automatically
                try {
                    const response = await fetch(`${API_BASE}/marketplace/listings?page=0&size=10`);
                    const data = await response.json();
                    if (data.success) {
                        const soldItem = data.data.listings.find(l => l.listingStatus === 'sold');
                        if (soldItem) {
                            document.getElementById('test-listing-id').value = soldItem.id;
                            testCountdownStatusForId(soldItem.id);
                            return;
                        }
                    }
                } catch (e) {}
                
                resultsDiv.textContent = '‚ùå Please enter a listing ID or process expired bids first to get sold items';
                updateStepStatus('step3', 'error', 'No listing ID provided');
                return;
            }
            
            testCountdownStatusForId(listingId);
        }

        async function testCountdownStatusForId(listingId) {
            const resultsDiv = document.getElementById('countdown-results');
            const displayDiv = document.getElementById('countdown-display');
            
            resultsDiv.textContent = `üîÑ Testing countdown status for listing: ${listingId}...`;
            updateStepStatus('step3', 'pending', 'Testing...');
            
            try {
                const response = await fetch(`${API_BASE}/bidding/countdown-status/${listingId}`);
                const data = await response.json();
                
                if (data.success) {
                    const status = data.data;
                    let output = `‚úÖ STEP 3 COMPLETE - Countdown Status Test:\n\n`;
                    output += `üÜî Listing ID: ${listingId}\n`;
                    output += `üìä Status Response:\n`;
                    output += `  ‚Ä¢ Bidding Active: ${status.biddingActive}\n`;
                    output += `  ‚Ä¢ Is Expired: ${status.isExpired}\n`;
                    output += `  ‚Ä¢ Remaining Time: ${status.remainingTimeSeconds}s\n`;
                    output += `  ‚Ä¢ Listing Status: ${status.listingStatus}\n`;
                    output += `  ‚Ä¢ Message: ${data.message}\n\n`;
                    
                    // Visual display
                    if (status.listingStatus === 'sold') {
                        displayDiv.innerHTML = `<div class="countdown-display countdown-sold">üõë SOLD - Bidding Closed</div>`;
                        output += `‚úÖ CORRECT: Item shows as SOLD with biddingActive: false\n`;
                        output += `This should display a SOLD badge in the marketplace!\n`;
                        testResults.countdownStatus = true;
                        updateStepStatus('step3', '', '‚úÖ Countdown correctly shows SOLD');
                    } else if (status.listingStatus === 'expired_no_bids') {
                        displayDiv.innerHTML = `<div class="countdown-display countdown-expired">‚è∞ EXPIRED - No Bids</div>`;
                        output += `‚úÖ CORRECT: Item shows as EXPIRED with no bids\n`;
                        updateStepStatus('step3', '', '‚úÖ Countdown correctly shows EXPIRED');
                    } else if (status.biddingActive) {
                        displayDiv.innerHTML = `<div class="countdown-display countdown-active">‚è∞ Active - ${Math.floor(status.remainingTimeSeconds / 3600)}h ${Math.floor((status.remainingTimeSeconds % 3600) / 60)}m remaining</div>`;
                        output += `‚ÑπÔ∏è Item is still active with countdown running\n`;
                        updateStepStatus('step3', 'warning', 'Item still active');
                    } else {
                        displayDiv.innerHTML = `<div class="countdown-display countdown-expired">‚ùì Unknown Status</div>`;
                        output += `‚ö†Ô∏è Unexpected status combination\n`;
                        updateStepStatus('step3', 'warning', 'Unexpected status');
                    }
                    
                    resultsDiv.textContent = output;
                } else {
                    resultsDiv.textContent = `‚ùå Error: ${data.message}`;
                    updateStepStatus('step3', 'error', `Error: ${data.message}`);
                }
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå Error: ${error.message}`;
                updateStepStatus('step3', 'error', `Error: ${error.message}`);
            }
        }

        async function testPurchaseHistory() {
            const userId = document.getElementById('buyer-user-id').value.trim();
            const resultsDiv = document.getElementById('purchase-results');
            
            if (!userId) {
                resultsDiv.textContent = '‚ùå Please enter a buyer user ID';
                updateStepStatus('step4', 'error', 'No user ID provided');
                return;
            }
            
            resultsDiv.textContent = `üîÑ Getting purchase history for: ${userId}...`;
            updateStepStatus('step4', 'pending', 'Checking...');
            
            try {
                const response = await fetch(`${API_BASE}/bidding/purchase-history/${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    const purchases = data.data;
                    let output = `‚úÖ STEP 4 COMPLETE - Purchase History Check:\n\n`;
                    output += `üë§ User: ${userId}\n`;
                    output += `üõí Total purchases: ${purchases.length}\n\n`;
                    
                    if (purchases.length > 0) {
                        output += `üéâ SUCCESS: Found ${purchases.length} purchased items!\n\n`;
                        output += `üìã Purchase Details:\n`;
                        purchases.forEach((purchase, index) => {
                            output += `\n${index + 1}. ${purchase.gemName}\n`;
                            output += `   üÜî ID: ${purchase.id}\n`;
                            output += `   üí∞ Final Price: LKR ${purchase.finalPrice}\n`;
                            output += `   üìÖ Purchase Date: ${purchase.purchaseDate}\n`;
                            output += `   üë§ Seller: ${purchase.sellerId}\n`;
                            output += `   üíé Type: ${purchase.gemType}\n`;
                            output += `   ‚öñÔ∏è Weight: ${purchase.weight}ct\n`;
                        });
                        
                        output += `\n‚úÖ These items should appear in the buyer's dashboard Purchase History section!\n`;
                        testResults.purchaseHistory = true;
                        updateStepStatus('step4', '', `‚úÖ Found ${purchases.length} purchases`);
                    } else {
                        output += `‚ÑπÔ∏è No purchases found for this user.\n\n`;
                        output += `Possible reasons:\n`;
                        output += `  ‚Ä¢ User hasn't won any bids yet\n`;
                        output += `  ‚Ä¢ Won bids haven't been processed (run Step 1)\n`;
                        output += `  ‚Ä¢ Using wrong user ID\n`;
                        output += `  ‚Ä¢ Check sold items for correct winningBidderId\n`;
                        updateStepStatus('step4', 'warning', 'No purchases found');
                    }
                    
                    resultsDiv.textContent = output;
                } else {
                    resultsDiv.textContent = `‚ùå Error: ${data.message}`;
                    updateStepStatus('step4', 'error', `Error: ${data.message}`);
                }
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå Error: ${error.message}`;
                updateStepStatus('step4', 'error', `Error: ${error.message}`);
            }
        }

        async function runCompleteTest() {
            const resultsDiv = document.getElementById('complete-results');
            resultsDiv.textContent = 'üöÄ Running complete end-to-end test...\n\n';
            
            // Reset test results
            testResults = {
                processExpired: false,
                marketplaceCheck: false,
                countdownStatus: false,
                purchaseHistory: false
            };
            
            try {
                resultsDiv.textContent += 'Step 1: Processing expired bids...\n';
                await processExpiredBids();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                resultsDiv.textContent += 'Step 2: Checking marketplace...\n';
                await checkMarketplaceSoldItems();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                resultsDiv.textContent += 'Step 3: Testing countdown status...\n';
                await testCountdownStatus();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                resultsDiv.textContent += 'Step 4: Checking purchase history...\n';
                await testPurchaseHistory();
                
                // Generate final report
                const passedTests = Object.values(testResults).filter(Boolean).length;
                const totalTests = Object.keys(testResults).length;
                
                let finalReport = `\n\nüéØ FINAL TEST REPORT:\n`;
                finalReport += `Tests Passed: ${passedTests}/${totalTests}\n\n`;
                
                finalReport += `‚úÖ Test Results:\n`;
                finalReport += `  ‚Ä¢ Process Expired: ${testResults.processExpired ? '‚úÖ PASS' : '‚ùå FAIL'}\n`;
                finalReport += `  ‚Ä¢ Marketplace Check: ${testResults.marketplaceCheck ? '‚úÖ PASS' : '‚ùå FAIL'}\n`;
                finalReport += `  ‚Ä¢ Countdown Status: ${testResults.countdownStatus ? '‚úÖ PASS' : '‚ùå FAIL'}\n`;
                finalReport += `  ‚Ä¢ Purchase History: ${testResults.purchaseHistory ? '‚úÖ PASS' : '‚ùå FAIL'}\n\n`;
                
                if (passedTests === totalTests) {
                    finalReport += `üéâ ALL TESTS PASSED!\n`;
                    finalReport += `The countdown ‚Üí SOLD flow is working correctly:\n`;
                    finalReport += `  ‚úì Expired items are marked as SOLD\n`;
                    finalReport += `  ‚úì SOLD items show proper badges in marketplace\n`;
                    finalReport += `  ‚úì Countdown API returns correct status\n`;
                    finalReport += `  ‚úì Purchases appear in buyer's history\n`;
                } else {
                    finalReport += `‚ö†Ô∏è Some tests failed. Check individual test results above.\n`;
                }
                
                resultsDiv.textContent += finalReport;
                
            } catch (error) {
                resultsDiv.textContent += `\n‚ùå Test suite error: ${error.message}`;
            }
        }

        function clearAllResults() {
            document.getElementById('process-results').textContent = '';
            document.getElementById('marketplace-results').textContent = '';
            document.getElementById('countdown-results').textContent = '';
            document.getElementById('purchase-results').textContent = '';
            document.getElementById('complete-results').textContent = '';
            document.getElementById('countdown-display').innerHTML = '';
            
            // Reset steps
            ['step1', 'step2', 'step3', 'step4'].forEach(stepId => {
                const step = document.getElementById(stepId);
                step.className = 'step pending';
                const content = step.innerHTML.split('<div style="margin-top: 10px;')[0];
                step.innerHTML = content;
            });
        }

        // Auto-run marketplace check on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkMarketplaceSoldItems();
            }, 1000);
        });
    </script>
</body>
</html>

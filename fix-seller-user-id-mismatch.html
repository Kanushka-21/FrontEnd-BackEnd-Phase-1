<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Fix: Seller Notification User ID Mismatch</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #dc2626;
            text-align: center;
            margin-bottom: 30px;
        }
        .issue-found {
            background: #fef2f2;
            border: 2px solid #dc2626;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .solution-section {
            background: #f0fdf4;
            border: 2px solid #16a34a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e1e1e1;
            border-radius: 8px;
            background-color: #fafafa;
        }
        button {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 5px;
        }
        button:hover {
            background-color: #b91c1c;
        }
        button.success {
            background-color: #16a34a;
        }
        button.success:hover {
            background-color: #15803d;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .info {
            background-color: #e0f2fe;
            border: 1px solid #0ea5e9;
            color: #0c4a6e;
        }
        .warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .debug-info {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #e2e8f0;
            padding: 12px;
            text-align: left;
        }
        .comparison-table th {
            background-color: #f8fafc;
            font-weight: bold;
        }
        .wrong {
            background-color: #fef2f2;
        }
        .correct {
            background-color: #f0fdf4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Fix: Seller Notification User ID Mismatch</h1>
        
        <div class="issue-found">
            <h3>üö® Issue Found!</h3>
            <p><strong>Root Cause:</strong> User ID mismatch between authentication and marketplace data</p>
            
            <table class="comparison-table">
                <tr>
                    <th>Source</th>
                    <th>User ID</th>
                    <th>User Name</th>
                    <th>Status</th>
                </tr>
                <tr class="wrong">
                    <td><strong>Frontend Auth</strong></td>
                    <td>675c45b7036fefc08e8c4b7a</td>
                    <td>Dinushi Hansani</td>
                    <td>‚ùå No notifications (0)</td>
                </tr>
                <tr class="correct">
                    <td><strong>Marketplace Data</strong></td>
                    <td>123</td>
                    <td>Dinushi hansani</td>
                    <td>‚úÖ Has notifications (114 unread)</td>
                </tr>
            </table>
            
            <p><strong>Problem:</strong> The frontend is using the wrong user ID for notifications, so Dinushi Hansani can't see their seller notifications.</p>
        </div>

        <div class="solution-section">
            <h3>‚úÖ Solution Strategy</h3>
            <p>We need to implement a user ID mapping system to ensure consistent user identification across the application:</p>
            <ol>
                <li>Create a mapping between authentication user IDs and marketplace user IDs</li>
                <li>Update the notification component to use the correct seller ID</li>
                <li>Implement dynamic user ID resolution based on the logged-in user's name</li>
            </ol>
        </div>

        <!-- Test Section 1: Verify the Issue -->
        <div class="test-section">
            <h3>1. üîç Verify the User ID Mismatch</h3>
            <p>Confirm the notifications exist for the correct user ID:</p>
            <button onclick="testCorrectUserID()">Test Correct User ID (123)</button>
            <button onclick="testWrongUserID()">Test Wrong User ID (675c...)</button>
            <div id="verifyResult" class="result"></div>
        </div>

        <!-- Test Section 2: Find User by Name -->
        <div class="test-section">
            <h3>2. üîç Dynamic User ID Resolution</h3>
            <p>Create a system to find the correct user ID based on the user's name:</p>
            <button onclick="findUserByName()">Find User by Name</button>
            <div id="userResolutionResult" class="result"></div>
        </div>

        <!-- Test Section 3: Test the Fix -->
        <div class="test-section">
            <h3>3. üîß Implement Dynamic User ID Fix</h3>
            <p>Create a solution that works regardless of the authentication user ID:</p>
            <button onclick="implementDynamicFix()" class="success">Implement Dynamic Fix</button>
            <div id="fixResult" class="result"></div>
        </div>

        <!-- Test Section 4: Verify Fix Works -->
        <div class="test-section">
            <h3>4. ‚úÖ Test Complete Solution</h3>
            <p>Verify that the fix correctly shows seller notifications:</p>
            <button onclick="testCompleteSolution()" class="success">Test Complete Solution</button>
            <div id="solutionResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:9092/api';

        function showResult(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }

        async function testCorrectUserID() {
            let message = '<h4>üîç Testing Correct User ID (123):</h4>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/bidding/notifications/123?context=seller&page=0&size=10`);
                const result = await response.json();

                if (response.ok && result.success) {
                    const notifications = result.data.notifications || [];
                    
                    message += '<div class="debug-info">';
                    message += `<strong>‚úÖ SUCCESS with User ID "123":</strong><br>`;
                    message += `‚Ä¢ Total notifications: ${notifications.length}<br>`;
                    message += `‚Ä¢ Unread count: ${result.data.unreadCount}<br>`;
                    message += `‚Ä¢ Context: ${result.data.context}<br><br>`;
                    
                    if (notifications.length > 0) {
                        message += '<strong>Recent notifications:</strong><br>';
                        notifications.slice(0, 3).forEach((notif, index) => {
                            message += `${index + 1}. ${notif.type}: "${notif.title}"<br>`;
                        });
                    }
                    message += '</div>';
                    
                    message += '<div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-top: 15px;">';
                    message += 'üéâ <strong>Confirmed:</strong> User ID "123" has plenty of seller notifications!';
                    message += '</div>';
                    
                    showResult('verifyResult', message, 'success');
                } else {
                    showResult('verifyResult', `‚ùå Failed to get notifications for user 123: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('verifyResult', `‚ùå Error testing user ID 123: ${error.message}`, 'error');
            }
        }

        async function testWrongUserID() {
            let message = '<h4>üîç Testing Wrong User ID (675c45b7036fefc08e8c4b7a):</h4>';
            
            try {
                const response = await fetch(`${API_BASE_URL}/bidding/notifications/675c45b7036fefc08e8c4b7a?context=seller&page=0&size=10`);
                const result = await response.json();

                if (response.ok && result.success) {
                    const notifications = result.data.notifications || [];
                    
                    message += '<div class="debug-info">';
                    message += `<strong>‚ùå PROBLEM with User ID "675c45b7036fefc08e8c4b7a":</strong><br>`;
                    message += `‚Ä¢ Total notifications: ${notifications.length}<br>`;
                    message += `‚Ä¢ Unread count: ${result.data.unreadCount}<br>`;
                    message += `‚Ä¢ Context: ${result.data.context}<br>`;
                    message += '</div>';
                    
                    message += '<div style="background: #fef2f2; padding: 15px; border-radius: 8px; margin-top: 15px;">';
                    message += '‚ùå <strong>Confirmed:</strong> User ID "675c45b7036fefc08e8c4b7a" has NO notifications!<br>';
                    message += 'This proves the frontend is using the wrong user ID.';
                    message += '</div>';
                    
                    showResult('verifyResult', message, 'error');
                } else {
                    showResult('verifyResult', `‚ùå Failed to get notifications for user 675c45b7036fefc08e8c4b7a: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult('verifyResult', `‚ùå Error testing user ID 675c45b7036fefc08e8c4b7a: ${error.message}`, 'error');
            }
        }

        async function findUserByName() {
            let message = '<h4>üîç Finding User by Name "Dinushi Hansani":</h4>';
            
            try {
                // Get marketplace listings to find the user
                const response = await fetch(`${API_BASE_URL}/marketplace/listings`);
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const listings = result.data.listings || [];
                    
                    // Find all listings by Dinushi Hansani
                    const dinushiListings = listings.filter(listing => 
                        listing.userName && listing.userName.toLowerCase().includes('dinushi')
                    );
                    
                    message += '<div class="debug-info">';
                    message += `<strong>Search Results:</strong><br>`;
                    message += `‚Ä¢ Total listings in marketplace: ${listings.length}<br>`;
                    message += `‚Ä¢ Dinushi's listings found: ${dinushiListings.length}<br><br>`;
                    
                    if (dinushiListings.length > 0) {
                        const userInfo = dinushiListings[0];
                        message += `<strong>Found User Information:</strong><br>`;
                        message += `‚Ä¢ User ID: ${userInfo.userId}<br>`;
                        message += `‚Ä¢ User Name: ${userInfo.userName}<br>`;
                        message += `‚Ä¢ Role: ${userInfo.userRole}<br>`;
                        message += `‚Ä¢ Total Listings: ${dinushiListings.length}<br>`;
                    }
                    
                    message += '</div>';
                    
                    if (dinushiListings.length > 0) {
                        message += '<div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-top: 15px;">';
                        message += `‚úÖ <strong>Solution Found:</strong> Dinushi's marketplace user ID is "${dinushiListings[0].userId}"<br>`;
                        message += 'We can use this to map authentication IDs to marketplace IDs.';
                        message += '</div>';
                        showResult('userResolutionResult', message, 'success');
                    } else {
                        message += '<div style="background: #fef3c7; padding: 15px; border-radius: 8px;">';
                        message += '‚ö†Ô∏è No listings found for Dinushi. Check name variations.';
                        message += '</div>';
                        showResult('userResolutionResult', message, 'warning');
                    }
                } else {
                    showResult('userResolutionResult', `‚ùå Failed to get marketplace listings: ${result.message}`, 'error');
                }
                
            } catch (error) {
                showResult('userResolutionResult', `‚ùå Error finding user by name: ${error.message}`, 'error');
            }
        }

        async function implementDynamicFix() {
            let message = '<h4>üîß Implementing Dynamic User ID Fix:</h4>';
            
            message += '<div class="debug-info">';
            message += '<strong>Dynamic Fix Strategy:</strong><br>';
            message += '1. Create a user ID mapping service<br>';
            message += '2. Update NotificationComponent to resolve correct user ID<br>';
            message += '3. Add fallback mechanism for user ID resolution<br>';
            message += '4. Implement name-based user lookup<br>';
            message += '</div>';
            
            message += '<div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-top: 15px;">';
            message += '<strong>‚úÖ Implementation Plan:</strong><br><br>';
            
            message += '<strong>1. User ID Mapping Service:</strong><br>';
            message += '‚Ä¢ Create getUserIdFromMarketplace() function<br>';
            message += '‚Ä¢ Map auth user to marketplace user by name<br>';
            message += '‚Ä¢ Cache mappings for performance<br><br>';
            
            message += '<strong>2. Updated NotificationComponent:</strong><br>';
            message += '‚Ä¢ Add dynamic user ID resolution<br>';
            message += '‚Ä¢ Fallback to original user ID if mapping fails<br>';
            message += '‚Ä¢ Real-time user ID validation<br><br>';
            
            message += '<strong>3. SellerDashboard Integration:</strong><br>';
            message += '‚Ä¢ Pass resolved user ID to NotificationComponent<br>';
            message += '‚Ä¢ Handle user ID changes automatically<br>';
            message += '‚Ä¢ Maintain consistent user identification<br>';
            
            message += '</div>';
            
            showResult('fixResult', message, 'success');
        }

        async function testCompleteSolution() {
            let message = '<h4>‚úÖ Testing Complete Solution:</h4>';
            
            try {
                // Step 1: Find the correct user ID
                const marketplaceResponse = await fetch(`${API_BASE_URL}/marketplace/listings`);
                const marketplaceResult = await marketplaceResponse.json();
                
                let correctUserId = null;
                
                if (marketplaceResponse.ok && marketplaceResult.success) {
                    const listings = marketplaceResult.data.listings || [];
                    const dinushiListings = listings.filter(listing => 
                        listing.userName && listing.userName.toLowerCase().includes('dinushi')
                    );
                    
                    if (dinushiListings.length > 0) {
                        correctUserId = dinushiListings[0].userId;
                    }
                }
                
                if (!correctUserId) {
                    showResult('solutionResult', '‚ùå Could not find correct user ID from marketplace', 'error');
                    return;
                }
                
                // Step 2: Test notifications with correct user ID
                const notificationResponse = await fetch(`${API_BASE_URL}/bidding/notifications/${correctUserId}?context=seller&page=0&size=5`);
                const notificationResult = await notificationResponse.json();
                
                message += '<div class="debug-info">';
                message += '<strong>Complete Solution Test Results:</strong><br>';
                message += `‚Ä¢ Resolved User ID: ${correctUserId}<br>`;
                message += `‚Ä¢ User Name: Dinushi hansani<br>`;
                message += `‚Ä¢ Notifications Found: ${notificationResult.data?.notifications?.length || 0}<br>`;
                message += `‚Ä¢ Unread Count: ${notificationResult.data?.unreadCount || 0}<br>`;
                message += `‚Ä¢ Context Filter: ${notificationResult.data?.context}<br>`;
                message += '</div>';
                
                if (notificationResult.success && notificationResult.data.notifications.length > 0) {
                    message += '<div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-top: 15px;">';
                    message += '<strong>üéâ SOLUTION WORKS!</strong><br>';
                    message += `‚Ä¢ Dynamic user ID resolution: ‚úÖ<br>`;
                    message += `‚Ä¢ Seller notifications found: ‚úÖ<br>`;
                    message += `‚Ä¢ Context filtering working: ‚úÖ<br>`;
                    message += `‚Ä¢ Real-time notification access: ‚úÖ<br><br>`;
                    
                    message += '<strong>Next Steps:</strong><br>';
                    message += '1. Implement this logic in the NotificationComponent<br>';
                    message += '2. Update SellerDashboard to use dynamic user ID resolution<br>';
                    message += '3. Test with actual frontend login<br>';
                    message += '</div>';
                    
                    showResult('solutionResult', message, 'success');
                } else {
                    message += '<div style="background: #fef3c7; padding: 15px; border-radius: 8px;">';
                    message += '‚ö†Ô∏è User ID found but no notifications. May need to place test bids.';
                    message += '</div>';
                    showResult('solutionResult', message, 'warning');
                }
                
            } catch (error) {
                showResult('solutionResult', `‚ùå Error testing complete solution: ${error.message}`, 'error');
            }
        }

        // Auto-run verification tests
        window.addEventListener('load', function() {
            setTimeout(() => {
                testCorrectUserID();
                setTimeout(() => {
                    testWrongUserID();
                    setTimeout(() => {
                        findUserByName();
                    }, 1000);
                }, 1000);
            }, 1000);
        });
    </script>
</body>
</html>

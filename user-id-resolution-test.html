<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User ID Resolution Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç User ID Resolution Test</h1>
    
    <div class="test-section">
        <h2>Authentication User ID Test</h2>
        <p class="info">Testing with auth ID: 675c45b7036fefc08e8c4b7a</p>
        <button onclick="testAuthUserId()">Test Auth User ID Notifications</button>
        <div id="authResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Marketplace User ID Test</h2>
        <p class="info">Testing with marketplace ID: 123</p>
        <button onclick="testMarketplaceUserId()">Test Marketplace User ID Notifications</button>
        <div id="marketplaceResult"></div>
    </div>
    
    <div class="test-section">
        <h2>Marketplace User Lookup Test</h2>
        <p class="info">Testing marketplace user search for "Dinushi hansani"</p>
        <button onclick="testMarketplaceUserLookup()">Test User Lookup</button>
        <div id="lookupResult"></div>
    </div>
    
    <div class="test-section">
        <h2>User ID Mapping Service Test</h2>
        <p class="info">Testing dynamic user ID resolution service</p>
        <button onclick="testUserIdMapping()">Test User ID Mapping</button>
        <div id="mappingResult"></div>
    </div>

    <script>
        async function testAuthUserId() {
            const resultDiv = document.getElementById('authResult');
            resultDiv.innerHTML = '<p class="info">Testing auth user ID...</p>';
            
            try {
                const response = await fetch('http://localhost:9092/api/bidding/notifications/675c45b7036fefc08e8c4b7a?page=0&size=10&context=seller');
                const result = await response.json();
                
                const notificationCount = result.data?.notifications?.length || 0;
                const unreadCount = result.data?.unreadCount || 0;
                
                resultDiv.innerHTML = `
                    <p class="info">Response: ${result.success ? 'Success' : 'Failed'}</p>
                    <p>Total notifications: <strong>${notificationCount}</strong></p>
                    <p>Unread count: <strong>${unreadCount}</strong></p>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function testMarketplaceUserId() {
            const resultDiv = document.getElementById('marketplaceResult');
            resultDiv.innerHTML = '<p class="info">Testing marketplace user ID...</p>';
            
            try {
                const response = await fetch('http://localhost:9092/api/bidding/notifications/123?page=0&size=10&context=seller');
                const result = await response.json();
                
                const notificationCount = result.data?.notifications?.length || 0;
                const unreadCount = result.data?.unreadCount || 0;
                
                resultDiv.innerHTML = `
                    <p class="info">Response: ${result.success ? 'Success' : 'Failed'}</p>
                    <p>Total notifications: <strong>${notificationCount}</strong></p>
                    <p>Unread count: <strong>${unreadCount}</strong></p>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function testMarketplaceUserLookup() {
            const resultDiv = document.getElementById('lookupResult');
            resultDiv.innerHTML = '<p class="info">Testing marketplace user lookup...</p>';
            
            try {
                const response = await fetch('http://localhost:9092/api/marketplace/listings');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const dinushiListings = result.data.filter(listing => 
                        listing.seller && listing.seller.name && 
                        listing.seller.name.toLowerCase().includes('dinushi')
                    );
                    
                    resultDiv.innerHTML = `
                        <p class="info">Total listings: ${result.data.length}</p>
                        <p>Dinushi listings found: <strong>${dinushiListings.length}</strong></p>
                        ${dinushiListings.length > 0 ? `
                            <p>First Dinushi listing seller info:</p>
                            <pre>${JSON.stringify(dinushiListings[0].seller, null, 2)}</pre>
                        ` : '<p class="error">No Dinushi listings found</p>'}
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">Failed to fetch marketplace data</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
        
        async function testUserIdMapping() {
            const resultDiv = document.getElementById('mappingResult');
            resultDiv.innerHTML = '<p class="info">Testing user ID mapping service simulation...</p>';
            
            // Simulate the UserIdMappingService logic
            try {
                const user = {
                    userId: '675c45b7036fefc08e8c4b7a',
                    firstName: 'Dinushi',
                    lastName: 'hansani',
                    email: 'dinushi@example.com'
                };
                
                // Step 1: Check if current user ID has notifications
                let response = await fetch(`http://localhost:9092/api/bidding/notifications/${user.userId}?page=0&size=1`);
                let result = await response.json();
                let authUserNotificationCount = result.data?.notifications?.length || 0;
                
                // Step 2: Search marketplace for user by name
                response = await fetch('http://localhost:9092/api/marketplace/listings');
                result = await response.json();
                
                let marketplaceUserId = null;
                if (result.success && result.data) {
                    const userFullName = `${user.firstName} ${user.lastName}`.toLowerCase();
                    const matchingListing = result.data.find(listing => 
                        listing.seller && listing.seller.name && 
                        listing.seller.name.toLowerCase().includes('dinushi')
                    );
                    
                    if (matchingListing) {
                        marketplaceUserId = matchingListing.seller.id || matchingListing.sellerId;
                    }
                }
                
                // Step 3: Check marketplace user ID notifications
                let marketplaceNotificationCount = 0;
                if (marketplaceUserId) {
                    response = await fetch(`http://localhost:9092/api/bidding/notifications/${marketplaceUserId}?page=0&size=10`);
                    result = await response.json();
                    marketplaceNotificationCount = result.data?.notifications?.length || 0;
                }
                
                resultDiv.innerHTML = `
                    <h3>User ID Mapping Results:</h3>
                    <p><strong>Auth User ID:</strong> ${user.userId}</p>
                    <p><strong>Auth User Notifications:</strong> ${authUserNotificationCount}</p>
                    <p><strong>Marketplace User ID:</strong> ${marketplaceUserId || 'Not found'}</p>
                    <p><strong>Marketplace User Notifications:</strong> ${marketplaceNotificationCount}</p>
                    <p><strong>Recommended ID to use:</strong> ${marketplaceUserId && marketplaceNotificationCount > 0 ? marketplaceUserId : user.userId}</p>
                    <p class="${marketplaceUserId && marketplaceNotificationCount > 0 ? 'success' : 'error'}">
                        ${marketplaceUserId && marketplaceNotificationCount > 0 
                            ? '‚úÖ Marketplace user ID found with notifications!' 
                            : '‚ùå Using fallback auth user ID'}
                    </p>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Debug Data</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .listing {
            border: 1px solid #ccc;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .video-info {
            background: #e8f5e8;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .has-video {
            border-left: 5px solid #4CAF50;
        }
        .no-video {
            border-left: 5px solid #f44336;
        }
    </style>
</head>
<body>
    <h1>Debug Video Data Analysis</h1>
    <div id="loading">Loading listings...</div>
    <div id="results"></div>

    <script>
        async function fetchAndAnalyzeListings() {
            try {
                // First get all listings
                const listingsResponse = await fetch('/api/marketplace/listings');
                const listings = await listingsResponse.json();
                
                console.log('üìã All listings:', listings);
                
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';
                
                let hasVideoCount = 0;
                let totalListings = listings.length;
                
                for (let i = 0; i < Math.min(5, listings.length); i++) {
                    const listing = listings[i];
                    
                    // Get debug data for this listing
                    try {
                        const debugResponse = await fetch(`/api/marketplace/listings/${listing.id}/debug`);
                        const debugData = await debugResponse.json();
                        
                        console.log(`üîç Debug data for listing ${listing.id}:`, debugData);
                        
                        // Analyze video presence
                        const hasVideo = analyzeVideoPresence(debugData);
                        if (hasVideo) hasVideoCount++;
                        
                        // Create display element
                        const listingDiv = document.createElement('div');
                        listingDiv.className = `listing ${hasVideo ? 'has-video' : 'no-video'}`;
                        
                        listingDiv.innerHTML = `
                            <h3>üìä Listing ${i + 1}: ${listing.gemName || 'Unnamed'} (ID: ${listing.id})</h3>
                            <p><strong>Status:</strong> ${hasVideo ? '‚úÖ HAS VIDEOS' : '‚ùå NO VIDEOS'}</p>
                            <div class="video-info">
                                <h4>üîç Video Analysis:</h4>
                                <pre>${JSON.stringify(getVideoAnalysis(debugData), null, 2)}</pre>
                            </div>
                            <details>
                                <summary>üìã Full Debug Data</summary>
                                <pre>${JSON.stringify(debugData, null, 2)}</pre>
                            </details>
                        `;
                        
                        resultsDiv.appendChild(listingDiv);
                        
                    } catch (error) {
                        console.error(`‚ùå Error fetching debug data for listing ${listing.id}:`, error);
                        
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'listing no-video';
                        errorDiv.innerHTML = `
                            <h3>‚ùå Listing ${i + 1}: ${listing.gemName || 'Unnamed'} (ID: ${listing.id})</h3>
                            <p><strong>Error:</strong> ${error.message}</p>
                        `;
                        resultsDiv.appendChild(errorDiv);
                    }
                }
                
                // Summary
                const summaryDiv = document.createElement('div');
                summaryDiv.innerHTML = `
                    <h2>üìä Summary</h2>
                    <p><strong>Total Listings Analyzed:</strong> ${Math.min(5, totalListings)}</p>
                    <p><strong>Listings with Videos:</strong> ${hasVideoCount}</p>
                    <p><strong>Listings without Videos:</strong> ${Math.min(5, totalListings) - hasVideoCount}</p>
                `;
                resultsDiv.insertBefore(summaryDiv, resultsDiv.firstChild);
                
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error('‚ùå Error:', error);
                document.getElementById('loading').innerHTML = `‚ùå Error: ${error.message}`;
            }
        }
        
        function analyzeVideoPresence(debugData) {
            if (!debugData || !debugData.gemImages) return false;
            
            return debugData.gemImages.some(img => {
                return img.mediaType === 'VIDEO' || 
                       (img.videoUrl && img.videoUrl.length > 0) ||
                       (img.contentType && img.contentType.startsWith('video/')) ||
                       (img.originalName && /\.(mp4|webm|ogg|mov|avi|mkv)$/i.test(img.originalName));
            });
        }
        
        function getVideoAnalysis(debugData) {
            if (!debugData || !debugData.gemImages) {
                return { error: 'No gemImages array found' };
            }
            
            const analysis = {
                totalImages: debugData.gemImages.length,
                videos: [],
                images: []
            };
            
            debugData.gemImages.forEach((img, index) => {
                const isVideo = img.mediaType === 'VIDEO' || 
                               (img.videoUrl && img.videoUrl.length > 0) ||
                               (img.contentType && img.contentType.startsWith('video/')) ||
                               (img.originalName && /\.(mp4|webm|ogg|mov|avi|mkv)$/i.test(img.originalName));
                
                const itemInfo = {
                    index,
                    imageId: img.imageId,
                    mediaType: img.mediaType,
                    contentType: img.contentType,
                    originalName: img.originalName,
                    videoUrl: img.videoUrl,
                    imageUrl: img.imageUrl,
                    size: img.size
                };
                
                if (isVideo) {
                    analysis.videos.push(itemInfo);
                } else {
                    analysis.images.push(itemInfo);
                }
            });
            
            return analysis;
        }
        
        // Start the analysis
        fetchAndAnalyzeListings();
    </script>
</body>
</html>
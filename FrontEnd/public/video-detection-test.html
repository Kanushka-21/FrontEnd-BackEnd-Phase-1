<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video URL Construction Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-case {
            border: 1px solid #ddd;
            margin: 10px 0;
            padding: 15px;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .video-detected {
            border-left: 5px solid #4CAF50;
            background-color: #e8f5e8;
        }
        .no-video {
            border-left: 5px solid #f44336;
            background-color: #ffe8e8;
        }
        pre {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .url-box {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 3px;
            margin: 5px 0;
            font-family: monospace;
        }
        h2 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé¨ Video Detection & URL Construction Test</h1>
        <p>This test demonstrates how the fixed video detection logic will handle real video data from the backend.</p>
        
        <h2>üîß Fixed Video Detection Logic</h2>
        
        <div class="test-case video-detected">
            <h3>‚úÖ Test Case 1: Backend Video Object (mediaType='VIDEO')</h3>
            <p><strong>Input Data:</strong> GemImage object with mediaType='VIDEO' and videoUrl='/uploads/gem-videos/sapphire_demo.mp4'</p>
            
            <div class="url-box">
                <strong>Raw URL:</strong> /uploads/gem-videos/sapphire_demo.mp4<br>
                <strong>Constructed URL:</strong> <span id="url1">http://localhost:9092/uploads/gem-videos/sapphire_demo.mp4</span>
            </div>
            
            <pre id="detection1"></pre>
        </div>
        
        <div class="test-case video-detected">
            <h3>‚úÖ Test Case 2: Video in imageUrl with .mp4 extension</h3>
            <p><strong>Input Data:</strong> GemImage object with imageUrl='/uploads/gem-videos/ruby_showcase.mp4'</p>
            
            <div class="url-box">
                <strong>Raw URL:</strong> /uploads/gem-videos/ruby_showcase.mp4<br>
                <strong>Constructed URL:</strong> <span id="url2">http://localhost:9092/uploads/gem-videos/ruby_showcase.mp4</span>
            </div>
            
            <pre id="detection2"></pre>
        </div>
        
        <div class="test-case video-detected">
            <h3>‚úÖ Test Case 3: Full URL Video (already complete)</h3>
            <p><strong>Input Data:</strong> Video with full URL already provided</p>
            
            <div class="url-box">
                <strong>Raw URL:</strong> https://example.com/videos/emerald.mp4<br>
                <strong>Constructed URL:</strong> <span id="url3">https://example.com/videos/emerald.mp4</span>
            </div>
            
            <pre id="detection3"></pre>
        </div>
        
        <div class="test-case no-video">
            <h3>‚ùå Test Case 4: Regular Image (should not be detected as video)</h3>
            <p><strong>Input Data:</strong> GemImage object with mediaType='IMAGE' and imageUrl='/uploads/gem-images/diamond.jpg'</p>
            
            <div class="url-box">
                <strong>Raw URL:</strong> /uploads/gem-images/diamond.jpg<br>
                <strong>Result:</strong> <span id="url4">Not detected as video (correct)</span>
            </div>
            
            <pre id="detection4"></pre>
        </div>
        
        <h2>üìä Summary of Fixes Applied</h2>
        <ul>
            <li>‚úÖ Added <code>constructImageUrl</code> function to convert relative paths to full URLs</li>
            <li>‚úÖ Enhanced video detection to prioritize <code>mediaType="VIDEO"</code> field from backend</li>
            <li>‚úÖ Added comprehensive file extension checks for video formats (.mp4, .webm, .ogg, etc.)</li>
            <li>‚úÖ Updated both marketplace modal and seller dashboard with same logic</li>
            <li>‚úÖ Removed dummy video injection - now relies on real video detection</li>
            <li>‚úÖ Added detailed logging for debugging video detection issues</li>
        </ul>
        
        <h2>üéØ Expected Results</h2>
        <div class="test-case video-detected">
            <p><strong>‚úÖ With the fixes:</strong></p>
            <ul>
                <li>Real seller-uploaded videos will appear in marketplace gem detail modals</li>
                <li>Videos will also appear in seller dashboard "My Listings" view modal</li>
                <li>No more dummy/test videos - only real uploaded content</li>
                <li>Proper URL construction ensures videos load correctly</li>
                <li>Enhanced detection covers all video storage scenarios</li>
            </ul>
        </div>
    </div>

    <script>
        // Simulate the fixed video detection logic
        
        // Helper function from the fix
        function constructImageUrl(imagePath) {
            if (!imagePath || imagePath.trim() === '') {
                return '';
            }
            
            if (imagePath.startsWith('http://') || imagePath.startsWith('https://')) {
                return imagePath;
            }
            
            const baseUrl = 'http://localhost:9092';
            if (imagePath.startsWith('/')) {
                return baseUrl + imagePath;
            } else {
                return baseUrl + '/' + imagePath;
            }
        }
        
        // Enhanced video detection function
        function detectVideo(imgObject) {
            if (!imgObject || typeof imgObject !== 'object') return null;
            
            // Primary check: mediaType === "VIDEO"
            const isVideoMediaType = imgObject.mediaType === 'VIDEO';
            
            // Secondary checks
            const hasVideoUrl = imgObject.videoUrl && imgObject.videoUrl.trim() !== '';
            const isVideoType = imgObject.type === 'VIDEO';
            
            // File extension checks
            const imageUrlHasVideoExt = imgObject.imageUrl && /\.(mp4|webm|ogg|mov|avi|mkv)$/i.test(imgObject.imageUrl);
            const videoUrlHasVideoExt = imgObject.videoUrl && /\.(mp4|webm|ogg|mov|avi|mkv)$/i.test(imgObject.videoUrl);
            const urlHasVideoExt = imgObject.url && /\.(mp4|webm|ogg|mov|avi|mkv)$/i.test(imgObject.url);
            
            // Filename checks
            const filenameHasVideo = (imgObject.filename && /video|mov|mp4|webm/i.test(imgObject.filename)) ||
                                    (imgObject.originalName && /video|mov|mp4|webm/i.test(imgObject.originalName));
            
            const isVideo = isVideoMediaType || hasVideoUrl || isVideoType || 
                           imageUrlHasVideoExt || videoUrlHasVideoExt || urlHasVideoExt || 
                           filenameHasVideo;
            
            const detection = {
                isVideo,
                isVideoMediaType,
                hasVideoUrl,
                isVideoType,
                imageUrlHasVideoExt,
                videoUrlHasVideoExt,
                urlHasVideoExt,
                filenameHasVideo,
                detectionReason: isVideoMediaType ? 'mediaType=VIDEO' : 
                                hasVideoUrl ? 'has videoUrl' :
                                isVideoType ? 'type=VIDEO' :
                                imageUrlHasVideoExt ? 'imageUrl has video extension' :
                                videoUrlHasVideoExt ? 'videoUrl has video extension' :
                                urlHasVideoExt ? 'url has video extension' :
                                filenameHasVideo ? 'filename indicates video' : 'none'
            };
            
            if (isVideo) {
                const rawVideoUrl = imgObject.videoUrl || 
                                   (imageUrlHasVideoExt ? imgObject.imageUrl : null) ||
                                   (urlHasVideoExt ? imgObject.url : null) ||
                                   imgObject.imageUrl || imgObject.url;
                
                const fullVideoUrl = rawVideoUrl ? constructImageUrl(rawVideoUrl) : null;
                
                return {
                    ...detection,
                    rawVideoUrl,
                    fullVideoUrl
                };
            }
            
            return detection;
        }
        
        // Test cases
        const testCases = [
            {
                id: 1,
                input: {
                    imageId: 'img_001',
                    mediaType: 'VIDEO',
                    videoUrl: '/uploads/gem-videos/sapphire_demo.mp4',
                    imageUrl: '/uploads/gem-images/sapphire_thumb.jpg',
                    originalName: 'sapphire_demo.mp4'
                }
            },
            {
                id: 2,
                input: {
                    imageId: 'img_002',
                    mediaType: 'IMAGE',
                    imageUrl: '/uploads/gem-videos/ruby_showcase.mp4',
                    originalName: 'ruby_showcase.mp4'
                }
            },
            {
                id: 3,
                input: {
                    imageId: 'img_003',
                    mediaType: 'VIDEO',
                    videoUrl: 'https://example.com/videos/emerald.mp4',
                    originalName: 'emerald.mp4'
                }
            },
            {
                id: 4,
                input: {
                    imageId: 'img_004',
                    mediaType: 'IMAGE',
                    imageUrl: '/uploads/gem-images/diamond.jpg',
                    originalName: 'diamond.jpg'
                }
            }
        ];
        
        // Run tests
        testCases.forEach(testCase => {
            const result = detectVideo(testCase.input);
            document.getElementById(`detection${testCase.id}`).textContent = JSON.stringify(result, null, 2);
        });
        
        console.log('üé¨ Video Detection Test Complete - Check the test results above!');
    </script>
</body>
</html>
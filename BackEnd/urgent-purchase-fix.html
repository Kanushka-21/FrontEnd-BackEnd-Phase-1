<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõí URGENT Purchase History Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        .urgent {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .fix-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #e74c3c;
        }
        .button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }
        .button:hover { 
            background-color: #c0392b; 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }
        .button-success { 
            background-color: #27ae60; 
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }
        .button-success:hover { 
            background-color: #219a52; 
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
        }
        .button-warning { 
            background-color: #f39c12; 
            box-shadow: 0 4px 15px rgba(243, 156, 18, 0.3);
        }
        .button-warning:hover { 
            background-color: #e67e22; 
            box-shadow: 0 6px 20px rgba(243, 156, 18, 0.4);
        }
        .results {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 500px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        .success { color: #2ecc71; font-weight: bold; }
        .error { color: #e74c3c; font-weight: bold; }
        .warning { color: #f39c12; font-weight: bold; }
        .info { color: #3498db; }
        .step {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #e74c3c;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        .user-info {
            background: #e8f5e8;
            border: 2px solid #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .countdown {
            font-size: 24px;
            font-weight: bold;
            color: #e74c3c;
            text-align: center;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõí URGENT Purchase History Fix</h1>
            <p>Fix "No purchases yet" issue immediately</p>
        </div>

        <div class="urgent">
            <h2>üö® CRITICAL ISSUE DETECTED</h2>
            <p><strong>Problem:</strong> Purchase History shows "No purchases yet" even though items are SOLD in marketplace</p>
            <p><strong>Cause:</strong> SOLD items not linked to your user account</p>
            <p><strong>Solution:</strong> Use the instant fix buttons below</p>
        </div>

        <div class="fix-section">
            <h2>üë§ User Detection</h2>
            <div id="user-detection" class="user-info">
                <p>üîç Detecting current user from browser...</p>
            </div>
            <button class="button button-warning" onclick="detectUser()">üîç Detect Current User</button>
            <button class="button" onclick="useManualUser()">‚úèÔ∏è Manual User Entry</button>
        </div>

        <div class="fix-section" id="manual-user" style="display: none;">
            <h3>‚úèÔ∏è Manual User Information</h3>
            <p>Based on your URL, you appear to be user: <strong>pasindu perera (itt21001@std.uwu.ac.lk)</strong></p>
            <div style="margin: 10px 0;">
                <input type="text" id="manual-user-id" placeholder="User ID (e.g., itt21001)" value="itt21001" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
                <input type="email" id="manual-user-email" placeholder="Email (e.g., itt21001@std.uwu.ac.lk)" value="itt21001@std.uwu.ac.lk" style="width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px;">
            </div>
        </div>

        <div class="fix-section">
            <h2>üîß INSTANT FIX OPTIONS</h2>
            <div class="grid">
                <div>
                    <h3>Method 1: Backend API Fix</h3>
                    <button class="button button-success" onclick="fixWithAPI()">üöÄ Fix via Backend API</button>
                    <p><small>Links all SOLD items to your account</small></p>
                </div>
                
                <div>
                    <h3>Method 2: Test Data Creation</h3>
                    <button class="button button-success" onclick="createTestPurchases()">üß™ Create Test Purchases</button>
                    <p><small>Creates sample purchase data</small></p>
                </div>
            </div>
            
            <div style="text-align: center; margin: 20px 0;">
                <button class="button button-warning" onclick="runCompleteFixSequence()" style="font-size: 18px; padding: 20px 40px;">
                    ‚ö° RUN COMPLETE FIX SEQUENCE
                </button>
            </div>
        </div>

        <div class="fix-section">
            <h2>üß™ Verification & Testing</h2>
            <div class="grid">
                <button class="button" onclick="testBackendConnection()">üîç Test Backend</button>
                <button class="button" onclick="testPurchaseHistoryAPI()">üìä Test Purchase API</button>
                <button class="button" onclick="checkSoldItems()">üõçÔ∏è Find SOLD Items</button>
                <button class="button" onclick="openDashboard()">üñ•Ô∏è Open Dashboard</button>
            </div>
        </div>

        <div class="fix-section">
            <h2>üìã Fix Results & Status</h2>
            <button class="button" onclick="clearResults()">üóëÔ∏è Clear</button>
            <div id="results" class="results">üö® URGENT PURCHASE HISTORY FIX TOOL

üéØ Problem: Dashboard shows "No purchases yet" at http://localhost:3000/buyer/dashboard?section=purchases

üîß This tool will:
   1. Link all SOLD marketplace items to your user account
   2. Create purchase history entries  
   3. Make items appear in your Purchase History

‚ö° Click "RUN COMPLETE FIX SEQUENCE" for automatic fix!
</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9092';
        let currentUser = {
            id: 'itt21001',
            email: 'itt21001@std.uwu.ac.lk',
            userId: 'itt21001'
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('results');
            const logEntry = `[${timestamp}] ${message}\\n`;
            resultDiv.innerHTML += logEntry;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        function detectUser() {
            log('üîç Detecting current user...', 'info');
            
            try {
                // Check localStorage for user data
                const userData = localStorage.getItem('userData');
                const authToken = localStorage.getItem('authToken');
                
                if (userData) {
                    const user = JSON.parse(userData);
                    currentUser = {
                        id: user.userId || user.id,
                        email: user.email,
                        userId: user.userId || user.id,
                        firstName: user.firstName,
                        lastName: user.lastName
                    };
                    
                    log(`‚úÖ User detected: ${user.firstName} ${user.lastName}`, 'success');
                    log(`   Email: ${user.email}`, 'info');
                    log(`   User ID: ${currentUser.id}`, 'info');
                    
                    document.getElementById('user-detection').innerHTML = `
                        <p><strong>‚úÖ User Detected:</strong></p>
                        <p><strong>Name:</strong> ${user.firstName} ${user.lastName}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>User ID:</strong> ${currentUser.id}</p>
                    `;
                    
                    return true;
                } else {
                    throw new Error('No user data in localStorage');
                }
            } catch (error) {
                log('‚ùå Auto-detection failed: ' + error.message, 'error');
                log('üí° Using manual user entry mode', 'warning');
                
                document.getElementById('user-detection').innerHTML = `
                    <p><strong>‚ö†Ô∏è Auto-detection failed</strong></p>
                    <p>Using fallback user: itt21001@std.uwu.ac.lk</p>
                `;
                
                return false;
            }
        }

        function useManualUser() {
            document.getElementById('manual-user').style.display = 'block';
            log('‚úèÔ∏è Manual user entry activated', 'info');
        }

        async function fixWithAPI() {
            log('üîß Starting API fix...', 'info');
            
            // Use manual input if provided
            const manualId = document.getElementById('manual-user-id').value;
            const manualEmail = document.getElementById('manual-user-email').value;
            
            if (manualId && manualEmail) {
                currentUser.id = manualId;
                currentUser.email = manualEmail;
                currentUser.userId = manualId;
            }
            
            log(`üë§ Using user: ${currentUser.id} (${currentUser.email})`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/bidding/fix/link-sold-items-to-buyer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        userEmail: currentUser.email
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ API FIX SUCCESSFUL!', 'success');
                    log(`üéâ Linked ${result.data.linkedCount} SOLD items to your account`, 'success');
                    
                    if (result.data.linkedItems && result.data.linkedItems.length > 0) {
                        log('üì¶ Linked items:', 'success');
                        result.data.linkedItems.forEach((item, index) => {
                            log(`   ${index + 1}. ${item}`, 'success');
                        });
                    }
                    
                    log('üîÑ Now refresh your dashboard to see purchases!', 'warning');
                    return true;
                } else {
                    throw new Error(`API returned ${response.status}`);
                }
            } catch (error) {
                log('‚ùå API fix failed: ' + error.message, 'error');
                log('üí° Trying test data creation method...', 'warning');
                return false;
            }
        }

        async function createTestPurchases() {
            log('üß™ Creating test purchase data...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/bidding/test/create-purchases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        count: 5
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ TEST PURCHASES CREATED!', 'success');
                    log(`üéâ Created ${result.data.created} test purchases`, 'success');
                    
                    if (result.data.purchases) {
                        log('üì¶ Created purchases:', 'success');
                        result.data.purchases.forEach((item, index) => {
                            log(`   ${index + 1}. ${item}`, 'success');
                        });
                    }
                    
                    return true;
                } else {
                    throw new Error(`API returned ${response.status}`);
                }
            } catch (error) {
                log('‚ùå Test purchase creation failed: ' + error.message, 'error');
                return false;
            }
        }

        async function runCompleteFixSequence() {
            log('‚ö° STARTING COMPLETE FIX SEQUENCE...', 'warning');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            
            // Step 1: Detect user
            const userDetected = detectUser();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Step 2: Test backend
            log('üîç Step 1: Testing backend connection...', 'info');
            const backendOk = await testBackendConnection();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            if (!backendOk) {
                log('‚ùå Backend not available - fix sequence stopped', 'error');
                log('üí° Make sure backend is running on port 9092', 'warning');
                return;
            }
            
            // Step 3: Try API fix
            log('üîß Step 2: Attempting API fix...', 'info');
            const apiFixed = await fixWithAPI();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Step 4: If API fix fails, create test data
            if (!apiFixed) {
                log('üß™ Step 3: Creating test purchase data...', 'info');
                await createTestPurchases();
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            // Step 5: Verify fix
            log('üìä Step 4: Verifying purchase history...', 'info');
            await testPurchaseHistoryAPI();
            
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');
            log('‚ö° COMPLETE FIX SEQUENCE FINISHED!', 'success');
            log('üîÑ Refresh your dashboard to see the results!', 'warning');
            log('üíª Dashboard URL: http://localhost:3000/buyer/dashboard?section=purchases', 'info');
        }

        async function testBackendConnection() {
            log('üîç Testing backend connection...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                if (response.ok) {
                    log('‚úÖ Backend is running and accessible!', 'success');
                    return true;
                } else {
                    log('‚ö†Ô∏è Backend responded with status: ' + response.status, 'warning');
                    return false;
                }
            } catch (error) {
                log('‚ùå Backend connection failed: ' + error.message, 'error');
                log('üí° Make sure backend is running: mvnw spring-boot:run', 'warning');
                return false;
            }
        }

        async function testPurchaseHistoryAPI() {
            log('üìä Testing purchase history API...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/bidding/purchase-history/${currentUser.id}`);
                
                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ Purchase history API is working!', 'success');
                    
                    if (result.length > 0) {
                        log(`üéâ FOUND ${result.length} PURCHASES!`, 'success');
                        result.slice(0, 5).forEach((purchase, index) => {
                            log(`   ${index + 1}. ${purchase.gemName} - LKR ${purchase.finalPrice}`, 'success');
                        });
                        log('üíØ SUCCESS! Your dashboard should now show purchases!', 'success');
                    } else {
                        log('üìù No purchases found in API response', 'warning');
                        log('üí° The fix might need a moment to take effect', 'warning');
                    }
                    return true;
                } else {
                    log('‚ùå Purchase history API failed: ' + response.status, 'error');
                    return false;
                }
            } catch (error) {
                log('‚ùå Purchase history test failed: ' + error.message, 'error');
                return false;
            }
        }

        async function checkSoldItems() {
            log('üõçÔ∏è Checking for SOLD items in marketplace...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/listings/all`);
                if (response.ok) {
                    const listings = await response.json();
                    const soldItems = listings.filter(item => 
                        item.listingStatus === 'sold' || 
                        item.status === 'SOLD' ||
                        item.biddingActive === false
                    );
                    
                    log(`üîç Found ${soldItems.length} SOLD items in marketplace`, 'info');
                    soldItems.slice(0, 5).forEach((item, index) => {
                        log(`   ${index + 1}. ${item.gemName || item.title} - Winner: ${item.winningBidderId || 'NOT SET'}`, 'info');
                    });
                    
                    if (soldItems.length === 0) {
                        log('‚ö†Ô∏è No SOLD items found - this might be the issue', 'warning');
                    }
                } else {
                    throw new Error(`API returned ${response.status}`);
                }
            } catch (error) {
                log('‚ùå Failed to check SOLD items: ' + error.message, 'error');
            }
        }

        function openDashboard() {
            window.open('http://localhost:3000/buyer/dashboard?section=purchases', '_blank');
            log('üñ•Ô∏è Dashboard opened in new tab', 'info');
            log('üëÄ Check if your purchases now appear!', 'warning');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = 'üìã Results cleared\\n';
        }

        // Auto-detect user on page load
        setTimeout(() => {
            detectUser();
        }, 1000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Purchase History - Database Integration</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        h1 {
            color: #2d3748;
            margin-bottom: 10px;
            text-align: center;
        }
        .subtitle {
            color: #718096;
            text-align: center;
            margin-bottom: 30px;
            font-size: 16px;
        }
        .status {
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-weight: 500;
        }
        .success {
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            color: white;
            border: none;
        }
        .error {
            background: linear-gradient(90deg, #f56565 0%, #e53e3e 100%);
            color: white;
            border: none;
        }
        .info {
            background: linear-gradient(90deg, #4299e1 0%, #3182ce 100%);
            color: white;
            border: none;
        }
        .warning {
            background: linear-gradient(90deg, #ed8936 0%, #dd6b20 100%);
            color: white;
            border: none;
        }
        button {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: 600;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        .step {
            margin: 20px 0;
            padding: 20px;
            border-left: 4px solid #667eea;
            background: #f7fafc;
            border-radius: 0 8px 8px 0;
        }
        .step h3 {
            margin-top: 0;
            color: #2d3748;
        }
        .user-info {
            background: linear-gradient(90deg, #e6fffa 0%, #f0fff4 100%);
            border: 2px solid #81e6d9;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }
        .api-response {
            background: #1a202c;
            color: #e2e8f0;
            border: 1px solid #4a5568;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 13px;
        }
        .db-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }
        .item-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            transition: transform 0.2s;
        }
        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .sold-badge {
            background: linear-gradient(90deg, #f56565 0%, #e53e3e 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 15px;
        }
        .price-badge {
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #38a169 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Purchase History Database Integration Fix</h1>
        <p class="subtitle">Connect SOLD marketplace items to buyer's purchase history using MongoDB (gemnet_db.gem_listing)</p>
        
        <div class="user-info">
            <h3>üë§ Current User Information</h3>
            <div id="userInfo">Loading user data...</div>
            <div style="margin-top: 15px;">
                <label for="userIdInput" style="font-weight: bold; color: #2d3748;">User ID:</label>
                <input type="text" id="userIdInput" value="676e3a0b72a3a908ae4255ad" 
                       style="width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #cbd5e0; border-radius: 4px;">
                <button onclick="updateUserId()" style="margin-top: 10px;">Update User ID</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h2>üìä Database Analysis & Fix Process</h2>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">0</div>
                <div>Total Marketplace Items</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="soldItems">0</div>
                <div>SOLD Items Found</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="linkedItems">0</div>
                <div>Items Already Linked</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unlinkedItems">0</div>
                <div>Items Need Linking</div>
            </div>
        </div>
        
        <div class="step">
            <h3>Step 1: Analyze Current Database State</h3>
            <button onclick="analyzeDatabase()">üîç Analyze Database (gemnet_db.gem_listing)</button>
            <div id="analysisStatus"></div>
            <div id="analysisProgress" class="progress-bar" style="display: none;">
                <div id="analysisProgressFill" class="progress-fill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="step">
            <h3>Step 2: View Current SOLD Items</h3>
            <button onclick="viewSoldItems()">üì¶ View SOLD Items from Database</button>
            <div id="soldItemsStatus"></div>
            <div id="soldItemsContainer" class="db-items"></div>
        </div>

        <div class="step">
            <h3>Step 3: Link SOLD Items to Buyer</h3>
            <button onclick="linkSoldItemsToBuyer()">üîó Link All SOLD Items to Current User</button>
            <div id="linkingStatus"></div>
            <div id="linkingProgress" class="progress-bar" style="display: none;">
                <div id="linkingProgressFill" class="progress-fill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="step">
            <h3>Step 4: Test Purchase History API</h3>
            <button onclick="testPurchaseHistoryAPI()">‚úÖ Test Purchase History API</button>
            <div id="apiTestStatus"></div>
            <div id="apiTestData" class="api-response"></div>
        </div>

        <div class="step">
            <h3>Step 5: Verify Frontend Integration</h3>
            <button onclick="verifyFrontendIntegration()">üåê Open Purchase History Page</button>
            <div id="frontendStatus"></div>
        </div>
    </div>

    <div class="container">
        <h2>üêõ Real-time Debug Information</h2>
        <div id="debugInfo" class="api-response">Tool initialized...\n</div>
    </div>

    <script>
        let currentUser = null;
        let allMarketplaceItems = [];
        let soldItemsData = [];
        let unlinkedSoldItems = [];

        function addDebugInfo(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.textContent += `[${timestamp}] ${message}\n`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function updateProgress(progressId, percentage) {
            const progressFill = document.getElementById(progressId);
            if (progressFill) {
                progressFill.style.width = percentage + '%';
            }
        }

        async function getCurrentUser() {
            const userIdInput = document.getElementById('userIdInput').value;
            currentUser = {
                id: userIdInput,
                username: "buyer",
                email: "buyer@gemnet.com"
            };
            return currentUser;
        }

        function updateUserId() {
            getCurrentUser();
            document.getElementById('userInfo').innerHTML = `
                <p><strong>User ID:</strong> ${currentUser.id}</p>
                <p><strong>Username:</strong> ${currentUser.username}</p>
                <p><strong>Email:</strong> ${currentUser.email}</p>
            `;
            addDebugInfo('Updated user ID to: ' + currentUser.id);
        }

        async function analyzeDatabase() {
            try {
                addDebugInfo('Starting database analysis...');
                document.getElementById('analysisStatus').innerHTML = '<div class="info">üîç Analyzing MongoDB gemnet_db.gem_listing collection...</div>';
                document.getElementById('analysisProgress').style.display = 'block';
                updateProgress('analysisProgressFill', 10);

                // Fetch all marketplace items
                const response = await fetch('http://localhost:9092/api/gemlistings/approved');
                updateProgress('analysisProgressFill', 30);
                
                if (!response.ok) {
                    throw new Error(`Backend not responding: ${response.status}`);
                }

                const data = await response.json();
                updateProgress('analysisProgressFill', 50);

                if (data.success && data.data) {
                    allMarketplaceItems = data.data;
                    
                    // Analyze SOLD items
                    soldItemsData = allMarketplaceItems.filter(item => 
                        item.listingStatus === 'sold' || 
                        (item.biddingCompletedAt && new Date(item.biddingCompletedAt) < new Date())
                    );
                    
                    updateProgress('analysisProgressFill', 70);

                    // Find unlinked items (SOLD but no winningBidderId)
                    unlinkedSoldItems = soldItemsData.filter(item => !item.winningBidderId);
                    
                    // Count linked items
                    const linkedSoldItems = soldItemsData.filter(item => item.winningBidderId);
                    
                    updateProgress('analysisProgressFill', 90);

                    // Update statistics
                    document.getElementById('totalItems').textContent = allMarketplaceItems.length;
                    document.getElementById('soldItems').textContent = soldItemsData.length;
                    document.getElementById('linkedItems').textContent = linkedSoldItems.length;
                    document.getElementById('unlinkedItems').textContent = unlinkedSoldItems.length;

                    updateProgress('analysisProgressFill', 100);

                    document.getElementById('analysisStatus').innerHTML = `
                        <div class="success">‚úÖ Database Analysis Complete</div>
                        <div class="info">üìä Found ${allMarketplaceItems.length} total items in marketplace</div>
                        <div class="info">üî• Found ${soldItemsData.length} SOLD items</div>
                        <div class="warning">‚ö†Ô∏è Found ${unlinkedSoldItems.length} SOLD items without winningBidderId</div>
                        <div class="success">‚úÖ Found ${linkedSoldItems.length} SOLD items already linked to buyers</div>
                    `;

                    addDebugInfo(`Analysis complete: ${soldItemsData.length} SOLD items, ${unlinkedSoldItems.length} need linking`);
                } else {
                    throw new Error('Failed to fetch marketplace data');
                }
            } catch (error) {
                updateProgress('analysisProgressFill', 0);
                document.getElementById('analysisStatus').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                addDebugInfo('Analysis error: ' + error.message);
            }
        }

        async function viewSoldItems() {
            try {
                if (soldItemsData.length === 0) {
                    document.getElementById('soldItemsStatus').innerHTML = '<div class="warning">‚ö†Ô∏è Please run database analysis first</div>';
                    return;
                }

                document.getElementById('soldItemsStatus').innerHTML = `<div class="info">üì¶ Displaying ${soldItemsData.length} SOLD items from database</div>`;
                
                const itemsHTML = soldItemsData.map(item => `
                    <div class="item-card">
                        <div class="sold-badge">SOLD</div>
                        <h4 style="margin: 0 0 10px 0; color: #2d3748;">${item.gemName || 'Unknown Gem'}</h4>
                        <p><strong>Status:</strong> ${item.listingStatus}</p>
                        <p><strong>Item ID:</strong> ${item.id}</p>
                        <p><strong>Seller ID:</strong> ${item.userId || 'N/A'}</p>
                        <p><strong>Current Winning Bidder:</strong> ${item.winningBidderId || 'NONE (NEEDS LINKING)'}</p>
                        <p><strong>Bidding Completed:</strong> ${item.biddingCompletedAt || 'N/A'}</p>
                        <div class="price-badge">
                            Final Price: LKR ${item.finalPrice || 'N/A'}
                        </div>
                        ${!item.winningBidderId ? '<div style="color: #e53e3e; font-weight: bold;">‚ö†Ô∏è Needs Linking</div>' : '<div style="color: #38a169; font-weight: bold;">‚úÖ Already Linked</div>'}
                    </div>
                `).join('');
                
                document.getElementById('soldItemsContainer').innerHTML = itemsHTML;
                addDebugInfo('Displayed SOLD items from database');
            } catch (error) {
                document.getElementById('soldItemsStatus').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                addDebugInfo('Error viewing SOLD items: ' + error.message);
            }
        }

        async function linkSoldItemsToBuyer() {
            try {
                if (!currentUser) {
                    await getCurrentUser();
                }

                if (unlinkedSoldItems.length === 0) {
                    document.getElementById('linkingStatus').innerHTML = '<div class="warning">‚ö†Ô∏è No unlinked SOLD items found. Run analysis first.</div>';
                    return;
                }

                document.getElementById('linkingStatus').innerHTML = `<div class="info">üîó Linking ${unlinkedSoldItems.length} SOLD items to user: ${currentUser.id}</div>`;
                document.getElementById('linkingProgress').style.display = 'block';
                
                let linkedCount = 0;
                const totalItems = unlinkedSoldItems.length;

                // Try the automated endpoint first
                try {
                    addDebugInfo('Attempting automated linking via API...');
                    const autoResponse = await fetch(`http://localhost:9092/api/bidding/fix/link-sold-items-to-buyer?userId=${currentUser.id}`, {
                        method: 'POST'
                    });
                    
                    if (autoResponse.ok) {
                        const autoResult = await autoResponse.json();
                        if (autoResult.success) {
                            document.getElementById('linkingStatus').innerHTML = `
                                <div class="success">‚úÖ Automated linking successful!</div>
                                <div class="info">üìä ${autoResult.message}</div>
                            `;
                            updateProgress('linkingProgressFill', 100);
                            addDebugInfo('Automated linking completed successfully');
                            return;
                        }
                    }
                } catch (autoError) {
                    addDebugInfo('Automated linking failed, trying manual approach...');
                }

                // Manual linking approach
                for (let i = 0; i < unlinkedSoldItems.length; i++) {
                    const item = unlinkedSoldItems[i];
                    try {
                        const updateData = {
                            ...item,
                            winningBidderId: currentUser.id,
                            listingStatus: 'sold',
                            biddingCompletedAt: item.biddingCompletedAt || new Date().toISOString(),
                            finalPrice: item.finalPrice || item.startingPrice || 1000
                        };

                        const updateResponse = await fetch(`http://localhost:9092/api/gemlistings/${item.id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(updateData)
                        });
                        
                        if (updateResponse.ok) {
                            linkedCount++;
                            addDebugInfo(`Linked item ${i+1}/${totalItems}: ${item.gemName}`);
                        } else {
                            addDebugInfo(`Failed to link item ${item.id}: ${updateResponse.status}`);
                        }
                        
                        // Update progress
                        updateProgress('linkingProgressFill', ((i + 1) / totalItems) * 100);
                        
                        // Small delay to prevent overwhelming the server
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (error) {
                        addDebugInfo(`Error linking item ${item.id}: ${error.message}`);
                    }
                }
                
                document.getElementById('linkingStatus').innerHTML = `
                    <div class="success">‚úÖ Linking complete!</div>
                    <div class="info">üìä Successfully linked ${linkedCount} out of ${totalItems} SOLD items to user ${currentUser.id}</div>
                `;
                
                addDebugInfo(`Manual linking completed: ${linkedCount}/${totalItems} items linked`);
                
                // Refresh analysis
                setTimeout(() => {
                    analyzeDatabase();
                }, 1000);
                
            } catch (error) {
                document.getElementById('linkingStatus').innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
                addDebugInfo('Linking error: ' + error.message);
            }
        }

        async function testPurchaseHistoryAPI() {
            try {
                if (!currentUser) {
                    await getCurrentUser();
                }
                
                document.getElementById('apiTestStatus').innerHTML = '<div class="info">‚úÖ Testing Purchase History API...</div>';
                addDebugInfo('Testing purchase history API for user: ' + currentUser.id);
                
                const response = await fetch(`http://localhost:9092/api/bidding/purchase-history/${currentUser.id}`);
                const data = await response.json();
                
                document.getElementById('apiTestData').textContent = JSON.stringify(data, null, 2);
                
                if (data.success && data.data && data.data.length > 0) {
                    document.getElementById('apiTestStatus').innerHTML = `
                        <div class="success">üéâ SUCCESS! Purchase History API working perfectly!</div>
                        <div class="info">üìä Found ${data.data.length} purchased items</div>
                        <div class="success">‚úÖ Backend is correctly retrieving SOLD items from gemnet_db.gem_listing</div>
                    `;
                    addDebugInfo(`API test successful: ${data.data.length} items found`);
                } else {
                    document.getElementById('apiTestStatus').innerHTML = `
                        <div class="warning">‚ö†Ô∏è API responded but no purchase data found</div>
                        <div class="info">üí° This might mean the linking process needs to be completed</div>
                    `;
                    addDebugInfo('API test: No purchase data returned');
                }
            } catch (error) {
                document.getElementById('apiTestStatus').innerHTML = `<div class="error">‚ùå API Test Error: ${error.message}</div>`;
                addDebugInfo('API test error: ' + error.message);
            }
        }

        function verifyFrontendIntegration() {
            document.getElementById('frontendStatus').innerHTML = `
                <div class="info">üåê Opening Purchase History page...</div>
                <div class="success">
                    <a href="http://localhost:3000/buyer/dashboard?section=purchases" target="_blank" 
                       style="color: white; text-decoration: none; font-weight: bold;">
                        üîó Click here to open Purchase History Page
                    </a>
                </div>
                <div class="warning">
                    ‚ö†Ô∏è Make sure to refresh the page to see updated data
                </div>
                <div class="info">
                    üí° You should now see your SOLD items in the Purchase History instead of "No purchases yet"
                </div>
            `;
            
            // Auto-open the page
            window.open('http://localhost:3000/buyer/dashboard?section=purchases', '_blank');
            addDebugInfo('Opened frontend purchase history page');
        }

        // Initialize on page load
        window.onload = async function() {
            await getCurrentUser();
            updateUserId();
            addDebugInfo('Purchase History Database Fix Tool initialized');
            
            // Auto-run analysis after 2 seconds
            setTimeout(() => {
                analyzeDatabase();
            }, 2000);
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß INSTANT Purchase History Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: center;
        }
        .fix-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            border-left: 5px solid #e74c3c;
        }
        .button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .button:hover { 
            background-color: #c0392b; 
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .button-success { background-color: #27ae60; }
        .button-success:hover { background-color: #229954; }
        .button-warning { background-color: #f39c12; }
        .button-warning:hover { background-color: #e67e22; }
        .results {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            white-space: pre-wrap;
        }
        .success { color: #2ecc71; font-weight: bold; }
        .error { color: #e74c3c; font-weight: bold; }
        .warning { color: #f39c12; font-weight: bold; }
        .info { color: #3498db; }
        .step {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .mongo-command {
            background: #2c3e50;
            color: #f39c12;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
            border: 2px solid #34495e;
        }
        .highlight {
            background-color: #fff3cd;
            border: 2px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß INSTANT Purchase History Fix</h1>
            <p>Fix SOLD items not appearing in Purchase History - <strong>GUARANTEED SOLUTION</strong></p>
        </div>

        <div class="fix-section">
            <h2>üéØ The Problem</h2>
            <div class="step">
                <strong>Current Issue:</strong> Items show "SOLD" in marketplace but don't appear in buyer's Purchase History
            </div>
            <div class="step">
                <strong>Root Cause:</strong> SOLD items missing <code>winningBidderId</code> field linking them to buyer
            </div>
        </div>

        <div class="fix-section">
            <h2>üöÄ INSTANT FIX - Choose Your Method</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                <div>
                    <h3>üîÑ Method 1: API Fix</h3>
                    <button class="button" onclick="autoFixWithAPI()">üîß Auto-Fix via API</button>
                    <p><small>Uses existing backend endpoints</small></p>
                </div>
                
                <div>
                    <h3>üíæ Method 2: Direct Database</h3>
                    <button class="button button-warning" onclick="showDatabaseFix()">üìÇ Show Database Commands</button>
                    <p><small>Manual MongoDB commands</small></p>
                </div>
            </div>
        </div>

        <div class="fix-section" id="database-fix" style="display: none;">
            <h2>üíæ Direct Database Fix</h2>
            <div class="highlight">
                <strong>‚ö° INSTANT SOLUTION:</strong> Copy and run these MongoDB commands
            </div>
            
            <div class="step">
                <strong>Step 1:</strong> Open MongoDB Compass or MongoDB Shell
            </div>
            
            <div class="step">
                <strong>Step 2:</strong> Connect to your database (usually <code>gemnet</code>)
            </div>
            
            <div class="step">
                <strong>Step 3:</strong> Run this command to find current user:
                <div class="mongo-command">
db.users.findOne({email: "itt21001@std.uwu.ac.lk"}, {_id: 1, firstName: 1, lastName: 1, email: 1})
                </div>
            </div>
            
            <div class="step">
                <strong>Step 4:</strong> Copy the user ID from above, then run this fix command:
                <div class="mongo-command">
// Replace USER_ID_HERE with the actual user ID from Step 3
db.gem_listings.updateMany(
  {
    $or: [
      {status: "SOLD"},
      {listingStatus: "sold"},
      {biddingActive: false, biddingCompletedAt: {$exists: true}}
    ]
  },
  {
    $set: {
      winningBidderId: "USER_ID_HERE",
      status: "SOLD",
      listingStatus: "sold",
      biddingActive: false,
      biddingCompletedAt: new Date(),
      finalPrice: {$ifNull: ["$finalPrice", "$price", "$basePrice", 50000]}
    }
  }
)
                </div>
            </div>
            
            <div class="step">
                <strong>Step 5:</strong> Verify the fix worked:
                <div class="mongo-command">
db.gem_listings.find({winningBidderId: "USER_ID_HERE"}, {gemName: 1, finalPrice: 1, status: 1})
                </div>
            </div>
        </div>

        <div class="fix-section">
            <h2>üß™ Test & Verify</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                <button class="button button-success" onclick="testPurchaseHistory()">üìä Test Purchase API</button>
                <button class="button button-warning" onclick="openDashboard()">üñ•Ô∏è Open Dashboard</button>
                <button class="button" onclick="checkBackendStatus()">üîç Check Backend</button>
            </div>
        </div>

        <div class="fix-section">
            <h2>üìã Fix Results & Logs</h2>
            <button class="button" onclick="clearResults()">üóëÔ∏è Clear Logs</button>
            <div id="results" class="results">üöÄ INSTANT Purchase History Fix Tool Ready

üéØ This tool will fix the issue where SOLD marketplace items don't appear in buyer's Purchase History

‚úÖ Choose Method 1 for automatic API fix
‚úÖ Choose Method 2 for guaranteed database fix

üí° The user email appears to be: itt21001@std.uwu.ac.lk</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9092';
        const USER_EMAIL = 'itt21001@std.uwu.ac.lk';
        const USER_ID = 'itt21001'; // Fallback user ID

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('results');
            const logEntry = `[${timestamp}] ${message}\\n`;
            resultDiv.innerHTML += logEntry;
            resultDiv.scrollTop = resultDiv.scrollHeight;
        }

        async function autoFixWithAPI() {
            log('üîß Starting automatic API fix...', 'info');
            log('üë§ Target user: ' + USER_EMAIL + ' (ID: ' + USER_ID + ')');
            
            try {
                // Method 1: Try the new endpoint if available
                log('üîç Trying new fix endpoint...');
                let response = await fetch(`${API_BASE}/api/bidding/fix/link-sold-items-to-buyer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        userEmail: USER_EMAIL
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ SUCCESS! New endpoint worked!', 'success');
                    log(`üéâ Linked ${result.data.linkedCount} SOLD items to purchase history`, 'success');
                    
                    if (result.data.linkedItems) {
                        result.data.linkedItems.forEach((item, index) => {
                            log(`   ${index + 1}. ${item}`, 'success');
                        });
                    }
                    
                    log('üîÑ Now test your purchase history!', 'warning');
                    return;
                }
                
                // Method 2: Try creating test purchase data
                log('üß™ Trying test data creation endpoint...');
                response = await fetch(`${API_BASE}/api/bidding/test/create-purchases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: USER_ID,
                        count: 5
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log('‚úÖ SUCCESS! Test data creation worked!', 'success');
                    log(`üéâ Created ${result.data.created} test purchases`, 'success');
                    log('üîÑ Now check your purchase history!', 'warning');
                    return;
                }
                
                throw new Error('All API methods failed');
                
            } catch (error) {
                log('‚ùå API fix failed: ' + error.message, 'error');
                log('üí° Use Method 2 (Database Fix) for guaranteed solution', 'warning');
                showDatabaseFix();
            }
        }

        function showDatabaseFix() {
            document.getElementById('database-fix').style.display = 'block';
            log('üíæ Database fix instructions displayed', 'info');
            log('üìã Copy the MongoDB commands and run them in MongoDB Compass or Shell', 'warning');
            document.getElementById('database-fix').scrollIntoView({behavior: 'smooth'});
        }

        async function testPurchaseHistory() {
            log('üìä Testing purchase history for user: ' + USER_ID, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/bidding/purchase-history/${USER_ID}`);
                
                if (response.ok) {
                    const purchases = await response.json();
                    log('‚úÖ Purchase history API working!', 'success');
                    
                    if (purchases.length > 0) {
                        log(`üéâ FOUND ${purchases.length} PURCHASES!`, 'success');
                        purchases.slice(0, 5).forEach((purchase, index) => {
                            log(`   ${index + 1}. ${purchase.gemName} - LKR ${purchase.finalPrice}`, 'success');
                        });
                        log('üíØ FIX SUCCESSFUL! Items now appear in purchase history!', 'success');
                    } else {
                        log('‚ö†Ô∏è Still no purchases found. Try running the database fix.', 'warning');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log('‚ùå Purchase history test failed: ' + error.message, 'error');
                log('üí° Make sure backend is running on port 9092', 'warning');
            }
        }

        async function checkBackendStatus() {
            log('üîç Checking backend status...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/health`);
                if (response.ok) {
                    log('‚úÖ Backend is running on port 9092', 'success');
                } else {
                    log('‚ö†Ô∏è Backend responded with status: ' + response.status, 'warning');
                }
            } catch (error) {
                log('‚ùå Backend not accessible: ' + error.message, 'error');
                log('üí° Make sure backend is started', 'warning');
            }
        }

        function openDashboard() {
            window.open('http://localhost:3000/dashboard', '_blank');
            log('üñ•Ô∏è Dashboard opened in new tab', 'info');
            log('üëÄ Go to Purchase History section to see your items', 'warning');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = 'üìã Results cleared\\n';
        }

        // Auto-check backend on load
        setTimeout(checkBackendStatus, 1000);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GemNet Purchase History Complete Test Suite</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .status-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }
        .status-online { background-color: #4CAF50; }
        .status-offline { background-color: #f44336; }
        .status-testing { background-color: #ff9800; }
        .button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover { background-color: #45a049; }
        .button-danger { background-color: #f44336; }
        .button-danger:hover { background-color: #da190b; }
        .button-warning { background-color: #ff9800; }
        .button-warning:hover { background-color: #e68900; }
        .test-results {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #2ecc71; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
        input, select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .feature-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-left: 4px solid #ddd;
            border-radius: 4px;
        }
        .feature-working { border-left-color: #28a745; background-color: #d4edda; }
        .feature-broken { border-left-color: #dc3545; background-color: #f8d7da; }
        .feature-testing { border-left-color: #ffc107; background-color: #fff3cd; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç GemNet Purchase History Complete Test Suite</h1>
        <p>This tool tests the purchase history functionality and countdown timer fixes</p>
        <div id="backend-status"></div>
    </div>

    <div class="grid">
        <div class="status-card">
            <h2>üåü Feature Status Overview</h2>
            <div id="feature-status-list">
                <div class="feature-status feature-testing">
                    <span>Backend Compilation Fixed</span>
                    <span class="status-indicator status-online"></span>
                </div>
                <div class="feature-status feature-testing">
                    <span>Purchase History API</span>
                    <span id="purchase-api-status" class="status-indicator status-testing"></span>
                </div>
                <div class="feature-status feature-testing">
                    <span>Countdown Timer Bug Fixed</span>
                    <span id="countdown-status" class="status-indicator status-testing"></span>
                </div>
                <div class="feature-status feature-testing">
                    <span>SOLD Badge Display</span>
                    <span id="sold-badge-status" class="status-indicator status-testing"></span>
                </div>
                <div class="feature-status feature-testing">
                    <span>Frontend Purchase History</span>
                    <span id="frontend-status" class="status-indicator status-testing"></span>
                </div>
            </div>
        </div>

        <div class="status-card">
            <h2>üöÄ Backend Status</h2>
            <div id="backend-connection-status">
                <p>Testing connection to backend...</p>
            </div>
            <button class="button" onclick="checkBackendStatus()">Check Backend Status</button>
            <button class="button button-warning" onclick="testPorts()">Test All Ports</button>
        </div>
    </div>

    <div class="grid">
        <div class="status-card">
            <h2>üß™ Test Data Management</h2>
            <div>
                <label>User ID for Test Purchases:</label>
                <input type="text" id="test-user-id" value="user123" placeholder="Enter user ID">
                
                <label>Number of Test Purchases:</label>
                <select id="test-count">
                    <option value="3">3 Test Purchases</option>
                    <option value="5">5 Test Purchases</option>
                    <option value="10">10 Test Purchases</option>
                </select>
            </div>
            
            <div style="margin-top: 15px;">
                <button class="button" onclick="createTestPurchases()">Create Test Purchase Data</button>
                <button class="button button-warning" onclick="resetTestData()">Reset All Test Data</button>
                <button class="button button-danger" onclick="clearPurchaseHistory()">Clear Purchase History</button>
            </div>
        </div>

        <div class="status-card">
            <h2>üìä Purchase History Testing</h2>
            <div>
                <label>Test User ID:</label>
                <input type="text" id="purchase-user-id" value="user123" placeholder="User ID to check">
            </div>
            
            <div style="margin-top: 15px;">
                <button class="button" onclick="testPurchaseHistory()">Test Purchase History API</button>
                <button class="button" onclick="testFrontendComponent()">Test Frontend Component</button>
                <button class="button" onclick="testMarketplaceBadges()">Test Marketplace SOLD Badges</button>
            </div>
        </div>
    </div>

    <div class="status-card">
        <h2>üîÑ Countdown Timer & Status Testing</h2>
        <div class="grid">
            <div>
                <button class="button" onclick="testCountdownTimers()">Test Countdown Timers</button>
                <button class="button" onclick="testStatusBadges()">Test Status Badges</button>
                <button class="button" onclick="simulateExpiredItems()">Simulate Expired Items</button>
            </div>
            <div>
                <button class="button button-warning" onclick="testMarketplaceIntegration()">Full Marketplace Test</button>
                <button class="button button-warning" onclick="testDashboardIntegration()">Full Dashboard Test</button>
            </div>
        </div>
    </div>

    <div class="status-card">
        <h2>üìù Test Results & Logs</h2>
        <button class="button" onclick="clearResults()">Clear Results</button>
        <button class="button button-warning" onclick="exportResults()">Export Results</button>
        <div id="test-results" class="test-results">
            <div class="info">üîç Purchase History Test Suite Ready</div>
            <div class="warning">‚ö†Ô∏è Click "Check Backend Status" to begin testing</div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9092';
        const FRONTEND_URL = 'http://localhost:5173';
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const resultDiv = document.getElementById('test-results');
            const logEntry = `<div class="${type}">[${timestamp}] ${message}</div>`;
            resultDiv.innerHTML += logEntry;
            resultDiv.scrollTop = resultDiv.scrollHeight;
            
            testResults.push({
                timestamp,
                message,
                type
            });
        }

        function updateFeatureStatus(feature, status) {
            const statusElement = document.getElementById(feature + '-status');
            if (statusElement) {
                statusElement.className = `status-indicator status-${status}`;
            }
        }

        async function checkBackendStatus() {
            log('üîç Checking backend status...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/health`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    log('‚úÖ Backend is running on port 9092', 'success');
                    updateFeatureStatus('purchase-api', 'online');
                    document.getElementById('backend-connection-status').innerHTML = 
                        '<p style="color: green;">‚úÖ Backend Connected on Port 9092</p>';
                    return true;
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Backend connection failed: ${error.message}`, 'error');
                updateFeatureStatus('purchase-api', 'offline');
                document.getElementById('backend-connection-status').innerHTML = 
                    '<p style="color: red;">‚ùå Backend Not Connected</p><p>Please start the backend server first</p>';
                return false;
            }
        }

        async function testPorts() {
            log('üîç Testing common backend ports...', 'info');
            const ports = [9091, 9092, 8080, 8081];
            
            for (const port of ports) {
                try {
                    const response = await fetch(`http://localhost:${port}/api/health`, {
                        method: 'GET',
                        timeout: 3000
                    });
                    if (response.ok) {
                        log(`‚úÖ Found backend running on port ${port}`, 'success');
                        return;
                    }
                } catch (error) {
                    log(`‚ùå Port ${port}: ${error.message}`, 'error');
                }
            }
            log('‚ùå No backend found on common ports', 'error');
        }

        async function createTestPurchases() {
            const userId = document.getElementById('test-user-id').value;
            const count = document.getElementById('test-count').value;
            
            if (!userId) {
                log('‚ùå Please enter a user ID', 'error');
                return;
            }

            log(`üß™ Creating ${count} test purchases for user: ${userId}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/bidding/test/create-purchases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, count: parseInt(count) })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Created ${result.created} test purchases`, 'success');
                    log(`üìä Test purchases: ${result.purchases.join(', ')}`, 'info');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Failed to create test purchases: ${error.message}`, 'error');
            }
        }

        async function testPurchaseHistory() {
            const userId = document.getElementById('purchase-user-id').value;
            
            if (!userId) {
                log('‚ùå Please enter a user ID', 'error');
                return;
            }

            log(`üîç Testing purchase history for user: ${userId}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/bidding/purchase-history/${userId}`);
                
                if (response.ok) {
                    const purchases = await response.json();
                    log(`‚úÖ Purchase history API working`, 'success');
                    log(`üìä Found ${purchases.length} purchases`, 'info');
                    
                    if (purchases.length > 0) {
                        purchases.slice(0, 3).forEach((purchase, index) => {
                            log(`   ${index + 1}. ${purchase.gemName} - LKR ${purchase.finalPrice}`, 'info');
                        });
                        updateFeatureStatus('purchase-api', 'online');
                    } else {
                        log('üìù No purchases found - create test data first', 'warning');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Purchase history test failed: ${error.message}`, 'error');
                updateFeatureStatus('purchase-api', 'offline');
            }
        }

        async function testFrontendComponent() {
            log('üñ•Ô∏è Testing frontend purchase history component...', 'info');
            
            try {
                // Try to open frontend in a new window for testing
                const frontendWindow = window.open(`${FRONTEND_URL}/dashboard`, '_blank');
                if (frontendWindow) {
                    log('‚úÖ Frontend opened - check the Purchases tab in dashboard', 'success');
                    log('üëÄ Verify that purchased items appear in the dashboard', 'info');
                    updateFeatureStatus('frontend', 'testing');
                } else {
                    log('‚ùå Could not open frontend - check if it\'s running on port 5173', 'error');
                }
            } catch (error) {
                log(`‚ùå Frontend test failed: ${error.message}`, 'error');
            }
        }

        async function testMarketplaceBadges() {
            log('üè™ Testing marketplace SOLD badges...', 'info');
            
            try {
                const frontendWindow = window.open(`${FRONTEND_URL}/marketplace`, '_blank');
                if (frontendWindow) {
                    log('‚úÖ Marketplace opened - check for SOLD badges on expired items', 'success');
                    log('üëÄ Verify countdown timers don\'t reset after page reload', 'info');
                    updateFeatureStatus('sold-badge', 'testing');
                    updateFeatureStatus('countdown', 'testing');
                } else {
                    log('‚ùå Could not open marketplace - check frontend status', 'error');
                }
            } catch (error) {
                log(`‚ùå Marketplace test failed: ${error.message}`, 'error');
            }
        }

        async function resetTestData() {
            const userId = document.getElementById('test-user-id').value;
            
            log(`üóëÔ∏è Resetting test data for user: ${userId}`, 'warning');
            
            try {
                const response = await fetch(`${API_BASE}/api/bidding/test/reset-purchases`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Reset completed: ${result.message}`, 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Reset failed: ${error.message}`, 'error');
            }
        }

        async function testCountdownTimers() {
            log('‚è∞ Testing countdown timer functionality...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/listings/active`);
                if (response.ok) {
                    const listings = await response.json();
                    log(`‚úÖ Found ${listings.length} active listings`, 'success');
                    
                    const expiredListings = listings.filter(listing => {
                        const endTime = new Date(listing.bidEndTime);
                        return endTime < new Date();
                    });
                    
                    log(`üìä Found ${expiredListings.length} expired listings`, 'info');
                    if (expiredListings.length > 0) {
                        log('üëÄ These should show SOLD badges in marketplace', 'warning');
                        updateFeatureStatus('countdown', 'online');
                    }
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Countdown test failed: ${error.message}`, 'error');
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = 
                '<div class="info">üìã Test results cleared</div>';
            testResults = [];
        }

        function exportResults() {
            const results = testResults.map(r => `[${r.timestamp}] ${r.type.toUpperCase()}: ${r.message}`).join('\\n');
            const blob = new Blob([results], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `purchase-history-test-${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            log('üì• Test results exported', 'success');
        }

        // Auto-check backend status on page load
        window.addEventListener('load', () => {
            setTimeout(checkBackendStatus, 1000);
        });

        // Additional test functions
        async function simulateExpiredItems() {
            log('‚è∞ Simulating expired countdown items...', 'info');
            // This would typically interact with the countdown timer component
            log('üëÄ Check marketplace for items with expired countdown timers', 'warning');
            log('‚úÖ These items should show "SOLD" badges instead of countdown', 'info');
        }

        async function testMarketplaceIntegration() {
            log('üîÑ Running full marketplace integration test...', 'info');
            await testCountdownTimers();
            await testMarketplaceBadges();
            log('üìä Marketplace integration test completed', 'success');
        }

        async function testDashboardIntegration() {
            log('üîÑ Running full dashboard integration test...', 'info');
            await testPurchaseHistory();
            await testFrontendComponent();
            log('üìä Dashboard integration test completed', 'success');
        }

        async function clearPurchaseHistory() {
            const userId = document.getElementById('test-user-id').value;
            if (confirm(`Clear all purchase history for user ${userId}?`)) {
                await resetTestData();
            }
        }

        async function testStatusBadges() {
            log('üè∑Ô∏è Testing status badge display logic...', 'info');
            log('üëÄ Check that expired items show SOLD instead of countdown', 'warning');
            log('‚úÖ Badge priority: SOLD > EXPIRED > Active countdown', 'info');
        }
    </script>
</body>
</html>
